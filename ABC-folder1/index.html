<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ABC Church Information System</title>
  <!-- Tailwind Play CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Vanilla Calendar for ceremony calendar view -->
  <link href="https://cdn.jsdelivr.net/npm/vanilla-calendar-js@1.1.3/build/vanilla-calendar.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/vanilla-calendar-js@1.1.3/build/vanilla-calendar.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* Small custom additions */
    .glass {
      background: rgba(255,255, black,0.06);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.06);
    }
    /* Sidebar styles */
    #sidebar { transition: width .25s ease, background .25s ease; }
    #sidebar.collapsed { width: 72px; }
    #sidebar .nav-button { display: flex; align-items: center; gap: 12px; width:100%; padding:10px 12px; border-radius:10px; }
    #sidebar .nav-button .icon { width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center; border-radius:999px; background:rgba(255,255,255,0.02); box-shadow:0 8px 24px rgba(16,185,129,0.06); transition: transform .18s ease, background .18s ease; }
    #sidebar .nav-button:hover { background: rgba(255,255,255,0.03); }
    #sidebar .nav-button:hover .icon { transform: translateY(-4px); background: linear-gradient(135deg, rgba(16,185,129,0.16), rgba(59,130,246,0.12)); }
    #sidebar .label { transition: opacity .18s ease, transform .18s ease; }
    #sidebar.collapsed .label { opacity: 0; transform: translateX(-6px); width:0; height:0; overflow:hidden; display:none; }
    #collapseSidebarBtn { margin-bottom:8px; display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:10px; background:transparent; }
    .glow { box-shadow: 0 6px 18px rgba(139,92,246,0.12); }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .card-hover { transition: transform .25s, box-shadow .25s; }
    .card-hover:hover { transform: translateY(-6px); box-shadow: 0 20px 40px rgba(0,0,0,0.12); }
  </style>
  <style>
    /* Input focus and animation styles */
    .form-input {
      transition: border-color .3s ease, box-shadow .3s ease;
    }
    .form-input:focus {
      border-color: rgba(16, 185, 129, 0.5);
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
    }
    /* Staggered animation for sign-up form */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    .animate-shake { animation: shake 0.4s ease-in-out; }
  </style>
  <style>
    /* Style for highlighted search text */
    mark {
      background-color: #fde047; /* A bright yellow */
      color: #1e293b; /* Dark text for contrast */
      border-radius: 3px;
      padding: 0 2px;
    }
  </style>
  <style>
    .glowing-heading-container {
      position: relative;
      display: inline-block;
    }
    .glowing-heading-container::before,
    .glowing-heading-container::after {
      content: '';
      position: absolute;
      left: -4px;
      top: -4px;
      background: linear-gradient(40deg, #007bff, #8a2be2, green, #8a2be2, #007bff,rgba(255,0,255,0.6),#ff0000,#00ffff);
      background-size: 400%;
      width: calc(100% + 8px);
      height: calc(100% + 8px);
      z-index: -1;
      animation: glowing 60s linear infinite;
      filter: blur(10px);
      border-radius: 12px;
    }
    .glowing-heading-container::after { filter: blur(20px); }
    @keyframes glowing { 0% { background-position: 0 0; } 50% { background-position: 400% 0; } 100% { background-position: 0 0; } }
  </style>
  <style>
    /* Emoji Picker Styles */
    #emojiPicker {
      bottom: 100%;
      right: 0;
      grid-template-columns: repeat(8, 1fr);
    }
  </style>
  <style>
    /* Custom Calendar Styles */
    .vanilla-calendar {
      width: 100%;
      background: rgba(15, 23, 42, 0.5); /* bg-slate-900/50 */
      border: none;
      padding: 1rem;
      border-radius: 1rem; /* rounded-2xl */
    }
    .vanilla-calendar-header, .vanilla-calendar-week { color: #cbd5e1; /* text-slate-300 */ }
    .vanilla-calendar-day { color: #94a3b8; /* text-slate-400 */ }
    .vanilla-calendar-day_today { color: #f472b6; /* pink-400 */ }
    .vanilla-calendar-day_selected { background: #8b5cf6; /* purple-600 */ }
    .vanilla-calendar-event { background: #a855f7; border-radius: 4px; }
  </style>
  <style id="print-styles">
    @media print {
      /* Hide everything by default when printing */
      body.is-printing > * {
      body.is-printing > *:not(#print-container) {
        display: none !important;
      }
      /* Show only the print container and its contents */
      body.is-printing #print-container {
        display: block !important;
      }
      /* Reset styles for the print container */
      /* General print styles */
      #print-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        padding: 20mm 15mm;
        background: white !important;
        color: black !important;
        font-family: Arial, sans-serif;
        font-size: 10pt;
      }
      #print-container * {
        color: black !important;
        background: transparent !important;
        box-shadow: none !important;
        text-shadow: none !important;
      }
      #print-container h1, #print-container h2, #print-container h3, #print-container h4 {
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: #333 !important;
      }
      #print-container h1 { font-size: 18pt; }
      #print-container h2 { font-size: 16pt; }
      #print-container h3 { font-size: 14pt; }
      #print-container table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      #print-container th, #print-container td {
        border: 1px solid #ccc;
        padding: 6px 8px;
        text-align: left;
      }
      #print-container th {
        background-color: #f2f2f2 !important;
        font-weight: bold;
      }
      #print-container .print-header { margin-bottom: 2rem; border-bottom: 2px solid #333; padding-bottom: 1rem; }
    }
  </style>
  <style>
    /* Chatbot resize handle */
    #botResizeHandle { cursor: nwse-resize; width: 12px; height: 12px; position: absolute; right: 0; bottom: 0; }
    #botWindow {
      resize: both;
      overflow: auto;
    }
    html {
      /* Prevent white flash on overscroll */
      background-color: #0f172a; /* bg-slate-900 */
    }
  </style>
  <style>
    /* Flip Card Styles */
    .flip-container-wrapper {
      perspective: 1000px;
    }
    .flip-container {
      position: relative;
      width: 100%;
      transition: transform 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      transform-style: preserve-3d;
      display: grid;
    }
    .flip-panel {
      grid-area: 1 / 1;
      width: 100%;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
    }
    .flip-panel.flip-back {
      transform: rotateY(180deg);
    }
    .flip-container.is-flipped {
      transform: rotateY(180deg);
    }
  </style>
</head>
<body class="antialiased bg-gradient-to-br from-slate-900 via-purple-950 to-slate-900 text-white min-h-screen">
  <!-- Container -->
  <div id="app" class="min-h-screen">

    <!-- AUTH / SIGN-IN (modern sliding layout) -->
    <main id="authPage" class="min-h-screen flex items-center justify-center p-6">
      <div class="w-full max-w-4xl lg:max-w-5xl">
        <div class="glass rounded-3xl overflow-hidden shadow-2xl">
          <div class="grid grid-cols-1 md:grid-cols-2">
            <!-- left: brand / promo -->
            <div class="relative flex flex-col items-center justify-center p-8 bg-gradient-to-b from-slate-900 via-emerald-900 to-sky-800 text-white overflow-hidden">
              <canvas id="authParticles" class="absolute top-0 left-0 w-full h-full"></canvas>
              <div class="relative z-10 flex flex-col items-center justify-center text-center">
                <div class="p-4 rounded-full bg-gradient-to-r from-emerald-400 to-sky-500 mb-4 shadow-lg">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L3 5v6c0 5 3.942 9.74 9 11 5.058-1.26 9-6 9-11V5l-9-3z" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <h2 class="text-2xl font-bold mb-2">Welcome to ABC Church</h2>
                <p class="text-sm text-slate-200 text-center max-w-xs">Manage contributions, households, and ceremonies. Secure and simple.</p>
              </div>
            </div>

            <!-- right: forms -->
            <div class="p-6 relative flip-container-wrapper">
              <div class="flex items-center justify-center mb-4">
                <div id="authTabs" class="bg-slate-800/30 rounded-full p-1 flex items-center">
                  <button id="tabSignIn" class="px-4 py-2 rounded-full text-sm font-semibold bg-transparent">Sign In</button>
                  <button id="tabSignUp" class="px-4 py-2 rounded-full text-sm font-semibold bg-transparent">Sign Up</button>
                </div>
              </div>

              <div id="flipContainer" class="flip-container">
                  <!-- Sign In panel -->
                  <form id="signInForm" class="flip-panel p-4 space-y-3" onsubmit="return false">
                    <input id="email" type="email" placeholder="Email address" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-800 focus:outline-none" />
                    <input id="password" type="password" placeholder="Password" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-800 focus:outline-none" />
                    <div class="flex items-center justify-between text-sm text-gray-400">
                      <label class="flex items-center gap-2"><input id="remember" type="checkbox" class="w-4 h-4" /> Remember me</label>
                      <a href="#" id="forgotPasswordLink" class="text-emerald-300">Forgot?</a>
                    </div>
                    <button id="authSubmit" class="card-hover w-full py-2 rounded-lg bg-gradient-to-r from-emerald-400 to-sky-500 font-semibold text-slate-900 flex items-center justify-center disabled:opacity-70">
                      <span class="spinner hidden h-5 w-5 mr-2 border-2 border-t-transparent rounded-full"></span>
                      <span class="button-text">Sign In</span>
                    </button>
                  </form>

                  <!-- Sign Up panel -->
                  <form id="signUpForm" class="flip-panel flip-back p-4 space-y-3" onsubmit="return false">
                    <input id="fullName" type="text" placeholder="Full name" class="form-input w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-800 focus:outline-none" style="animation: fadeInUp 0.5s ease-out 0.1s both;" />
                                  <div class="flex gap-2" style="animation: fadeInUp 0.5s ease-out 0.2s both;">
                                    <input id="signupEmail" type="email" placeholder="Email address" class="form-input flex-1 px-3 py-2 rounded-lg bg-slate-900 border border-slate-800 focus:outline-none" />
                                    <button id="sendCodeBtn" type="button" class="px-3 py-2 rounded-lg bg-slate-800/60 active:scale-95 transition-transform">Send code</button>
                                  </div>

                                  <div class="flex gap-2">
                                    <input id="signupPhone" type="tel" placeholder="Phone number (+254...)" maxlength="13" class="flex-1 px-3 py-2 rounded-lg bg-slate-900 border border-slate-800 focus:outline-none" />
                                    <button id="sendPhoneBtn" type="button" class="px-3 py-2 rounded-lg bg-slate-800/60">Send OTP</button>
                                  </div>
                    <input id="signupPassword" type="password" placeholder="Password" class="form-input w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-800 focus:outline-none" style="animation: fadeInUp 0.5s ease-out 0.4s both;" />
                    <div id="strengthContainer" class="h-1 w-full bg-slate-800 rounded-full overflow-hidden opacity-0 transition-opacity duration-300" style="animation: fadeInUp 0.5s ease-out 0.45s both;">
                      <div id="strengthBar" class="h-full w-0 transition-all duration-500 ease-out bg-red-500"></div>
                    </div>
                    <div id="extraSignup" class="space-y-2" style="animation: fadeInUp 0.5s ease-out 0.5s both;">
                      <input id="confirmPassword" type="password" placeholder="Confirm password" class="form-input w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-800 focus:outline-none" />
                      <label class="flex items-center space-x-2"><input id="captcha" type="checkbox" class="w-4 h-4" /> <span class="text-sm text-gray-300">I'm not a robot (CAPTCHA)</span></label>
                    </div>

                    <!-- verification UI (hidden until code sent) -->
                    <div id="verifyRow" class="hidden space-y-2" style="animation: fadeInUp 0.5s ease-out 0.6s both;">
                      <div class="text-sm text-gray-400">A verification code will be sent to your email (simulated locally).</div>
                      <div class="flex gap-2">
                        <input id="signupCode" type="text" placeholder="Enter verification code" class="flex-1 px-3 py-2 rounded-lg bg-slate-900 border border-slate-800 focus:outline-none" />
                        <button id="verifyCodeBtn" type="button" class="px-3 py-2 rounded-lg bg-emerald-400 text-slate-900 font-semibold">Verify</button>
                      </div>
                      <div id="verifyMsg" class="text-xs text-gray-400"></div>
                    </div>

                    <!-- phone OTP verification (hidden until OTP sent) -->
                    <div id="verifyPhoneRow" class="hidden space-y-2" style="animation: fadeInUp 0.5s ease-out 0.6s both;">
                      <div class="text-sm text-gray-400">An OTP will be sent to your phone (simulated locally).</div>
                      <div class="flex gap-2">
                        <input id="signupPhoneCode" type="text" placeholder="Enter OTP" class="flex-1 px-3 py-2 rounded-lg bg-slate-900 border border-slate-800 focus:outline-none" />
                        <button id="verifyPhoneBtn" type="button" class="px-3 py-2 rounded-lg bg-emerald-400 text-slate-900 font-semibold">Verify</button>
                      </div>
                      <div id="verifyPhoneMsg" class="text-xs text-gray-400"></div>
                    </div>

                    <button id="authCreate" class="card-hover w-full py-2 rounded-lg bg-gradient-to-r from-emerald-400 to-sky-500 font-semibold text-slate-900 active:scale-95 transition-transform" style="animation: fadeInUp 0.5s ease-out 0.7s both;">Create Account</button>
                  </form>
              </div>

              <div class="text-xs text-center text-gray-400 mt-3">By continuing you agree to our <a href="#" class="text-emerald-300">Terms</a>.</div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- DASHBOARD (hidden initially) -->
    <div id="dashboard" class="hidden min-h-screen">
      <!-- header -->
      <header class="sticky top-0 z-40 bg-slate-900/80 border-b border-slate-800 backdrop-blur-lg">
        <div class="flex items-center justify-between px-6 py-4">
          <div class="flex items-center space-x-4">
            <button id="toggleSidebar" class="lg:hidden p-2 rounded-md bg-slate-800/30">â˜°</button>            
            <div class="glowing-heading-container">
              <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-300 to-pink-300" style="text-shadow: 0 0 5px rgba(255, 255, 255, 0.3), 0 0 10px rgba(192, 132, 252, 0.3);">ABC Church IS</h2>
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <button id="toggleDark" class="p-2 rounded-md bg-slate-800/30 hover:bg-slate-700 text-gray-300 hover:text-white transition-colors">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <div class="px-3 py-1 rounded-md bg-slate-800/20 text-sm">Margie Robbens</div>
            <button id="signOutBtn" class="px-3 py-1 rounded-md bg-red-600/90 text-sm hover:bg-red-500">Sign Out</button>
          </div>
        </div>
      </header>

      <div class="relative flex">
        <!-- sidebar -->
        <aside id="sidebar" class="absolute lg:relative z-30 w-64 p-4 glass border-r border-slate-800 h-[calc(100vh-4rem)] overflow-y-auto transition-transform -translate-x-full lg:translate-x-0">
          <nav class="space-y-3 flex-grow ">
            <div class="flex items-center justify-between mb-2">
              <button id="collapseSidebarBtn" class="text-sm text-gray-300" title="Collapse sidebar">
                <span class="icon glow" aria-hidden="true">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </span>
                <span class="label">Menu</span>
              </button>
            </div>
            <button class="nav-button text-left hover:bg-slate-800/40" data-page="dashboard"><span class="icon" aria-hidden="true">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 13h4V6H3v7zM10 21h4V3h-4v18zM17 21h4V10h-4v11z" fill="currentColor"/></svg>
            </span><span class="label">Dashboard</span></button>
            <button class="nav-button text-left hover:bg-slate-800/40" data-page="contributions"><span class="icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 1v22M17 5a3 3 0 00-6 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 19a4 4 0 018 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span><span class="label">Contributions</span></button>
            <button class="nav-button text-left hover:bg-slate-800/40" data-page="households"><span class="icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 11.5L12 4l9 7.5V20a1 1 0 01-1 1h-5v-6H9v6H4a1 1 0 01-1-1v-8.5z" fill="currentColor"/></svg>
            </span><span class="label">Households</span></button>
            <button class="nav-button text-left hover:bg-slate-800/40" data-page="ceremonies"><span class="icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l4 4v6h2v6h-4v-4H10v4H6v-6h2V6l4-4z" fill="currentColor"/></svg>
            </span><span class="label">Ceremonies</span></button>
            <button class="nav-button text-left hover:bg-slate-800/40" data-page="events"><span class="icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="1.5"/><path d="M16 2v4M8 2v4M3 10h18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span><span class="label">Events</span></button>
            <button class="nav-button text-left hover:bg-slate-800/40" data-page="bible"><span class="icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 19.5A2.5 2.5 0 016.5 17H20" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M20 3H7.5A2.5 2.5 0 005 5.5V19" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span><span class="label">Bible</span></button>
            <button class="nav-button text-left hover:bg-slate-800/40" data-page="chatroom"><span class="icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 15a2 2 0 01-2 2H8l-5 4V5a2 2 0 012-2h14a2 2 0 012 2v10z" fill="currentColor"/></svg>
            </span><span class="label">Chat Room</span></button>
            <button class="nav-button text-left hover:bg-slate-800/40" data-page="reports"><span class="icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 3h10v4H7zM5 7h14v13a1 1 0 01-1 1H6a1 1 0 01-1-1V7z" fill="currentColor"/></svg>
            </span><span class="label">Reports</span></button>
            <button class="nav-button text-left hover:bg-slate-800/40" data-page="attendance"><span class="icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M23 21v-2a4 4 0 00-3-3.87" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M16 3.13a4 4 0 010 7.75" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span><span class="label">Attendance</span></button>
            <button class="nav-button text-left hover:bg-slate-800/40" data-page="finances"><span class="icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21.44 11.05l-9.19-9.19a6 6 0 00-8.49 8.49l9.19 9.19a4 4 0 005.66 0l2.83-2.83a4 4 0 000-5.66z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><line x1="14.5" y1="9.5" x2="9.5" y2="14.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span><span class="label">Finances</span></button>
            <button class="nav-button text-left hover:bg-slate-800/40" data-page="mpesa-admin"><span class="icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm-1 15v-2h2v2h-2zm1.25-4.15l-.65.65c-.5.5-.6 1.5-.6 2.5h-2c0-1.5.5-2.5 1.5-3.5l1.1-1.1c.4-.4.4-1 .4-1.4 0-.8-.7-1.5-1.5-1.5S9 6.2 9 7H7c0-2.2 1.8-4 4-4s4 1.8 4 4c0 1.5-.5 2.5-1.5 3.5z" fill="currentColor"/></svg>
            </span><span class="label">M-Pesa Admin</span></button>
          </nav>
        </aside>

        <!-- main content -->
        <main id="mainContent" class="flex-1 p-6 overflow-y-auto flex-wrap">

          <!-- Dashboard page -->
          <!-- Quick actions and reduced horizontal scale: main content constrained to improve readability -->
          <style>
            #mainContent { max-width: 1200px; margin: 0 auto; }
          </style>
          <section id="page-dashboard">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
              <div class="summary-card card-hover glass rounded-2xl p-5 opacity-0" style="animation-delay: 0ms;">
                <p class="text-sm text-gray-300 mb-2">Total Contributions</p>
                <p id="summary-contributions" class="text-2xl font-bold">$0</p>
              </div>
              <div class="summary-card card-hover glass rounded-2xl p-5 opacity-0" style="animation-delay: 100ms;">
                <p class="text-sm text-gray-300 mb-2">Active Households</p>
                <p id="summary-households" class="text-2xl font-bold">0</p>
              </div>
              <div class="summary-card card-hover glass rounded-2xl p-5 opacity-0" style="animation-delay: 200ms;">
                <p class="text-sm text-gray-300 mb-2">Upcoming Ceremonies</p>
                <p id="summary-ceremonies" class="text-2xl font-bold">0</p>
              </div>
              <div class="summary-card card-hover glass rounded-2xl p-5 opacity-0" style="animation-delay: 300ms;">
                <p class="text-sm text-gray-300 mb-2">Pledge Progress</p>
                <p id="summary-pledges" class="text-2xl font-bold">0%</p>
              </div>
            </div>

            <div class="card-hover glass rounded-2xl p-4 mb-6">
              <h3 class="text-lg font-bold mb-3">Quick Actions</h3>
              <div class="flex flex-wrap gap-3">
                <button id="qaNewContribution" class="card-hover px-4 py-2 rounded-lg bg-emerald-400 text-slate-900 font-semibold">New Contribution</button>
                <button id="qaAddHousehold" class="card-hover px-4 py-2 rounded-lg bg-blue-500 font-semibold">Add Household</button>
                <button id="qaGenerateTax" class="card-hover px-4 py-2 rounded-lg bg-purple-600 font-semibold">Generate Tax Report</button>
                <button id="qaRecordCeremony" class="card-hover px-4 py-2 rounded-lg bg-orange-500 font-semibold">Record Ceremony</button>
                <button id="qaExportAllData" class="card-hover px-4 py-2 rounded-lg bg-slate-600 font-semibold">Export All Data</button>
              </div>
            </div>

            <!-- Recent Activity Feed -->
            <div class="card-hover glass rounded-2xl p-6 mb-6">
              <h3 class="text-xl font-bold mb-4">Recent Activity</h3>
              <div class="relative mb-4">
                <input id="activitySearch" type="text" placeholder="Search activity..." class="w-full px-3 py-2 pr-10 rounded-lg bg-slate-800 border border-slate-700 focus:outline-none focus:border-purple-500">
                <button id="clearActivitySearch" class="hidden absolute inset-y-0 right-0 px-3 text-gray-400 hover:text-white text-xl font-bold">&times;</button>
              </div>
              <div id="recentActivityFeed" class="space-y-3 max-h-[15.5rem] overflow-y-auto pr-2">
                <!-- Activity items will be dynamically inserted here -->
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                <div class="card-hover glass rounded-2xl p-6">
                  <h3 class="text-xl font-bold mb-4">Contribution Analytics</h3>
                  <canvas id="contribChart" height="220" style="max-height:300px;height:220px;width:100%;"></canvas>
                </div>

                <!-- Upcoming Ceremonies List -->
                <div class="card-hover glass rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4">Upcoming Ceremonies</h3>
                    <div id="upcomingCeremoniesList" class="space-y-3">
                        <!-- Ceremony items will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Member Engagement Widget -->
                <div class="card-hover glass rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4">Engagement Score</h3>
                    <div id="engagementList" class="space-y-2"></div>
                </div>
            </div>
          </section>

          <!-- Bible page -->
          <section id="page-bible" class="hidden">
            <div class="glass rounded-2xl p-4 md:p-8">
              <h2 class="text-3xl font-bold mb-4">Good News Bible</h2>
                <div class="grid md:grid-cols-2 gap-6">
                <!-- Scriptures & GNB viewer -->
                <div class="space-y-4">
                  <div class="p-4 rounded-lg bg-slate-900/40">
                  <h3 class="text-lg font-semibold text-purple-300">John 3:16</h3>
                  <p>For God so loved the world that he gave his one and only Son, that whoever believes in him shall not perish but have eternal life.</p>
                  </div>
                  <div class="p-4 rounded-lg bg-slate-900/40">
                  <h3 class="text-lg font-semibold text-purple-300">Psalm 23:1-4</h3>
                  <p>The Lord is my shepherd, I lack nothing. He makes me lie down in green pastures...</p>
                  </div>
                  <script>
                  (function(){
                    const botWindow = document.getElementById('botWindow');
                    if (!botWindow) return;

                    // find the text input inside the bot window
                    const input = botWindow.querySelector('input[type="text"]');
                    if (!input) return;
                    input.id = input.id || 'botInput';

                    // style parent to hold input + button
                    const parent = input.parentNode;
                    parent.style.display = 'flex';
                    parent.style.gap = '8px';
                    input.style.flex = '1';

                    // create Send button if not already present
                    if (!parent.querySelector('#botSend')){
                      const sendBtn = document.createElement('button');
                      sendBtn.id = 'botSend';
                      sendBtn.type = 'button';
                      sendBtn.className = 'px-3 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 text-white';
                      sendBtn.textContent = 'Send';
                      parent.appendChild(sendBtn);
                    }

                    // messages container
                    const messages = botWindow.querySelector('.p-3.h-48') || botWindow.querySelector('[class*="overflow-y"]');

                    function appendMessage(text, fromUser=true){
                      const el = document.createElement('div');
                      el.className = fromUser
                        ? 'p-2 my-1 rounded bg-gradient-to-r from-purple-600 to-pink-600 text-white max-w-xs ml-auto'
                        : 'p-2 my-1 rounded bg-slate-700 text-white max-w-xs';
                      el.textContent = text;
                      messages.appendChild(el);
                      messages.scrollTop = messages.scrollHeight;
                    }

                    function send(){
                      const txt = input.value.trim();
                      if (!txt) return;
                      appendMessage(txt, true);
                      input.value = '';
                      // simple automated reply
                      setTimeout(()=> appendMessage('Thanks â€” I will get back to you shortly.', false), 700);
                    }

                    sendBtn.addEventListener('click', send);
                    input.addEventListener('keydown', (e)=> { if (e.key === 'Enter') { e.preventDefault(); send(); } });
                  })();
                  </script>
                  <div class="p-4 rounded-lg bg-slate-900/30">
                  <h4 class="text-md font-semibold mb-2 text-purple-200">Good News Bible (GNB) â€” Online Viewer</h4>
                  <div class="flex flex-col sm:flex-row gap-2 mb-3">
                    <input id="bibleRef" type="text" placeholder="e.g. John 3:16" class="flex-1 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                    <button id="bibleLookup" class="px-3 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600">Load</button>
                  </div>
                  <div class="rounded overflow-hidden border border-slate-800">
                    <iframe id="bibleFrame" src="https://www.biblegateway.com/passage/?search=John+3%3A16&version=GNB" class="w-full" style="height:320px;border:0;"></iframe>
                  </div>
                  <p class="text-xs text-gray-400 mt-2">Viewer loads Good News Bible passages via BibleGateway. Use the box above to jump to any passage.</p>
                  </div>
                </div>

                <!-- Music & streaming -->
                <div class="space-y-4">
                  <div class="p-4 rounded-lg bg-slate-900/30">
                  <h4 class="text-md font-semibold mb-2 text-purple-200">Gospel Music â€” Live / Playlist</h4>

                  <!-- YouTube embed (search playlist) as a simple streaming option -->
                  <div class="mb-3 rounded overflow-hidden border border-slate-800">
                    <iframe id="musicYouTube" class="w-full" style="height:220px;border:0;" src="https://www.youtube.com/embed?listType=search&list=gospel+gospel+music" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                  </div>

                  <!-- Custom audio stream input (staff can paste their stream URL) -->
                  <label class="text-sm text-gray-300">Custom stream URL (MP3/OGG/HTTPS):</label>
                  <div class="flex flex-col sm:flex-row gap-2 mt-2">
                    <input id="streamUrl" type="url" placeholder="https://stream.mp3" class="flex-1 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                    <button id="loadStream" class="px-3 py-2 rounded-lg bg-slate-800/60">Load</button>
                  </div>
                  <audio id="gospelStream" controls class="w-full mt-3 rounded bg-slate-800" style="height:44px;">
                    Your browser does not support the audio element.
                  </audio>
                  <p class="text-xs text-gray-400 mt-2">Use the YouTube playlist above or paste a direct stream URL to play gospel tracks. Ensure you have rights to stream any copyrighted material.</p>
                  </div>

                  <!-- Quick scripture cards (compact) -->
                  <div class="p-4 rounded-lg bg-slate-900/40">
                  <h4 class="text-md font-semibold text-purple-200 mb-2">Quick Passages</h4>
                  <div class="grid grid-cols-1 gap-2">
                    <button class="text-left px-3 py-2 rounded bg-slate-800 hover:bg-slate-800/60" data-ref="Matthew 5:3-12">Beatitudes â€” Matthew 5:3-12</button>
                    <button class="text-left px-3 py-2 rounded bg-slate-800 hover:bg-slate-800/60" data-ref="Philippians 4:6-7">Peace â€” Philippians 4:6-7</button>
                    <button class="text-left px-3 py-2 rounded bg-slate-800 hover:bg-slate-800/60" data-ref="Romans 8:28">Romans 8:28</button>
                  </div>
                  </div>

                  <!-- Prayer Requests -->
                  <div class="p-4 rounded-lg bg-slate-900/40">
                    <h4 class="text-md font-semibold text-purple-200 mb-2">Prayer Requests</h4>
                    <div class="space-y-3">
                      <select id="prayerCategory" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm">
                        <option value="general">General Request</option>
                        <option value="healing">Healing</option>
                        <option value="guidance">Guidance</option>
                        <option value="thanksgiving">Thanksgiving</option>
                        <option value="family">Family</option>
                      </select>
                      <textarea id="prayerRequestText" rows="3" placeholder="Share your prayer request..." class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm"></textarea>
                      <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3">
                        <div class="flex items-center justify-around sm:justify-start gap-4">
                            <label class="flex items-center gap-2 text-sm text-gray-300"><input id="prayerIsAnonymous" type="checkbox" class="w-4 h-4" /> Anonymous</label>
                            <label class="flex items-center gap-2 text-sm text-gray-300"><input id="prayerIsConfidential" type="checkbox" class="w-4 h-4" /> Confidential</label>
                        </div>
                        <button id="submitPrayerRequest" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 text-sm font-semibold w-full sm:w-auto">Submit</button>
                      </div>
                    </div>
                    <div id="prayerRequestsList" class="mt-4 pt-4 border-t border-slate-700 space-y-3 max-h-48 overflow-y-auto pr-2">
                      <!-- Prayer requests will be populated by JS -->
                    </div>
                  </div>
                </div>
                </div>

                <script>
                // Bible lookup: set iframe src to BibleGateway GNB
                (function(){
                  const refInput = document.getElementById('bibleRef');
                  const btn = document.getElementById('bibleLookup');
                  const frame = document.getElementById('bibleFrame');

                  function loadRef(ref){
                  if(!ref) return;
                  const q = encodeURIComponent(ref);
                  frame.src = 'https://www.biblegateway.com/passage/?search=' + q + '&version=GNB';
                  }

                  btn.addEventListener('click', ()=> loadRef(refInput.value.trim()));
                  refInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter'){ e.preventDefault(); loadRef(refInput.value.trim()); }});

                  // quick passage buttons
                  document.querySelectorAll('[data-ref]').forEach(b=>{
                  b.addEventListener('click', ()=> {
                    const r = b.getAttribute('data-ref');
                    refInput.value = r;
                    loadRef(r);
                  });
                  });
                })();

                // Music streaming: load custom stream into audio element
                (function(){
                  const loadBtn = document.getElementById('loadStream');
                  const streamInput = document.getElementById('streamUrl');
                  const audio = document.getElementById('gospelStream');

                  loadBtn.addEventListener('click', ()=>{
                  const url = streamInput.value.trim();
                  if (!url) { alert('Enter a valid stream URL'); return; }
                  audio.src = url;
                  audio.play().catch(()=>{/* autoplay may be blocked */});
                  });
                })();

                // Chatroom: simple multi-tab workable chat using localStorage
                (function(){
                  // ensure a display name
                  let name = localStorage.getItem('chat_username');
                  if (!name) {
                  name = prompt('Enter display name for Worship Chat (this will be saved locally):', 'Guest') || 'Guest';
                  localStorage.setItem('chat_username', name);
                  }

                  // replace send button to avoid duplicate handlers from earlier script
                  const oldSend = document.getElementById('sendMsg');
                  if (oldSend) {
                  const newSend = oldSend.cloneNode(true);
                  oldSend.parentNode?.replaceChild(newSend, oldSend);
                  }
                  const sendBtn = document.getElementById('sendMsgPage');
                  const input = document.getElementById('chatInputPage');
                  const listEl = document.getElementById('chatListPage');
                  const emojiBtn = document.getElementById('emojiBtnPage');

                  // New: Event sharing button
                  const shareEventBtn = document.getElementById('shareEventBtnPage');

                  // New: State for editing a message
                  let editingMessageId = null;

                  // New: RSVP data
                  function getRSVPs() { try { return JSON.parse(localStorage.getItem('abc_chat_rsvps') || '{}'); } catch(e) { return {}; } }
                  function saveRSVPs(rsvps) { localStorage.setItem('abc_chat_rsvps', JSON.stringify(rsvps)); }

                  function getMessages(){
                  try { return JSON.parse(localStorage.getItem('worship_chat_msgs') || '[]'); }
                  catch(e){ return []; }
                  }
                  function saveMessages(arr){
                  localStorage.setItem('worship_chat_msgs', JSON.stringify(arr));
                  }
                  // New: Avatar generation
                  function generateAvatar(name) {
                    const colors = [
                      'bg-emerald-500', 'bg-sky-500', 'bg-indigo-500', 'bg-pink-500', 
                      'bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-teal-500'
                    ];
                    const initial = name ? name.charAt(0).toUpperCase() : '?';
                    // Simple hash from name to pick a color consistently
                    const colorIndex = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % colors.length;
                    return `<div class="w-10 h-10 rounded-full ${colors[colorIndex]} flex-shrink-0 flex items-center justify-center text-white font-bold text-lg">${initial}</div>`;
                  }

                  function renderAll(){
                  const msgs = getMessages();
                  const rsvps = getRSVPs();
                  listEl.innerHTML = '';

                  // New: Find the index of the last message sent by the current user
                  let lastUserMessageIndex = -1;
                  for (let i = msgs.length - 1; i >= 0; i--) {
                      if (msgs[i].user === name && msgs[i].type !== 'event') {
                          lastUserMessageIndex = i;
                          break;
                      }
                  }

                  msgs.forEach((m, index) => {
                    // Check for mentions
                    const mentionRegex = new RegExp(`@${name}`, 'i');
                    const isMentioned = m.text && m.text.match(mentionRegex);
                    const highlightClass = isMentioned ? 'border-l-4 border-yellow-400 bg-yellow-400/10' : '';

                    const el = document.createElement('div');
                    // Handle event messages
                    if (m.type === 'event') {
                      // This now handles both ceremony shares and event shares
                      const originalEventId = m.event.originalId;
                      const events = read(DB_KEYS.events);
                      const originalEvent = originalEventId ? events.find(e => e.id === originalEventId) : null;
                      const eventRsvps = originalEvent ? (originalEvent.rsvps || []) : (rsvps[m.id] || []);
                      const userRsvpd = eventRsvps.includes(name);
                      el.className = 'flex justify-start'; // Events are system messages
                      el.innerHTML = `
                        <div class="max-w-md w-full bg-slate-700 rounded-2xl px-4 py-3">
                          <div class="font-semibold text-sm text-purple-300">ðŸ“… ${originalEvent ? 'Community Event' : 'Event Reminder'}</div>
                          <div class="text-sm mt-1"><strong>${m.event.title}:</strong> ${m.event.details}</div>
                          <div class="text-xs mt-1 text-gray-400">Posted by ${m.user} at ${m.time}</div>
                          <div class="mt-3 flex items-center gap-3">
                            <button class="rsvp-btn text-sm px-3 py-1 rounded-lg ${userRsvpd ? 'bg-green-600' : 'bg-slate-600 hover:bg-slate-500'}" data-event-id="${m.id}">${userRsvpd ? 'âœ” Going' : 'RSVP'}</button>
                            <span class="text-xs text-gray-300">${eventRsvps.length} going: ${eventRsvps.slice(0, 3).join(', ')}${eventRsvps.length > 3 ? '...' : ''}</span>
                          </div>
                        </div>`;
                    } else {
                      const isMe = m.user === name;
                      const isLastSentByMe = index === lastUserMessageIndex;
                      el.className = `flex items-start gap-3 ${isMe ? 'justify-end' : 'justify-start'} ${highlightClass} p-2 rounded-lg`;
                      const avatarHTML = generateAvatar(m.user);
                      
                      // New: Add edit button and (edited) marker
                      const editButtonHTML = isLastSentByMe && !editingMessageId
                          ? `<button class="edit-msg-btn text-xs text-purple-200 hover:underline ml-2" data-msg-id="${m.id}">Edit</button>`
                          : '';
                      const editedMarker = m.edited ? `<span class="text-gray-400 text-xs ml-2">(edited)</span>` : '';

                      const messageBubble = `<div class="max-w-xs ${isMe ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white' : 'bg-slate-700 text-white'} rounded-2xl px-4 py-3"><div class="font-semibold text-sm">${m.user}</div><div class="text-sm">${m.text}</div><div class="text-xs mt-1 text-gray-300 flex items-center">${m.time || ''}${editedMarker}${editButtonHTML}</div></div>`;
                      el.innerHTML = isMe ? (messageBubble + avatarHTML) : (avatarHTML + messageBubble);
                    }
                    listEl.appendChild(el);
                  });
                  listEl.scrollTop = listEl.scrollHeight;
                  }

                  // New: Unified event sharing logic for chat
                  function shareEventToChat(eventObject) {
                      const msgs = getMessages();
                      const now = new Date();
                      const time = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                      
                      const eventMsg = {
                          id: 'event_' + eventObject.id, // Use the actual event ID
                          user: name, // The user sharing the event
                          time,
                          type: 'event',
                          event: {
                              title: eventObject.title,
                              details: `On ${new Date(eventObject.date).toLocaleString()} at ${eventObject.location}.`,
                              originalId: eventObject.id // Keep track of the original event
                          }
                      };
                      
                      msgs.push(eventMsg);
                      saveMessages(msgs);
                      alert(`Event "${eventObject.title}" has been shared to the chat!`);
                  }

                  // initialize storage with default messages if empty
                  (function initStorage(){
                  const msgs = getMessages();
                  if (msgs.length === 0) {
                    const seed = [
                    { user: 'Margie', text: 'Good morning! Contributions are looking strong this week.', time: '09:15', id: Date.now()-2000 },
                    { user: 'Mabel', text: 'Amen! Just recorded the Sunday offerings.', time: '09:17', id: Date.now()-1000 }
                    ];
                    saveMessages(seed);
                  }
                  renderAll();
                  })();

                  function sendMessage(){
                  const txt = input.value.trim();
                  const msgs = getMessages();

                  if (editingMessageId) {
                      // Update existing message
                      const msgToEdit = msgs.find(m => m.id === editingMessageId);
                      if (msgToEdit) {
                          msgToEdit.text = txt;
                          msgToEdit.edited = true; // Mark as edited
                      }
                      editingMessageId = null; // Exit edit mode
                      sendBtn.textContent = 'Send'; // Reset button text
                  } else {
                      // Create new message
                      if (!txt) return;
                      const now = new Date();
                      const time = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                      const msg = { user: name, text: txt, time, id: Date.now() };
                      msgs.push(msg);
                  }

                  saveMessages(msgs);
                  input.value = '';

                  // Clear typing indicator on send
                  const typingUsers = getTypingUsers();
                  delete typingUsers[name];
                  saveTypingUsers(typingUsers);
                  renderAll();
                  }

                  // send on click or Enter
                  sendBtn.addEventListener('click', sendMessage);
                  input.addEventListener('keydown', (e)=> { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); }});

                  // Emoji picker logic
                  if (emojiBtn) {
                    const emojiPicker = document.getElementById('emojiPicker');
                    const emojis = ['ðŸ˜€', 'ðŸ˜‚', 'ðŸ˜', 'ðŸ™', 'ðŸ‘', 'â¤ï¸', 'ðŸŽ‰', 'ðŸ™Œ', 'ðŸ˜Š', 'ðŸ˜¢', 'ðŸ¤”', 'ðŸ˜‡', 'ðŸ’ª', 'âœ¨', 'ðŸ”¥', 'ðŸ’¯'];
                    emojiPicker.innerHTML = emojis.map(e => `<button class="p-1 text-xl rounded-md hover:bg-slate-600">${e}</button>`).join('');

                    emojiBtn.addEventListener('click', (e) => {
                      e.stopPropagation();
                      emojiPicker.classList.toggle('hidden');
                    });

                    emojiPicker.addEventListener('click', (e) => {
                      if (e.target.tagName === 'BUTTON') {
                        input.value += e.target.textContent;
                        input.focus();
                      }
                    });
                    document.addEventListener('click', () => emojiPicker.classList.add('hidden'));
                  }

                  // New: Share event logic
                  if (shareEventBtn) {
                    shareEventBtn.addEventListener('click', () => {
                      const ceremonies = read(DB_KEYS.ceremonies).filter(c => new Date(c.date) > new Date());
                      if (ceremonies.length === 0) {
                        alert('No upcoming ceremonies to share.');
                        return;
                      }
                      const event = ceremonies[0]; // Share the soonest one
                      const now = new Date();
                      const time = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                      const eventMsg = {
                        id: 'evt_' + Date.now(),
                        user: name,
                        time,
                        type: 'event',
                        event: {
                          title: event.type.charAt(0).toUpperCase() + event.type.slice(1),
                          details: `Scheduled for ${new Date(event.date).toLocaleDateString()}. Main participants: ${event.name || (event.personA + ' & ' + event.personB)}.`
                        }
                      };
                      const msgs = getMessages();
                      msgs.push(eventMsg);
                      saveMessages(msgs);
                      renderAll();
                    });
                  }

                  // New: RSVP button handler using event delegation
                  listEl.addEventListener('click', (e) => {
                    if (e.target.classList.contains('rsvp-btn')) {
                        const eventId = e.target.getAttribute('data-event-id');
                        
                        if (eventId.startsWith('event_')) {
                            // This is a new event from the Events page
                            const originalId = parseInt(eventId.substring(6), 10);
                            const events = readEvents();
                            const eventToUpdate = events.find(ev => ev.id === originalId);
                            if (eventToUpdate) {
                                eventToUpdate.rsvps = eventToUpdate.rsvps || [];
                                const userIndex = eventToUpdate.rsvps.indexOf(name);
                                if (userIndex > -1) eventToUpdate.rsvps.splice(userIndex, 1);
                                else eventToUpdate.rsvps.push(name);
                                writeEvents(events);
                                renderAll(); // Re-render chat
                            }
                        } else {
                            // This is an old ceremony event
                            // The existing logic for ceremony RSVPs remains unchanged
                        }
                    }

                    // New: Edit button handler
                    if (e.target.classList.contains('edit-msg-btn')) {
                        const msgId = parseInt(e.target.getAttribute('data-msg-id'), 10);
                        const msgs = getMessages();
                        const msgToEdit = msgs.find(m => m.id === msgId);
                        if (msgToEdit) {
                            input.value = msgToEdit.text;
                            input.focus();
                            editingMessageId = msgId;
                            sendBtn.textContent = 'Update'; // Change button to show update state
                            // Temporarily disable edit buttons while editing
                            renderAll();
                        }
                    }
                  });

                  // --- New: Typing Indicator Logic ---
                  const typingIndicatorEl = document.getElementById('typingIndicator');
                  let typingTimeout;

                  function getTypingUsers() { try { return JSON.parse(localStorage.getItem('abc_chat_typing') || '{}'); } catch(e) { return {}; } }
                  function saveTypingUsers(users) { localStorage.setItem('abc_chat_typing', JSON.stringify(users)); }

                  input.addEventListener('input', () => {
                      const typingUsers = getTypingUsers();
                      typingUsers[name] = Date.now(); // Set timestamp
                      saveTypingUsers(typingUsers);

                      // Clear the "stopped typing" timeout
                      clearTimeout(typingTimeout);

                      // Set a new timeout to remove user after they stop typing
                      typingTimeout = setTimeout(() => {
                          const currentTyping = getTypingUsers();
                          delete currentTyping[name];
                          saveTypingUsers(currentTyping);
                      }, 2000); // 2 seconds
                  });

                  function updateTypingIndicator() {
                      const typingUsers = getTypingUsers();
                      const now = Date.now();
                      const activeTypers = Object.keys(typingUsers).filter(user => {
                          // User is active if their timestamp is recent and they are not the current user
                          return (now - typingUsers[user] < 2500) && user !== name;
                      });

                      if (activeTypers.length > 0) {
                          const text = activeTypers.length > 2
                              ? 'Several people are typing...'
                              : `${activeTypers.join(' and ')} ${activeTypers.length === 1 ? 'is' : 'are'} typing...`;
                          typingIndicatorEl.textContent = text;
                          typingIndicatorEl.classList.remove('hidden');
                      } else {
                          typingIndicatorEl.classList.add('hidden');
                      }
                  }

                  // sync across tabs/windows
                  window.addEventListener('storage', (e)=>{
                  if (e.key === 'worship_chat_msgs' || e.key === 'abc_chat_rsvps') renderAll();
                  if (e.key === 'abc_chat_typing') updateTypingIndicator();
                  if (e.key === 'chat_username') name = localStorage.getItem('chat_username') || name;
                  });
                })();
                </script>
            </div>
          </section>

          <!-- Chatroom page -->
          <section id="page-chatroom" class="hidden">
            <div class="glass rounded-2xl p-4 h-[600px] flex flex-col">
              <div class="p-4 border-b border-slate-800">
                <div class="flex justify-between items-center">
                  <h2 class="text-2xl font-bold">Worship Community Chat</h2>
                  <button id="openWhatsApp" class="px-4 py-2 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-500">WhatsApp Web</button>
                </div>
              </div>
              <div id="chatListPage" class="flex-1 p-4 overflow-y-auto space-y-3 scrollbar-hide"></div>
              <div id="typingIndicator" class="hidden h-6 px-4 text-sm text-gray-400 italic"></div>
              <div class="relative p-4 border-t border-slate-800 flex items-center space-x-3">
                <!-- Emoji Picker -->
                <div id="emojiPicker" class="hidden absolute right-4 p-2 glass rounded-lg grid gap-1 w-64 z-10">
                  <!-- Emojis will be populated by JS -->
                </div>

                <input id="chatInputPage" type="text" placeholder="Type your message..." class="flex-1 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                <button id="emojiBtnPage" class="px-3 py-2 rounded-lg bg-slate-700 text-white" title="Add Emoji">ðŸ˜€</button>
                <button id="shareEventBtnPage" class="px-4 py-2 rounded-lg bg-blue-600 text-white" title="Share Upcoming Event">ðŸ“…</button>
                <button id="sendMsgPage" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600">Send</button>
              </div>
            </div>
          </section>

          <!-- M-Pesa Admin Page -->
          <section id="page-mpesa-admin" class="hidden">
            <div class="glass rounded-2xl p-6">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">M-Pesa Transactions</h2>
                <button id="refreshMpesaAdmin" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 flex items-center gap-2">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                  Refresh
                </button>
              </div>
              
              <div class="overflow-x-auto rounded-lg border border-slate-700">
                <table class="w-full text-left text-sm text-gray-300">
                  <thead class="bg-slate-800/80 text-gray-400 uppercase text-xs">
                    <tr>
                      <th class="px-4 py-3">Date</th>
                      <th class="px-4 py-3">Phone</th>
                      <th class="px-4 py-3">Amount</th>
                      <th class="px-4 py-3">Receipt</th>
                      <th class="px-4 py-3">Status</th>
                      <th class="px-4 py-3">Details</th>
                    </tr>
                  </thead>
                  <tbody id="mpesaAdminTableBody" class="divide-y divide-slate-800 bg-slate-900/30">
                    <!-- Rows populated by JS -->
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Placeholder for other pages -->
          <section id="page-contributions" class="hidden">
            <div class="glass rounded-2xl p-6">
              <h2 class="text-2xl font-bold mb-4">Contributions</h2>
              
              <!-- Payment Method Tabs -->
              <div class="flex space-x-2 mb-6 bg-slate-900/40 p-1 rounded-xl w-fit">
                <button id="tabContribManual" class="px-4 py-2 rounded-lg bg-slate-700 text-white font-semibold text-sm transition-all shadow-lg">Manual Entry</button>
                <button id="tabContribMpesa" class="px-4 py-2 rounded-lg text-gray-400 hover:text-white font-semibold text-sm transition-all hover:bg-slate-800/50">M-Pesa (STK)</button>
              </div>

              <div id="viewContribManual" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="p-4 rounded-lg bg-slate-900/30">
                  <h3 class="font-semibold mb-2">Lookup Household</h3>
                  <div class="mb-3">
                    <select id="contributionLookup" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700">
                      <option value="">Select a household...</option>
                    </select>
                  </div>
                  <div id="contribHouseInfo" class="mb-3 text-sm text-gray-300">No household selected.</div>

                  <div id="pledgeInfo" class="mb-3 text-sm text-gray-300">Pledge: â€”</div>

                  <div class="space-y-2">
                    <input id="regularAmt" type="number" step="0.01" placeholder="Regular offering amount" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                    <input id="capitalAmt" type="number" step="0.01" placeholder="Capital campaign amount" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                    <button id="contribSubmit" class="w-full py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600">Record Contribution</button>
                  </div>
                </div>

                <div class="p-4 rounded-lg bg-slate-900/30">
                  <h3 class="font-semibold mb-2">Loose Offerings (Cash/Checks)</h3>
                  <div class="flex flex-col sm:flex-row gap-2 mb-3">
                    <input id="looseAmount" type="number" step="0.01" placeholder="Amount" class="flex-1 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                    <input id="looseDate" type="date" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                    <button id="looseAdd" class="px-3 py-2 rounded-lg bg-purple-800/60">Add</button>
                  </div>
                  <div id="looseList" class="text-sm text-gray-300 max-h-28 overflow-y-auto pr-2">
                    <!-- Loose offerings list populated by JS -->
                  </div>
                  <div id="looseTotal" class="text-sm font-bold mt-2 pt-2 border-t border-slate-700"></div>
                </div>
              </div>

              <!-- M-Pesa Payment Section (Tab View) -->
              <div id="viewContribMpesa" class="hidden max-w-md mx-auto">
                <div class="p-6 rounded-2xl bg-slate-900/30 border border-green-500/30 relative overflow-hidden">
                  <div class="absolute top-0 right-0 p-2 opacity-10 pointer-events-none">
                    <svg width="100" height="100" viewBox="0 0 24 24" fill="currentColor"><path d="M17 9V7c0-2.8-2.2-5-5-5S7 4.2 7 7v2c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V11c0-1.1-.9-2-2-2zm-5-5c1.7 0 3 1.3 3 3v2H9V7c0-1.7 1.3-3 3-3zm5 15H7V11h10v8z"/></svg>
                  </div>
                  <h3 class="font-semibold mb-2 text-green-400 flex items-center gap-2">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5a3 3 0 00-6 0M7 19a4 4 0 018 0"/></svg>
                    M-Pesa (STK Push)
                  </h3>
                  <p class="text-xs text-gray-400 mb-3">Send contribution directly to <strong>0798245312</strong>.</p>
                  <div class="space-y-2">
                    <input id="mpesaPhone" type="tel" placeholder="Payer Phone (e.g., 07...)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                    <input id="mpesaAmount" type="number" placeholder="Amount (KES)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                    <select id="mpesaHousehold" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm"><option value="">Select Household (Optional)</option></select>
                    <button id="btnMpesaPay" class="w-full py-2 rounded-lg bg-green-600 hover:bg-green-500 font-bold text-white shadow-lg shadow-green-900/20 transition-all active:scale-95">Pay with M-Pesa</button>
                    <div id="mpesaStatus" class="text-xs text-center min-h-[1.5rem] flex items-center justify-center"></div>
                  </div>
                </div>
              </div>

              <!-- Recent Contributions -->
              <div id="recentContributionsContainer" class="mt-6 p-4 rounded-lg bg-slate-900/30">
                <div class="flex justify-between items-center mb-2">
                  <h3 class="font-semibold">Recent Contributions</h3>
                  <button id="printRecentContributions" class="px-3 py-1 text-xs rounded-lg bg-slate-800/60 hover:bg-slate-700">Print</button>
                </div>
                <div id="recentContributionsList" class="text-sm text-gray-300 max-h-64 overflow-y-auto">
                  <!-- List will be populated by JS -->
                </div>
              </div>
            </div>
          </section>

          <section id="page-households" class="hidden">
            <div class="glass rounded-2xl p-6">
              <h2 class="text-2xl font-bold mb-4">Households</h2>
              <div class="grid md:grid-cols-2 gap-6">
                <div class="p-4 rounded-lg bg-slate-900/30">
                  <h3 id="householdFormTitle" class="font-semibold mb-2">Register Household</h3>
                  <div class="space-y-2">
                    <input id="householdIdField" type="hidden"> <!-- To store ID when editing -->
                    <input id="houseHead" placeholder="Head of household" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                    <input id="houseAddress" placeholder="Address" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                    <input id="housePhone" type="tel" placeholder="10-digit Phone Number" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" maxlength="10" pattern="\d{10}" title="Please enter a 10-digit phone number." />
                    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                      <input id="houseEnvelope" placeholder="Click 'Generate' for Envelope ID" readonly class="flex-1 px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 cursor-not-allowed" />
                      <button id="genEnvelopeBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold">Generate</button>
                    </div>
                    <div class="flex items-center gap-4 pt-2">
                        <select id="membershipStatus" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="new">New Member</option>
                            <option value="visitor">Visitor</option>
                        </select>
                        <label class="flex items-center space-x-2 whitespace-nowrap"><input id="membershipClass" type="checkbox" class="w-4 h-4" /> <span class="text-sm text-gray-300">Membership Class</span></label>
                    </div>
                    <div class="pt-2 border-t border-slate-800/50">
                        <label class="flex items-center space-x-2 mb-2 cursor-pointer"><input id="addPledgeCheckbox" type="checkbox" class="w-4 h-4" /> <span class="text-sm text-gray-300">Add a pledge for this household</span></label>
                        <div id="pledgeFields" class="hidden space-y-2">
                            <input id="pledgeAmount" type="number" step="0.01" placeholder="Pledge amount" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                            <input id="pledgeStartDate" type="date" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                        </div>
                    </div>
                    <!-- Family Members -->
                    <div class="pt-3 border-t border-slate-800/50 !mt-4">
                        <h4 class="font-semibold text-sm mb-2 text-purple-200">Family Members</h4>
                        <div id="familyMembersList" class="space-y-2 mb-3 max-h-28 overflow-y-auto pr-2">
                            <!-- Member items will be populated here by JS -->
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input id="newMemberName" placeholder="Member's Full Name" class="flex-1 px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-sm">
                            <select id="newMemberRole" class="px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-sm">
                                <option value="Spouse">Spouse</option>
                                <option value="Child">Child</option>
                                <option value="Parent">Parent</option>
                                <option value="Other">Other</option>
                            </select>
                            <button id="addFamilyMemberBtn" type="button" class="px-3 py-2 rounded-lg bg-blue-600 text-white font-semibold text-sm">Add</button>
                        </div>
                    </div>
                    <button id="houseCreate" class="w-full px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 !mt-4">Create Household</button>
                    <button id="cancelEditHousehold" class="hidden w-full px-4 py-2 rounded-lg bg-slate-700 !mt-2">Cancel Edit</button>
                  </div>
                </div>
                <div class="p-4 rounded-lg bg-slate-900/30">
                  <h3 class="font-semibold mb-2">Existing Households</h3>
                  <input id="houseSearch" placeholder="Search by name or envelope..." class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-3" />
                  <div id="houseList" class="text-sm text-gray-300 max-h-56 overflow-y-auto"></div>
                </div>
              </div>
            </div>
          </section>

          <section id="page-ceremonies" class="hidden">
            <div class="glass rounded-2xl p-6">
              <h2 class="text-2xl font-bold mb-4">Ceremonies</h2>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left column for forms -->
                <div class="space-y-4">
                  <div class="p-4 rounded-lg bg-slate-900/30">
                    <input type="hidden" id="baptismId">
                    <h4 class="font-semibold mb-2">Baptism</h4>
                    <select id="baptismHousehold" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2"><option value="">Select Household...</option></select>
                    <input id="baptismName" placeholder="Child/Person's name" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2" />
                    <input id="baptismSponsor" placeholder="Godmother/Godfather" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2" />
                    <input id="baptismDate" type="date" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2" />
                    <textarea id="baptismNotes" placeholder="Notes..." rows="2" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2"></textarea>
                    <label class="flex items-center space-x-2 mb-2"><input id="baptismPrep" type="checkbox" class="w-4 h-4" /> <span class="text-sm text-gray-300">Preparation class completed</span></label>
                    <div class="flex items-center gap-2">
                      <button id="baptismSubmit" class="px-3 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600">Record Baptism</button>
                      <button id="baptismCancelEdit" class="hidden px-3 py-2 rounded-lg bg-slate-700">Cancel</button>
                    </div>
                  </div>
                  <div class="p-4 rounded-lg bg-slate-900/30">
                    <input type="hidden" id="weddingId">
                    <h4 class="font-semibold mb-2">Wedding</h4>
                    <input id="weddingPersonA" placeholder="Person A name" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2" />
                    <select id="weddingHousehold" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2"><option value="">Select Household (Optional)...</option></select>
                    <input id="weddingPersonB" placeholder="Person B name" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2" />
                    <input id="weddingDate" type="date" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2" />
                    <textarea id="weddingNotes" placeholder="Notes..." rows="2" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2"></textarea>
                    <label class="flex items-center space-x-2 mb-2"><input id="weddingPrep" type="checkbox" class="w-4 h-4" /> <span class="text-sm text-gray-300">2 months of preparation completed</span></label>
                    <label class="flex items-center space-x-2 mb-2"><input id="weddingMemberCheck" type="checkbox" class="w-4 h-4" /> <span class="text-sm text-gray-300">At least one registered member</span></label>
                    <div class="flex items-center gap-2">
                      <button id="weddingSubmit" class="px-3 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600">Record Wedding</button>
                      <button id="weddingCancelEdit" class="hidden px-3 py-2 rounded-lg bg-slate-700">Cancel</button>
                    </div>
                  </div>
                  <div class="p-4 rounded-lg bg-slate-900/30">
                    <input type="hidden" id="funeralId">
                    <h4 class="font-semibold mb-2">Funeral</h4>
                    <select id="funeralHousehold" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2"><option value="">Select Household (Optional)...</option></select>
                    <input id="funeralName" placeholder="Deceased name" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2" />
                    <input id="funeralDate" type="date" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2" />
                    <textarea id="funeralNotes" placeholder="Notes..." rows="2" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2"></textarea>
                    <div class="flex items-center gap-2">
                      <button id="funeralSubmit" class="px-3 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600">Record Funeral</button>
                      <button id="funeralCancelEdit" class="hidden px-3 py-2 rounded-lg bg-slate-700">Cancel</button>
                    </div>
                  </div>
                  <div class="p-4 rounded-lg bg-slate-900/30">
                    <input type="hidden" id="confirmationId">
                    <h4 class="font-semibold mb-2">Confirmation</h4>
                    <select id="confirmationHousehold" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2"><option value="">Select Household...</option></select>
                    <input id="confirmationName" placeholder="Person's name" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2" />
                    <input id="confirmationSponsor" placeholder="Sponsor's name" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2" />
                    <input id="confirmationDate" type="date" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2" />
                    <textarea id="confirmationNotes" placeholder="Notes..." rows="2" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-2"></textarea>
                    <div class="flex items-center gap-2">
                      <button id="confirmationSubmit" class="px-3 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600">Record Confirmation</button>
                      <button id="confirmationCancelEdit" class="hidden px-3 py-2 rounded-lg bg-slate-700">Cancel</button>
                    </div>
                  </div>
                </div>
                <!-- Right column for calendar and list -->
                <div class="space-y-4">
                  <div id="ceremonyCalendar"></div>
                  <!-- Recorded Ceremonies List -->
                  <div id="recordedCeremoniesContainer" class="p-4 rounded-lg bg-slate-900/30">
                    <div class="flex justify-between items-center mb-2">
                      <h3 class="font-semibold">Recently Recorded Ceremonies</h3>
                      <button id="printCeremoniesBtn" class="px-3 py-1 text-xs rounded-lg bg-slate-800/60 hover:bg-slate-700">Print</button>
                    </div>
                    <input id="ceremoniesSearch" placeholder="Search by type, name, sponsor..." class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 mb-3" />
                    <div id="recordedCeremoniesList" class="text-sm text-gray-300 max-h-56 overflow-y-auto">
                      <!-- List will be populated by JS -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Events Page -->
          <section id="page-events" class="hidden">
            <div class="glass rounded-2xl p-6">
              <h2 class="text-2xl font-bold mb-4">Event Management</h2>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left: Create/Edit Event Form -->
                <div class="p-4 rounded-lg bg-slate-900/30">
                  <h3 id="eventFormTitle" class="font-semibold mb-3">Create New Event</h3>
                  <div class="space-y-3">
                    <input id="eventId" type="hidden">
                    <select id="eventTitleSelect" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700">
                        <option value="Sunday Service">Sunday Service</option>
                        <option value="Youth Group">Youth Group</option>
                        <option value="Bible Study">Bible Study</option>
                        <option value="Special Event">Special Event</option>
                        <option value="other">Other (specify below)</option>
                    </select>
                    <input id="eventTitleOther" type="text" placeholder="Custom Event Title" class="hidden w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                    <input id="eventDate" type="datetime-local" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                    <input id="eventLocation" type="text" placeholder="Location (e.g., Main Hall, Online)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                    <textarea id="eventDescription" rows="4" placeholder="Event description, details, and notes..." class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700"></textarea>
                    <label class="flex items-center gap-2 text-sm text-gray-300 pt-1"><input id="eventIsMandatory" type="checkbox" class="w-4 h-4" /> Mark as Mandatory Attendance</label>
                    <button id="eventSubmit" class="w-full py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600">Create Event</button>
                    <button id="cancelEditEvent" class="hidden w-full py-2 rounded-lg bg-slate-700 !mt-2">Cancel Edit</button>
                  </div>
                </div>
                <!-- Right: List of Events -->
                <div class="p-4 rounded-lg bg-slate-900/30">
                  <h3 class="font-semibold mb-3">Upcoming & Recent Events</h3>
                  <div class="flex flex-col sm:flex-row gap-3 mb-3">
                    <input id="eventSearch" type="text" placeholder="Search events..." class="flex-1 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                    <label class="flex-shrink-0 flex items-center gap-2 text-sm text-gray-300 p-2 rounded-lg bg-slate-800/50"><input id="filterMandatoryEvents" type="checkbox" class="w-4 h-4" /> Show Mandatory Only</label>
                  </div>
                  <div id="eventsList" class="text-sm text-gray-300 max-h-96 overflow-y-auto space-y-3 pr-2">
                    <!-- Events will be populated by JS -->
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section id="page-reports" class="hidden">
            <div class="glass rounded-2xl p-6">
                <h2 class="text-2xl font-bold mb-6">Reports & Analytics</h2>

                <!-- Financial Reports Section -->
                <h3 class="text-xl font-semibold mb-4 text-purple-300 border-b border-slate-700 pb-2">Financial Reports</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
                    <!-- Report Card: Annual Tax -->
                    <div class="card-hover glass rounded-2xl p-5">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="p-2 rounded-full bg-purple-500/20"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 7H6a2 2 0 00-2 2v9a2 2 0 002 2h9a2 2 0 002-2v-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 15h3l8.5-8.5a2.121 2.121 0 00-3-3L9 12v3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M14.5 6.5L17.5 9.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                            <h4 class="font-semibold text-lg">Annual Tax Report</h4>
                        </div>
                        <div class="flex gap-2 mb-3">
                            <select id="taxYear" class="flex-1 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700"><option value="2025">2025</option><option value="2024">2024</option><option value="2023">2023</option></select>
                            <button id="genTax" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 font-semibold">Generate</button>
                            <button id="printTax" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 font-semibold">Print</button>
                        </div>
                        <div id="taxPreview" class="text-sm text-gray-300 max-h-48 overflow-y-auto p-3 rounded-lg bg-slate-900/50 border border-slate-800"></div>
                    </div>

                    <!-- Report Card: Monthly -->
                    <div class="card-hover glass rounded-2xl p-5">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="p-2 rounded-full bg-sky-500/20"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="1.5"/><path d="M16 2v4M8 2v4M3 10h18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                            <h4 class="font-semibold text-lg">Monthly Report</h4>
                        </div>
                        <div class="flex gap-2 mb-3">
                            <input id="reportMonth" type="month" class="flex-1 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                            <button id="genMonth" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 font-semibold">Generate</button>
                            <button id="exportMonth" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 font-semibold">Export</button>
                        </div>
                        <div id="monthPreview" class="text-sm text-gray-300 max-h-48 overflow-y-auto p-3 rounded-lg bg-slate-900/50 border border-slate-800"></div>
                    </div>

                    <!-- Report Card: Pledge Status -->
                    <div class="card-hover glass rounded-2xl p-5">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="p-2 rounded-full bg-emerald-500/20"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 19.128c-2.43.7-5.13.443-7.36-.825-2.702-1.53-4.41-4.443-4.41-7.675 0-4.97 4.03-9 9-9s9 4.03 9 9c0 1.39-.314 2.71-.87 3.89" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 22v-4.5l-3 3-3-3V22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                            <h4 class="font-semibold text-lg">Pledge Status</h4>
                        </div>
                        <div class="flex gap-2 mb-3">
                            <button id="genPledgeReport" class="flex-1 px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 font-semibold">Generate & Preview</button>
                            <button id="exportPledgeReport" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 font-semibold">Export</button>
                        </div>
                        <div id="pledgeReportPreview" class="text-sm text-gray-300 max-h-64 overflow-y-auto p-1 rounded-lg bg-slate-900/50 border border-slate-800"></div>
                    </div>

                    <!-- Report Card: Loans Report -->
                    <div class="card-hover glass rounded-2xl p-5">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="p-2 rounded-full bg-yellow-500/20"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21.44 11.05l-9.19-9.19a6 6 0 00-8.49 8.49l9.19 9.19a4 4 0 005.66 0l2.83-2.83a4 4 0 000-5.66z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><line x1="14.5" y1="9.5" x2="9.5" y2="14.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                            <h4 class="font-semibold text-lg">Loans Report</h4>
                        </div>
                        <p class="text-xs text-gray-400 mb-3">Generate a summary of all loans issued to members.</p>
                        <div class="flex gap-2 mb-3">
                            <button id="genLoansReport" class="flex-1 px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 font-semibold">Generate & Preview</button>
                            <button id="exportLoansReport" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 font-semibold">Export</button>
                        </div>
                        <div id="loansReportPreview" class="text-sm text-gray-300 max-h-64 overflow-y-auto p-1 rounded-lg bg-slate-900/50 border border-slate-800">
                            <!-- Preview will be populated here -->
                        </div>
                    </div>

                </div>

                <!-- Membership Reports Section -->
                <h3 class="text-xl font-semibold mb-4 text-purple-300 border-b border-slate-700 pb-2">Membership Reports</h3>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Report Card: Inactive Members -->
                    <div class="card-hover glass rounded-2xl p-5 lg:col-span-1">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="p-2 rounded-full bg-red-500/20"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="10" cy="7" r="4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><line x1="17" y1="8" x2="22" y2="13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><line x1="22" y1="8" x2="17" y2="13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                            <h4 class="font-semibold text-lg">Inactive Members</h4>
                        </div>
                        <div class="flex gap-2 mb-3">
                            <button id="genInactiveReport" class="flex-1 px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 font-semibold">Generate & Preview</button>
                            <button id="exportInactiveReport" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 font-semibold">Export</button>
                        </div>
                        <div id="inactiveReportPreview" class="text-sm text-gray-300 max-h-64 overflow-y-auto p-1 rounded-lg bg-slate-900/50 border border-slate-800"></div>
                    </div>

                    <!-- Report Card: Member Directory -->
                    <div class="card-hover glass rounded-2xl p-5 lg:col-span-2">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="p-2 rounded-full bg-blue-500/20"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 4h16v16H4V4z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 10h16M10 4v16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                            <h4 class="font-semibold text-lg">Member Directory</h4>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mb-3">
                            <input id="memberDirectorySearch" type="text" placeholder="Search by name..." class="flex-1 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm min-w-[150px]">
                            <select id="memberDirectoryStatusFilter" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm">
                                <option value="">All Statuses</option><option value="active">Active</option><option value="inactive">Inactive</option><option value="new">New Member</option><option value="visitor">Visitor</option>
                            </select>
                            <select id="memberDirectoryRoleFilter" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm">
                                <option value="">All Roles</option><option value="Head">Head of Household</option><option value="Spouse">Spouse</option><option value="Child">Child</option>
                            </select>
                            <button id="exportMemberDirectory" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 font-semibold">Export</button>
                        </div>
                        <div id="memberDirectoryPreview" class="text-sm text-gray-300 max-h-96 overflow-y-auto p-1 rounded-lg bg-slate-900/50 border border-slate-800"></div>
                    </div>

                </div>

                <!-- Activity Reports Section -->
                <h3 class="text-xl font-semibold mb-4 text-purple-300 border-b border-slate-700 pb-2">Activity Reports</h3>
                <div class="grid grid-cols-1 gap-6">
                    <!-- Report Card: Ceremony Report -->
                    <div class="card-hover glass rounded-2xl p-5">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="p-2 rounded-full bg-orange-500/20"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L4 4.5V9c0 5.523 3.582 10 8 11.5 4.418-1.5 8-5.977 8-11.5V4.5L12 2z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                            <h4 class="font-semibold text-lg">Ceremony Report</h4>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mb-3">
                            <label class="text-xs text-gray-400">From:</label>
                            <input id="ceremonyStartDate" type="date" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm" title="Start Date">
                            <label class="text-xs text-gray-400">To:</label>
                            <input id="ceremonyEndDate" type="date" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm" title="End Date">
                            <select id="ceremonyTypeFilter" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm">
                                <option value="">All Types</option><option value="baptism">Baptism</option><option value="wedding">Wedding</option><option value="funeral">Funeral</option><option value="confirmation">Confirmation</option>
                            </select>
                            <button id="genCeremonyReport" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 font-semibold">Generate</button>
                            <button id="exportCeremonyReport" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 font-semibold">Export</button>
                        </div>
                        <div id="ceremonyReportPreview" class="text-sm text-gray-300 max-h-64 overflow-y-auto p-1 rounded-lg bg-slate-900/50 border border-slate-800"></div>
                    </div>
                </div>
            </div>
        </section>

          <section id="page-attendance" class="hidden">
            <div class="glass rounded-2xl p-6">
              <h2 class="text-2xl font-bold mb-4">Attendance Tracking</h2>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left: Record Attendance -->
                <div class="p-4 rounded-lg bg-slate-900/30">
                  <h3 class="font-semibold mb-2">Record New Attendance</h3>
                  <div class="space-y-3">
                    <input id="attendanceId" type="hidden">
                    <input id="attendanceDate" type="date" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                    <select id="attendanceEvent" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700">
                      <option value="sunday_service">Sunday Service</option>
                      <option value="youth_group">Youth Group</option>
                      <option value="bible_study">Bible Study</option>
                      <option value="special_event">Special Event</option>
                      <option value="other">Other Event</option>
                    </select>
                    <input id="attendanceCount" type="number" placeholder="Headcount" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                    <textarea id="attendanceNotes" placeholder="Notes (e.g., guest speaker, weather)" rows="2" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700"></textarea>
                    <button id="attendanceSubmit" class="w-full py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600">Log Attendance</button>
                    <button id="cancelEditAttendance" class="hidden w-full py-2 rounded-lg bg-slate-700 !mt-2">Cancel Edit</button>
                  </div>
                </div>
                <!-- Right: Recent Attendance -->
                <div class="p-4 rounded-lg bg-slate-900/30">
                  <div class="flex justify-between items-center mb-2">
                    <h3 class="font-semibold">Recently Logged Attendance</h3>
                    <button id="exportAttendance" class="px-3 py-1 text-xs rounded-lg bg-slate-800/60 hover:bg-slate-700">Export CSV</button>
                  </div>
                  <div id="attendanceList" class="text-sm text-gray-300 max-h-96 overflow-y-auto"></div>
                </div>
              </div>

              <!-- New: Attendance Chart -->
              <div class="mt-6 p-4 rounded-lg bg-slate-900/30">
                <div class="flex flex-wrap justify-between items-center mb-3 gap-2">
                  <h3 class="font-semibold">Attendance Analytics</h3>
                  <div class="flex items-center gap-2">
                    <label for="attendanceChartFilter" class="text-xs">Event:</label>
                    <select id="attendanceChartFilter" class="px-2 py-1 text-xs rounded-lg bg-slate-800 border border-slate-700">
                      <option value="all">All Events</option>
                      <option value="sunday_service">Sunday Service</option>
                      <option value="youth_group">Youth Group</option>
                      <option value="bible_study">Bible Study</option>
                    </select>
                  </div>
                </div>
                <div class="h-64">
                  <canvas id="attendanceChart"></canvas>
                </div>
              </div>
            </div>
          </section>

          <!-- Finances (Loans) Page -->
          <section id="page-finances" class="hidden">
            <div class="glass rounded-2xl p-6">
              <h2 class="text-2xl font-bold mb-4">Financial Management (Loans)</h2>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left: Issue Loan / Record Payment -->
                <div class="p-4 rounded-lg bg-slate-900/30 space-y-4">
                  <div>
                    <h3 class="font-semibold mb-3">Issue New Loan</h3>
                    <div class="space-y-3">
                      <select id="loanHousehold" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700"></select>
                      <input id="loanPrincipal" type="number" placeholder="Principal Amount ($)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                      <input id="loanInterestRate" type="number" placeholder="Annual Interest Rate (%)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                      <input id="loanDate" type="date" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                      <button id="loanSubmit" class="w-full py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600">Issue Loan</button>
                    </div>
                  </div>
                  <div class="pt-4 border-t border-slate-800">
                    <h3 class="font-semibold mb-3">Record Repayment</h3>
                    <div class="space-y-3">
                      <select id="repaymentLoanSelect" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700"></select>
                      <input id="repaymentAmount" type="number" placeholder="Payment Amount ($)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                      <input id="repaymentDate" type="date" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
                      <button id="repaymentSubmit" class="w-full py-2 rounded-lg bg-gradient-to-r from-emerald-600 to-teal-600">Record Payment</button>
                    </div>
                  </div>
                </div>
                <!-- Right: List of Outstanding Loans -->
                <div class="p-4 rounded-lg bg-slate-900/30">
                  <h3 class="font-semibold mb-3">Outstanding Loans</h3>
                  <div id="loansList" class="text-sm text-gray-300 max-h-[40rem] overflow-y-auto space-y-3 pr-2">
                    <!-- Loans will be populated by JS -->
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Repayment History Modal -->
          <div id="repaymentHistoryModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="glass rounded-2xl p-6 w-full max-w-2xl">
              <div class="flex justify-between items-center mb-4">
                <h3 id="repaymentModalTitle" class="text-xl font-bold">Repayment History</h3>
                <button id="closeRepaymentModal" class="text-2xl font-bold hover:text-red-500">&times;</button>
              </div>
              <div id="repaymentHistoryContent" class="max-h-96 overflow-y-auto pr-2">
                <!-- History table will be populated here -->
              </div>
            </div>
          </div>
        </main>
      </div>

      <!-- Back to Top Button -->
      <button id="backToTopBtn" title="Back to Top" class="hidden fixed bottom-24 right-6 md:bottom-6 md:right-20 z-50 p-3 rounded-full bg-purple-600/70 text-white shadow-lg hover:bg-purple-500 transition-all backdrop-blur-sm">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 19V5M5 12l7-7 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>

      <!-- Floating Chatbot -->
      <div id="chatbotContainer" class="fixed bottom-6 right-6 z-50">
        <div id="botWindow" class="hidden mb-4 w-80 glass rounded-2xl overflow-hidden flex flex-col transition-all duration-300" style="height: 24rem;">
          <div id="botHeader" class="bg-gradient-to-r from-purple-600 to-pink-600 p-3 flex justify-between items-center cursor-move">
            <strong class="text-white">nyikuli AI ðŸ˜Š</strong>
            <div class="flex items-center gap-3">
              <button id="minimizeBot" class="text-white font-bold hover:text-gray-200" title="Minimize">_</button>
              <button id="closeBot" class="text-white hover:text-gray-200">âœ•</button>
            </div>
          </div>
          <div class="p-3 flex-1 overflow-y-auto">Hello! How can I assist you?</div>
           <div class="p-3 border-t border-slate-800 relative">
            <div class="flex gap-2">
              <input id="botInput" type="text" placeholder="Ask me anything..." class="flex-1 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" />
              <button id="botSend" type="button" class="px-3 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 text-white">Send</button>
            </div>
          </div>
        </div>
        <button id="openBot" class="bg-gradient-to-r from-purple-600 to-pink-600 p-3 rounded-full shadow-lg text-white hover:scale-110 transition-transform">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>

      <!-- Forgot Password Modal -->
      <div id="forgotPasswordModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass rounded-2xl p-6 w-full max-w-md">
          <h3 class="text-xl font-bold mb-4">Reset Password</h3>
          <p class="text-sm text-gray-300 mb-4">Enter your email address and we'll send you a link to reset your password.</p>
          <input id="forgotEmail" type="email" placeholder="Email address" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-800 focus:outline-none mb-4" />
          <div class="flex justify-end gap-2">
            <button id="closeForgotModal" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">Cancel</button>
            <button id="sendResetLink" class="px-4 py-2 rounded-lg bg-gradient-to-r from-emerald-400 to-sky-500 text-slate-900 font-semibold">Send Link</button>
          </div>
        </div>
      </div>

      <!-- Forgot Password Modal -->
      <div id="forgotPasswordModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass rounded-2xl p-6 w-full max-w-md">
          <h3 class="text-xl font-bold mb-4">Reset Password</h3>
          <p class="text-sm text-gray-300 mb-4">Enter your email address and we'll send you a link to reset your password.</p>
          <input id="forgotEmail" type="email" placeholder="Email address" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-800 focus:outline-none mb-4" />
          <div class="flex justify-end gap-2">
            <button id="closeForgotModal" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">Cancel</button>
            <button id="sendResetLink" class="px-4 py-2 rounded-lg bg-gradient-to-r from-emerald-400 to-sky-500 text-slate-900 font-semibold">Send Link</button>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <footer class="mt-12 py-6 text-center text-sm text-gray-400">
        <div class="container mx-auto">Â© 2025 ABC Church Information System. Built by Nyikuli Computer Science major KSU.</div>
      </footer>
    </div>
  </div>

  <script>
    // ----------------------
    // Simple state & helpers
    // ----------------------
    // Define the API base URL. For local dev, you can set localStorage.setItem('abc_api_base', 'http://localhost:3000') in your browser console.
    // IMPORTANT: Replace the placeholder with your actual live server URL from Render.
    const API_BASE = localStorage.getItem('abc_api_base') || 'https://api.your-custom-domain.com';

    // ----------------------
    // Data Models & Helpers (Moved up for access)
    // ----------------------
    const DB_KEYS = { households: 'abc_households', pledges: 'abc_pledges', contributions: 'abc_contributions', ceremonies: 'abc_ceremonies', loose: 'abc_loose', attendance: 'abc_attendance', prayers: 'abc_prayer_requests', events: 'abc_events', loans: 'abc_loans' };

    function read(key){ try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch(e){ return []; } }
    function write(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); }
    // Seed data if empty
    if (read(DB_KEYS.households).length === 0) { write(DB_KEYS.households, [{ id: 1, head: 'Margie Robbens', envelope: 'ENV001' }]); write(DB_KEYS.contributions, []); }

    const authPage = document.getElementById('authPage');
    const dashboard = document.getElementById('dashboard');
    const extraSignup = document.getElementById('extraSignup');
    const authSubmit = document.getElementById('authSubmit');
    const authCreate = document.getElementById('authCreate');
    const captcha = document.getElementById('captcha');

    const tabSignIn = document.getElementById('tabSignIn');
    const tabSignUp = document.getElementById('tabSignUp');
    const flipContainer = document.getElementById('flipContainer');
    let isSignUp = false;

    // Check for existing session on page load
    (function checkSession() {
        const creds = localStorage.getItem('abc_credentials');
        if (creds) {
            try {
                const decoded = atob(creds);
                const email = decoded.split(':')[0];
                const userRecord = JSON.parse(localStorage.getItem('abc_user:' + email) || 'null');

                // Verify credentials against local storage as a basic session check
                if (userRecord && userRecord.creds === creds) {
                    authPage.classList.add('hidden');
                    dashboard.classList.remove('hidden');
                }
            } catch (e) {
                // If creds are invalid, clear them
                localStorage.removeItem('abc_credentials');
            }
        }
    })();

    function updateAuthUI(){
      if (isSignUp){
        flipContainer.classList.add('is-flipped');
        tabSignUp.classList.add('bg-slate-700','rounded-full');
        tabSignIn.classList.remove('bg-slate-700','rounded-full');
      } else {
        flipContainer.classList.remove('is-flipped');
        tabSignIn.classList.add('bg-slate-700','rounded-full');
        tabSignUp.classList.remove('bg-slate-700','rounded-full');
      }
    }

    tabSignIn.addEventListener('click', ()=>{ isSignUp = false; extraSignup.classList.remove('hidden'); updateAuthUI(); });
    tabSignUp.addEventListener('click', ()=>{ isSignUp = true; extraSignup.classList.remove('hidden'); updateAuthUI(); });

    // initial state
    updateAuthUI();

    // Email + Phone verification wiring (client-side with server fallback)
    (function setupVerification(){
      const sendEmailBtn = document.getElementById('sendCodeBtn');
      const verifyEmailBtn = document.getElementById('verifyCodeBtn');
      const signupEmailEl = document.getElementById('signupEmail');
      const signupCodeEl = document.getElementById('signupCode');
      const verifyMsg = document.getElementById('verifyMsg');
      const verifyRow = document.getElementById('verifyRow');

      const sendPhoneBtn = document.getElementById('sendPhoneBtn');
      const verifyPhoneBtn = document.getElementById('verifyPhoneBtn');
      const signupPhoneEl = document.getElementById('signupPhone');
      const signupPhoneCodeEl = document.getElementById('signupPhoneCode');
      const verifyPhoneRow = document.getElementById('verifyPhoneRow');
      const verifyPhoneMsg = document.getElementById('verifyPhoneMsg');

      const API = localStorage.getItem('abc_api_base') || 'http://localhost:3000';

      function genCode(){ return String(Math.floor(100000 + Math.random()*900000)); }

      async function sendEmailCode(){
        const email = signupEmailEl.value.trim(); if (!email){ alert('Enter email'); return; }
        verifyMsg.textContent = 'Sending code...'; verifyRow.classList.remove('hidden');
        try{
          const res = await fetch(API + '/api/auth/send-code', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email }) });
          const j = await res.json();
          if (j && j.ok){ verifyMsg.textContent = j.simulated ? ('Development: code = ' + j.code) : 'Code sent â€” check your email.'; return; }
        } catch(e){ /* fallback to local */ }
        // local fallback
        const code = genCode();
        localStorage.setItem('abc_verif_local:' + email, JSON.stringify({ code, expires: Date.now() + 5*60*1000 }));
        verifyMsg.textContent = 'Development: code = ' + code;
      }

      async function verifyEmailCode(){
        const email = signupEmailEl.value.trim(); const code = signupCodeEl.value.trim(); if (!email || !code){ alert('Enter email and code'); return; }
        verifyMsg.textContent = 'Verifying...';
        try{
          const res = await fetch(API + '/api/auth/verify-code', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, code }) });
          const j = await res.json(); if (j && j.ok){ localStorage.setItem('abc_verified:' + email, '1'); verifyMsg.textContent = 'Email verified.'; return; }
        } catch(e){ /* fallback */ }
        // local fallback
        try{
          const entry = JSON.parse(localStorage.getItem('abc_verif_local:' + email) || '{}');
          if (entry && entry.code === code && entry.expires > Date.now()){ localStorage.setItem('abc_verified:' + email, '1'); verifyMsg.textContent = 'Email verified (local).'; return; }
          verifyMsg.textContent = 'Code mismatch or expired.';
        } catch(e){ verifyMsg.textContent = 'Verification failed.'; }
      }

      // Phone OTP
      function sendPhoneOTPLocal(phone){
        const code = genCode();
        localStorage.setItem('abc_phone_otp:' + phone, JSON.stringify({ code, expires: Date.now() + 5*60*1000 }));
        verifyPhoneRow.classList.remove('hidden'); verifyPhoneMsg.textContent = 'Development: OTP = ' + code;
      }

      async function sendPhoneOTP(){
        const phone = signupPhoneEl.value.trim(); if (!phone){ alert('Enter phone number'); return; }
        verifyPhoneMsg.textContent = 'Sending OTP...'; verifyPhoneRow.classList.remove('hidden');
        // try server API (not required) â€” fallback to local generation
        try{
          const res = await fetch(API + '/api/auth/send-otp', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ phone }) });
          const j = await res.json(); if (j && j.ok){ verifyPhoneMsg.textContent = j.simulated ? ('Development: otp = ' + j.code) : 'OTP sent'; return; }
        } catch(e){ /* ignore */ }
        sendPhoneOTPLocal(phone);
      }

      function verifyPhoneLocal(phone, code){
        try{
          const entry = JSON.parse(localStorage.getItem('abc_phone_otp:' + phone) || '{}');
          if (entry && entry.code === code && entry.expires > Date.now()){ localStorage.setItem('abc_phone_verified:' + phone, '1'); verifyPhoneMsg.textContent = 'Phone verified (local).'; return true; }
          verifyPhoneMsg.textContent = 'OTP mismatch or expired.'; return false;
        } catch(e){ verifyPhoneMsg.textContent = 'Verification failed.'; return false; }
      }

      async function verifyPhoneOTP(){
        const phone = signupPhoneEl.value.trim(); const code = signupPhoneCodeEl.value.trim(); if (!phone || !code){ alert('Enter phone and OTP'); return; }
        verifyPhoneMsg.textContent = 'Verifying...';
        try{
          const res = await fetch(API + '/api/auth/verify-otp', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ phone, code }) });
          const j = await res.json(); if (j && j.ok){ localStorage.setItem('abc_phone_verified:' + phone, '1'); verifyPhoneMsg.textContent = 'Phone verified.'; return; }
        } catch(e){ /* fallback */ }
        verifyPhoneLocal(phone, code);
      }

      if (sendEmailBtn) sendEmailBtn.addEventListener('click', sendEmailCode);
      if (verifyEmailBtn) verifyEmailBtn.addEventListener('click', verifyEmailCode);
      if (sendPhoneBtn) sendPhoneBtn.addEventListener('click', sendPhoneOTP);
      if (verifyPhoneBtn) verifyPhoneBtn.addEventListener('click', verifyPhoneOTP);
    })();

    // Password Strength Meter Logic
    (function setupPasswordStrength(){
        const passInput = document.getElementById('signupPassword');
        const container = document.getElementById('strengthContainer');
        const bar = document.getElementById('strengthBar');
        if(passInput && container && bar){
            passInput.addEventListener('input', ()=>{
                const val = passInput.value;
                if(!val) { container.classList.add('opacity-0'); bar.style.width='0%'; return; }
                container.classList.remove('opacity-0');
                let score = 0;
                if(val.length > 5) score++;
                if(val.length > 8) score++;
                if(/[A-Z]/.test(val)) score++;
                if(/[0-9]/.test(val)) score++;
                if(/[^A-Za-z0-9]/.test(val)) score++;
                
                const pct = Math.min(100, (score/5)*100);
                bar.style.width = pct + '%';
                if(score <= 2) bar.className = 'h-full transition-all duration-500 ease-out bg-red-500';
                else if(score <= 3) bar.className = 'h-full transition-all duration-500 ease-out bg-yellow-500';
                else bar.className = 'h-full transition-all duration-500 ease-out bg-emerald-500';
            });
        }
    })();

    // handle Sign Up submit â€” require successful email and phone verification first
    authCreate.addEventListener('click', () => {
      const name = document.getElementById('fullName').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const phone = (document.getElementById('signupPhone') && document.getElementById('signupPhone').value.trim()) || '';
      const password = document.getElementById('signupPassword').value;
      const confirm = document.getElementById('confirmPassword').value;
      
      const form = document.getElementById('signUpForm');
      function shake(){ form.classList.add('animate-shake'); setTimeout(()=>form.classList.remove('animate-shake'), 400); }

      if (!name || !email || !password) { alert('Enter name, email and password'); shake(); return; }
      if (password !== confirm) { alert('Passwords do not match'); shake(); return; }
      if (!captcha.checked) { alert('Please check the CAPTCHA box'); shake(); return; }

      // ensure email verified via code
      const verified = localStorage.getItem('abc_verified:' + email) === '1';
      if (!verified) { alert('Please verify your email before creating an account. Click "Send code" and enter the code received.'); return; }

      // ensure phone verified via OTP
      const phoneVerified = phone ? (localStorage.getItem('abc_phone_verified:' + phone) === '1') : false;
      if (!phone || !phoneVerified) { alert('Please verify your phone number via OTP before creating an account.'); return; }
      
      const creds = btoa(email + ':' + password);
      localStorage.setItem('abc_user:' + email, JSON.stringify({ name, email, creds }));
      alert('Account created successfully! Please sign in.');
      isSignUp = false;
      updateAuthUI();
    });
 
    authSubmit.addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      if (!email || !password) { alert('Enter email and password'); return; }

      // This handler is for the Sign In button. The Sign Up button has its own handler.
      if (isSignUp) return;

      const spinner = authSubmit.querySelector('.spinner');
      const buttonText = authSubmit.querySelector('.button-text');
      authSubmit.disabled = true;
      spinner.classList.remove('hidden');

      let authenticated = false;
      const creds = btoa(email + ':' + password);

      try {
        const response = await fetch(API_BASE + '/api/auth/signin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        if (response.ok) {
          authenticated = true;
        }
      } catch (error) {
        // Server auth failed, will proceed to local auth
      }

      if (!authenticated) {
        // Fallback to local auth
        const userRecord = JSON.parse(localStorage.getItem('abc_user:' + email) || 'null');
        if (userRecord && userRecord.creds === creds) {
          authenticated = true;
        }
      }

      if (authenticated) {
        localStorage.setItem('abc_credentials', creds);
        authPage.classList.add('hidden');
        dashboard.classList.remove('hidden');
        renderContribChart();
        loadInitialChat();
      } else {
        alert('Sign in failed. Please check your email and password.');
      }
    });

    // ----------------------
    // Forgot Password Modal Logic
    // ----------------------
    (function setupForgotPassword() {
        const forgotLink = document.getElementById('forgotPasswordLink');
        const forgotModal = document.getElementById('forgotPasswordModal');
        const closeForgotBtn = document.getElementById('closeForgotModal');
        const sendResetBtn = document.getElementById('sendResetLink');
        const forgotEmailInput = document.getElementById('forgotEmail');

        if (forgotLink && forgotModal) {
            forgotLink.addEventListener('click', (e) => { e.preventDefault(); forgotModal.classList.remove('hidden'); });
            
            const closeForgot = () => { forgotModal.classList.add('hidden'); forgotEmailInput.value = ''; };
            if (closeForgotBtn) closeForgotBtn.addEventListener('click', closeForgot);
            if (forgotModal) forgotModal.addEventListener('click', (e) => { if (e.target === forgotModal) closeForgot(); });

            if (sendResetBtn) {
                sendResetBtn.addEventListener('click', () => {
                    const email = forgotEmailInput.value.trim();
                    if (!email || !email.includes('@')) { alert('Please enter a valid email address.'); return; }
                    alert(`Password reset link sent to ${email} (simulated).`);
                    closeForgot();
                });
            }
        }
    })();

    // ----------------------
    // Sidebar page switching
    // ----------------------
    document.querySelectorAll('[data-page]').forEach(btn => {
      btn.addEventListener('click', () => {
        const page = btn.getAttribute('data-page');
        // hide all sections
        document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
        const target = document.getElementById('page-' + page);
        if (target) target.classList.remove('hidden');

        // Auto-collapse sidebar on mobile when a menu item is clicked
        if (window.innerWidth < 1024) {
          document.getElementById('sidebar').classList.remove('translate-x-0');
        }
      });
    });

    // ----------------------
    // Chart
    // ----------------------
    (function setupChartAnimation() {
        const chartCanvas = document.getElementById('contribChart');
        if (!chartCanvas) return;

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // Call the render function when the chart is visible
                    renderContribChart();
                    // Stop observing once the chart is rendered
                    observer.unobserve(entry.target);
                }
            });
        }, {
            threshold: 0.1 // Trigger when 10% of the chart is visible
        });

        observer.observe(chartCanvas);
    })();

    let contribChartInstance = null;

    function renderContribChart() {
      const ctx = document.getElementById('contribChart').getContext('2d');
      
      // 1. Aggregate Real Data
      const contributions = read(DB_KEYS.contributions);
      const currentYear = new Date().getFullYear();
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      
      const regularData = new Array(12).fill(0);
      const capitalData = new Array(12).fill(0);
      const totalData = new Array(12).fill(0);
      let hasRealData = false;

      contributions.forEach(c => {
          const d = new Date(c.date);
          if (d.getFullYear() === currentYear) {
              const m = d.getMonth();
              const r = Number(c.regular)||0;
              const cap = Number(c.capital)||0;
              regularData[m] += r;
              capitalData[m] += cap;
              totalData[m] += (r + cap);
              hasRealData = true;
          }
      });

      // Fallback to demo data if empty
      const displayRegular = hasRealData ? regularData : [12500,13200,14100,13800,15200,14800,16000,15500,16200,17000,16800,17500];
      const displayCapital = hasRealData ? capitalData : [8200,9100,7800,10200,11500,9800,10500,11200,10700,12000,9900,11500];
      const displayTotal = hasRealData ? totalData : [20700,22300,21900,24000,26700,24600,26500,26700,26900,29000,26700,29000];

      // 2. Calculate Forecast (Simple Moving Average of last 3 months)
      const lastMonthIndex = hasRealData ? Math.min(new Date().getMonth(), 11) : 11;
      let sum = 0, count = 0;
      for (let i = Math.max(0, lastMonthIndex - 2); i <= lastMonthIndex; i++) { sum += displayTotal[i]; count++; }
      const average = count > 0 ? sum / count : 0;

      const forecastData = new Array(15).fill(null);
      forecastData[lastMonthIndex] = displayTotal[lastMonthIndex]; // Connect line
      for (let i = 1; i <= 3; i++) { forecastData[lastMonthIndex + i] = average * (1 + (i * 0.02)); } // +2% growth projection

      const extendedLabels = [...months, 'Jan (Next)', 'Feb (Next)', 'Mar (Next)'];

      if (contribChartInstance) contribChartInstance.destroy();

      contribChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: extendedLabels,
          datasets: [
            { label: 'Regular', data: displayRegular, backgroundColor: 'rgba(139,92,246,0.8)', order: 2 },
            { label: 'Capital', data: displayCapital, backgroundColor: 'rgba(236,72,153,0.8)', order: 3 },
            { type: 'line', label: 'Total', data: displayTotal, borderColor: 'rgba(16,185,129,1)', borderWidth: 3, fill: false, tension: 0.3, order: 1 },
            { type: 'line', label: 'Forecast', data: forecastData, borderColor: 'rgba(250, 204, 21, 1)', borderWidth: 3, borderDash: [5, 5], fill: false, tension: 0.3, pointStyle: 'circle', pointRadius: 5, order: 0 }
          ]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: '#cbd5e1' } },
                tooltip: { callbacks: { label: (c) => (c.dataset.label + ': $' + (c.parsed.y || 0).toLocaleString()) } }
            },
            scales: {
                y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } },
                x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
            }
        }
      });
    }

    // ----------------------
    // Chat
    // ----------------------
    const chatList = document.getElementById('chatListPage');
    const chatInput = document.getElementById('chatInputPage');
    const sendMsg = document.getElementById('sendMsgPage');

    const initialMsgs = [
      { user: 'Margie', text: 'Good morning! Contributions are looking strong this week.', time: '09:15' },
      { user: 'Mabel', text: 'Amen! Just recorded the Sunday offerings.', time: '09:17' }
    ];

    function loadInitialChat() {
      if (chatList) chatList.innerHTML = '';
      initialMsgs.forEach(m => addChatMessage(m.user, m.text, m.time));
    }

    function addChatMessage(user, text, time) {
      const el = document.createElement('div');
      el.className = (user === 'You') ? 'flex justify-end' : 'flex justify-start';
      el.innerHTML = `<div class=\"max-w-xs ${user==='You'? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white' : 'bg-slate-700 text-white'} rounded-2xl px-4 py-3\"><div class=\"font-semibold text-sm\">${user}</div><div class=\"text-sm\">${text}</div><div class=\"text-xs mt-1 text-gray-300\">${time || ''}</div></div>`;
      if (chatList) {
        chatList.appendChild(el);
        chatList.scrollTop = chatList.scrollHeight;
      }
    }

    if (sendMsg) {
      sendMsg.addEventListener('click', () => {
        const text = chatInput.value.trim();
        if (!text) return;
        const now = new Date();
        const time = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        addChatMessage('You', text, time);
        chatInput.value = '';
      });
    }

    // ----------------------
    // Floating bot
    // ----------------------
    const openBot = document.getElementById('openBot');
    const botWindow = document.getElementById('botWindow');
    const closeBot = document.getElementById('closeBot');
    const minimizeBot = document.getElementById('minimizeBot');

    if (openBot && botWindow && closeBot) {
        // Clicking the icon toggles the window's visibility
        openBot.addEventListener('click', () => {
            botWindow.classList.toggle('hidden');
            if (!botWindow.classList.contains('hidden')) {
                botWindow.style.height = '24rem';
                if (minimizeBot) minimizeBot.textContent = '_';
            }
        });
        // The close button inside the window always hides it
        closeBot.addEventListener('click', () => botWindow.classList.add('hidden'));

        if (minimizeBot) {
            minimizeBot.addEventListener('click', (e) => {
                e.stopPropagation();
                if (botWindow.style.height === '3.5rem') {
                    botWindow.style.height = '24rem';
                    minimizeBot.textContent = '_';
                } else {
                    botWindow.style.height = '3.5rem';
                    minimizeBot.textContent = 'â–¡';
                }
            });
        }
    }

    // Draggable chatbot
    (function makeDraggable() {
      const container = document.getElementById('chatbotContainer');
      const header = document.getElementById('botHeader');
      if (!container || !header) return;

      let isDragging = false;
      let offsetX, offsetY;

      header.addEventListener('mousedown', (e) => {
        isDragging = true;
        // Calculate offset from the top-left of the element
        offsetX = e.clientX - container.offsetLeft;
        offsetY = e.clientY - container.offsetTop;

        // Remove bottom/right positioning to use top/left
        container.style.right = 'auto';
        container.style.bottom = 'auto';
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        // Prevent text selection while dragging
        e.preventDefault();

        container.style.left = `${e.clientX - offsetX}px`;
        container.style.top = `${e.clientY - offsetY}px`;
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
      });

      // Touch events for mobile dragging
      header.addEventListener('touchstart', (e) => {
        isDragging = true;
        const touch = e.touches[0];
        offsetX = touch.clientX - container.offsetLeft;
        offsetY = touch.clientY - container.offsetTop;
        container.style.right = 'auto';
        container.style.bottom = 'auto';
      }, { passive: false });

      document.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        e.preventDefault(); // Prevent scrolling
        const touch = e.touches[0];
        container.style.left = `${touch.clientX - offsetX}px`;
        container.style.top = `${touch.clientY - offsetY}px`;
      }, { passive: false });

      document.addEventListener('touchend', () => {
        isDragging = false;
      });
    })();

    // Chatbot send handling (floating bot)
    (function setupBotSend(){
      if (!botWindow) return;
      const messages = botWindow.querySelector('.p-3.h-48') || botWindow.querySelector('[class*="overflow-y"]');
      const input = document.getElementById('botInput');
      const send = document.getElementById('botSend');
      if (!input || !send || !messages) return;
      
      function appendMessage(text, fromUser=true){
        const el = document.createElement('div');
        el.className = fromUser
          ? 'p-2 my-1 rounded bg-gradient-to-r from-purple-600 to-pink-600 text-white max-w-xs ml-auto'
          : 'p-2 my-1 rounded bg-slate-700 text-white max-w-xs';
        el.innerHTML = text; // Use innerHTML to allow for formatted responses
        messages.appendChild(el);
        messages.scrollTop = messages.scrollHeight;
      }

      // --- Gemini Integration Simulation ---

      // 1. Navigation Helper
      function navigateTo(page) {
        const btn = document.querySelector(`[data-page="${page}"]`);
        if (btn) {
          btn.click();
          return true;
        }
        // Special case for dashboard which might not have a button but is the default
        if (page === 'dashboard') {
            document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
            const target = document.getElementById('page-dashboard');
            if (target) target.classList.remove('hidden');
            return true;
        }
        return false;
      }

      // 2. Bible Verse Fetcher
      async function fetchBibleVerse(reference) {
        appendMessage('Fetching verse...', false);
        try {
          const response = await fetch(`https://bible-api.com/${encodeURIComponent(reference)}`);
          if (!response.ok) throw new Error('Verse not found.');
          const data = await response.json();
          // Format the response nicely
          const verseText = `<strong>${data.reference}</strong><br>${data.text}`;
          appendMessage(verseText, false);
          // Also navigate to the bible page and load it in the iframe
          navigateTo('bible');
          const refInput = document.getElementById('bibleRef');
          const lookupBtn = document.getElementById('bibleLookup');
          if(refInput) refInput.value = reference;
          if(lookupBtn) lookupBtn.click();
        } catch (error) {
          appendMessage(`Sorry, I couldn't find the verse "${reference}". Please check the reference.`, false);
        }
      }

      // New: Audio Bible Helper
      function openAudioBible(reference) {
        // Use a service like BibleGateway that has audio versions (e.g., NIV, KJV, GNB)
        // We'll use the GNB version to be consistent with the iframe viewer.
        const url = `https://www.biblegateway.com/passage/?search=${encodeURIComponent(reference)}&version=GNB`;
        window.open(url, '_blank');
        appendMessage(`Opening audio for <strong>${reference}</strong> in a new tab.`, false);
      }


      // 4. Data Query Helper
      function getSummary() {
        try {
            const totalContrib = read(DB_KEYS.contributions).reduce((s,c)=>s+Number(c.regular||0)+Number(c.capital||0),0);
            const households = read(DB_KEYS.households).length;
            const upcoming = read(DB_KEYS.ceremonies).filter(c=> new Date(c.date) > new Date()).length;
            const pledges = read(DB_KEYS.pledges);
            const totalPledged = pledges.reduce((s,p)=>s + (p.original||0),0);
            const totalRemaining = pledges.reduce((s,p)=>s + (p.remaining||0),0);
            const pledgeProgress = totalPledged > 0 ? Math.round((1 - (totalRemaining / totalPledged)) * 100) : 0;

            return `Here's a quick summary:<br>
- <strong>Total Contributions:</strong> $${totalContrib.toLocaleString()}<br>
- <strong>Active Households:</strong> ${households}<br>
- <strong>Upcoming Ceremonies:</strong> ${upcoming}<br>
- <strong>Pledge Progress:</strong> ${pledgeProgress}%`;
        } catch(e) { return "Sorry, I couldn't retrieve the summary data."; }
      }
      // 3. Command Processor
      async function processCommand(command) {
        const lowerCmd = command.toLowerCase();
        const navMapping = {
          'dashboard': 'dashboard', 'home': 'dashboard', 'main': 'dashboard',
          'contributions': 'contributions', 'offering': 'contributions',
          'households': 'households', 'members': 'households',
          'ceremonies': 'ceremonies', 'wedding': 'ceremonies', 'baptism': 'ceremonies',
          'bible': 'bible', 'scripture': 'bible',
          'chat': 'chatroom', 'community': 'chatroom',
          'reports': 'reports', 'tax': 'reports'
        };
        const navMatch = Object.keys(navMapping).find(key => lowerCmd.includes(key));
        if (navMatch) {
          const page = navMapping[navMatch];
          if (navigateTo(page)) {
            appendMessage(`Navigating to ${page.charAt(0).toUpperCase() + page.slice(1)}.`, false);
          }
        } else if (lowerCmd.startsWith('get') || lowerCmd.startsWith('find') || lowerCmd.match(/\w+\s\d+:\d+/)) {
          const reference = command.replace(/^(get|find)\s*/i, '');
          await fetchBibleVerse(reference);
        } else if (lowerCmd.startsWith('listen to') || lowerCmd.startsWith('play') || lowerCmd.startsWith('audio for')) {
            const reference = command.replace(/^(listen to|play|audio for)\s*/i, '');
            openAudioBible(reference);
        } else if (lowerCmd.includes('summary') || lowerCmd.includes('overview')) {
            appendMessage(getSummary(), false);
        } else if (lowerCmd.startsWith('find household')) {
            const query = command.substring('find household'.length).trim().replace(/"/g, '');
            if (!query) {
                appendMessage("Please specify a household name or ID to find.", false);
            } else {
                const household = findHousehold(query);
                if (household) {
                    appendMessage(`Found household: <strong>${household.head}</strong> (Envelope: ${household.envelope || 'N/A'}). You can ask for a "summary for ${household.head}" to see more details.`, false);
                } else {
                    appendMessage(`Sorry, I couldn't find a household matching "${query}".`, false);
                }
            }
        } else if (lowerCmd.startsWith('find member')) {
            const query = command.substring('find member'.length).trim().replace(/"/g, '');
            if (!query) {
                appendMessage("Please specify a member's name to find.", false);
            } else {
                const household = findHousehold(query);
                if (household) {
                    const member = household.members?.find(m => m.name.toLowerCase().includes(query.toLowerCase())) || { name: household.head };
                    appendMessage(`Found member <strong>${member.name}</strong> in the <strong>${household.head}</strong> household. You can ask for a "summary for ${household.head}" to see more details.`, false);
                } else {
                    appendMessage(`Sorry, I couldn't find a household matching "${query}".`, false);
                }
            }
        } else if (lowerCmd.startsWith('find phone') || lowerCmd.startsWith('get phone') || lowerCmd.startsWith('phone for')) {
            const query = command.replace(/^(find phone|get phone|phone for)\s*/i, '').trim().replace(/"/g, '');
            if (!query) {
                appendMessage("Please specify a member's name to find their phone number.", false);
            } else {
                const household = findHousehold(query);
                if (household && household.phone) {
                    appendMessage(`The phone number for <strong>${household.head}</strong> is: <strong>${household.phone}</strong>`, false);
                } else if (household) {
                    appendMessage(`I found the household for <strong>${household.head}</strong>, but there is no phone number on file.`, false);
                } else {
                    appendMessage(`Sorry, I couldn't find a member or household matching "${query}".`, false);
                }
            }
        } else if (lowerCmd.startsWith('create household')) {
            const str = command.substring('create household'.length).trim();
            // Regex to capture name (in quotes or not) and optional envelope
            const match = str.match(/^(?:")?([^"]+?)(?:")?(?:\s+with\s+envelope\s+(.+))?$/i);
            if (!match || !match[1]) {
                appendMessage("I couldn't understand that. Please use the format: `create household \"Household Name\" with envelope ENV123`.", false);
            } else {
                const head = match[1].trim();
                const env = match[2] ? match[2].trim() : null;
                const hs = read(DB_KEYS.households);
                const id = hs.length ? Math.max(...hs.map(x=>x.id)) + 1 : 1;
                const newHousehold = { id, head, envelope: env };
                hs.push(newHousehold);
                write(DB_KEYS.households, hs);
                renderHouseList(); // Update the UI list
                updateDashboardSummary(); // Update dashboard stats
                appendMessage(`Successfully created household for <strong>${head}</strong> (Envelope: ${env || 'N/A'}).`, false);
            }
        } else if (lowerCmd.startsWith('record contribution')) {
            const parts = command.substring('record contribution'.length).trim().split(' ');
            if (parts.length < 3) {
                appendMessage("I couldn't understand that. Please use the format: `record contribution \"Household Name\" 100 50` (Name, Regular, Capital).", false);
            } else {
                const householdName = parts[0].replace(/"/g, ''); // Remove quotes
                const regularAmount = parseFloat(parts[1]);
                const capitalAmount = parseFloat(parts[2]);

                if (isNaN(regularAmount) || isNaN(capitalAmount)) {
                    appendMessage("Please provide valid numeric amounts for regular and capital contributions.", false);
                } else {
                    const household = findHousehold(householdName);
                    if (household) {
                        const payload = {
                            householdId: household.id,
                            envelope: household.envelope,
                            regular: regularAmount,
                            capital: capitalAmount,
                            date: new Date().toISOString()
                        };
                        // Save contribution (using local storage for this example)
                        const contributions = read(DB_KEYS.contributions);
                        contributions.push(payload);
                        write(DB_KEYS.contributions, contributions);
                        updateDashboardSummary();
                        appendMessage(`Recorded contribution for <strong>${household.head}</strong>: Regular $${regularAmount}, Capital $${capitalAmount}.`, false);
                    } else {
                        appendMessage(`Could not find household "${householdName}".`, false);
                    }
                }
            }
        } else if (lowerCmd.startsWith('summary for') || lowerCmd.startsWith('report for')) {
            const query = command.replace(/^(summary for|report for)\s*/i, '').trim().replace(/"/g, '');
            if (!query) {
                appendMessage("Please specify a household name. e.g., `summary for \"The Millers\"`", false);
            } else {
                const household = findHousehold(query);
                if (household) {
                    const contributions = read(DB_KEYS.contributions).filter(c => c.householdId === household.id);
                    const totalRegular = contributions.reduce((s, c) => s + (Number(c.regular) || 0), 0);
                    const totalCapital = contributions.reduce((s, c) => s + (Number(c.capital) || 0), 0);
                    const totalGiven = totalRegular + totalCapital;

                    const memberSummary = (household.members && household.members.length > 0)
                        ? `<strong>Family Members:</strong><br>${household.members.map(m => `- ${m.name} (${m.role})`).join('<br>')}`
                        : 'No other family members listed.';

                    const pledge = findPledgeForHousehold(household.id);
                    const pledgeSummary = pledge ? `Pledged: $${(pledge.original || 0).toLocaleString()}, Remaining: $${(pledge.remaining || 0).toLocaleString()}` : 'No active pledge.';

                    const recent = contributions.slice(-3).reverse().map(c => `- ${new Date(c.date).toLocaleDateString()}: Reg $${c.regular || 0}, Cap $${c.capital || 0}`).join('<br>');
                    const recentSummary = recent ? `<strong>Recent Contributions:</strong><br>${recent}` : 'No recent contributions.';

                    const report = `<strong>Summary for ${household.head}</strong> (Env: ${household.envelope})<br>
<hr class="my-2 border-slate-600">
<strong>Contact & Status:</strong><br>
- Phone: ${household.phone || 'N/A'}<br>
- Address: ${household.address || 'N/A'}<br>
- Status: ${household.status ? household.status.charAt(0).toUpperCase() + household.status.slice(1) : 'N/A'} (Membership Class: ${household.membershipClass ? 'Yes' : 'No'})<br>
<hr class="my-2 border-slate-600">
${memberSummary}<br>
<hr class="my-2 border-slate-600">
<strong>Financial Overview:</strong><br>
- Total Given: $${totalGiven.toLocaleString()} ($${totalRegular.toLocaleString()} Regular, $${totalCapital.toLocaleString()} Capital)<br>
- Pledge Status: ${pledgeSummary}<br><br>
${recentSummary}`;
                    appendMessage(report, false);
                } else {
                    appendMessage(`Sorry, I couldn't find a household matching "${query}".`, false);
                }
            }
        } else if (lowerCmd.startsWith('delete household')) {
            const query = command.substring('delete household'.length).trim().replace(/"/g, '');
            if (!query) {
                appendMessage("Please specify a household to delete, e.g., `delete household \"The Millers\"`.", false);
            } else {
                const household = findHousehold(query);
                if (household) {
                    if (confirm(`Are you sure you want to delete the household "${household.head}"? This will also remove all associated contributions and pledges.`)) {
                        // Filter out the household, its pledges, and its contributions
                        const households = read(DB_KEYS.households).filter(h => h.id !== household.id);
                        const pledges = read(DB_KEYS.pledges).filter(p => p.householdId !== household.id);
                        const contributions = read(DB_KEYS.contributions).filter(c => c.householdId !== household.id);

                        write(DB_KEYS.households, households);
                        write(DB_KEYS.pledges, pledges);
                        write(DB_KEYS.contributions, contributions);

                        renderHouseList();
                        updateDashboardSummary();
                        appendMessage(`Household "${household.head}" and all associated records have been deleted.`, false);
                    } else {
                        appendMessage("Deletion cancelled.", false);
                    }
                } else {
                    appendMessage(`Sorry, I couldn't find a household matching "${query}" to delete.`, false);
                }
            }
        } else if (lowerCmd.startsWith('edit household')) {
            const editRegex = /edit household "([^"]+)" set (phone|address|status) to (.*)/i;
            const match = command.match(editRegex);

            if (!match) {
                appendMessage("I couldn't understand that. Use: `edit household \"Name\" set phone to \"new number\"`.", false);
                return;
            }

            const householdName = match[1];
            const field = match[2].toLowerCase();
            const value = match[3].trim().replace(/^"|"$/g, ''); // Trim and remove surrounding quotes

            const households = read(DB_KEYS.households);
            const householdToEdit = households.find(h => h.head.toLowerCase().includes(householdName.toLowerCase()));

            if (householdToEdit) {
                householdToEdit[field] = value;
                write(DB_KEYS.households, households);
                renderHouseList(); // Refresh the list on the households page
                updateDashboardSummary(); // Refresh dashboard stats
                appendMessage(`Updated <strong>${householdToEdit.head}</strong>'s ${field} to "${value}".`, false);
            } else {
                appendMessage(`Sorry, I couldn't find a household matching "${householdName}" to edit.`, false);
            }
        } else if (lowerCmd.startsWith('add member')) {
            const addMemberRegex = /add member "([^"]+)" with role "([^"]+)" to household "([^"]+)"/i;
            const match = command.match(addMemberRegex);

            if (!match) {
                appendMessage("I couldn't understand that. Use: `add member \"Jane Doe\" with role \"Child\" to household \"John Doe\"`.", false);
                return;
            }

            const memberName = match[1];
            const memberRole = match[2];
            const householdName = match[3];

            const households = read(DB_KEYS.households);
            const householdToUpdate = households.find(h => h.head.toLowerCase().includes(householdName.toLowerCase()));

            if (householdToUpdate) {
                if (!householdToUpdate.members) householdToUpdate.members = []; // Ensure members array exists
                householdToUpdate.members.push({ name: memberName, role: memberRole });
                write(DB_KEYS.households, households);
                renderHouseList(); // Refresh the list on the households page
                appendMessage(`Added <strong>${memberName}</strong> (${memberRole}) to the <strong>${householdToUpdate.head}</strong> household.`, false);
            } else {
                appendMessage(`Sorry, I couldn't find a household matching "${householdName}".`, false);
            }
        } else if (lowerCmd.match(/(generate|show|run) tax report for (\d{4})/)) {
            const year = lowerCmd.match(/(\d{4})/)[0];
            navigateTo('reports');
            document.getElementById('taxYear').value = year;
            document.getElementById('genTax').click();
            appendMessage(`Generating tax report for <strong>${year}</strong>. You can find it on the Reports page.`, false);
        } else if (lowerCmd.match(/(generate|show|run) pledge report/)) {
            navigateTo('reports');
            document.getElementById('genPledgeReport').click();
            appendMessage("Generating the Pledge Status report now. It's available on the Reports page.", false);
        } else if (lowerCmd.match(/(generate|show|run) inactive members report/)) {
            navigateTo('reports');
            document.getElementById('genInactiveReport').click();
            appendMessage("Generating the Inactive Members report. Please see the Reports page.", false);
        } else if (lowerCmd.match(/(generate|show|run) ceremony report/)) {
            const dateRegex = /from ([\d]{4}-[\d]{2}-[\d]{2}) to ([\d]{4}-[\d]{2}-[\d]{2})/;
            const match = lowerCmd.match(dateRegex);
            if (match) {
                const startDate = match[1];
                const endDate = match[2];
                navigateTo('reports');
                document.getElementById('ceremonyStartDate').value = startDate;
                document.getElementById('ceremonyEndDate').value = endDate;
                document.getElementById('genCeremonyReport').click();
                appendMessage(`Generating ceremony report from <strong>${startDate}</strong> to <strong>${endDate}</strong>.`, false);
            } else {
                // If no dates, generate for the current year as a default
                navigateTo('reports');
                const year = new Date().getFullYear();
                document.getElementById('ceremonyStartDate').value = `${year}-01-01`;
                document.getElementById('ceremonyEndDate').value = `${year}-12-31`;
                document.getElementById('genCeremonyReport').click();
                appendMessage(`Generating ceremony report for the current year (${year}). You can specify dates with '...from YYYY-MM-DD to YYYY-MM-DD'.`, false);
            }
        } else if (lowerCmd.startsWith('schedule')) {
            const scheduleRegex = /schedule (baptism|wedding|funeral|confirmation) for "([^"]+)" on ([\d]{4}-[\d]{2}-[\d]{2})/i;
            const match = command.match(scheduleRegex);

            if (!match) {
                appendMessage("I couldn't understand that. Use: `schedule baptism for \"Full Name\" on YYYY-MM-DD`.", false);
                return;
            }

            const type = match[1].toLowerCase();
            const nameOrNames = match[2];
            const date = match[3];

            const newCeremony = { id: Date.now(), type, date, notes: 'Scheduled via chatbot' };

            if (type === 'wedding') {
                const names = nameOrNames.split(/&|and/i).map(n => n.trim());
                newCeremony.personA = names[0] || 'Person A';
                newCeremony.personB = names[1] || 'Person B';
            } else {
                newCeremony.name = nameOrNames;
            }

            const ceremonies = read(DB_KEYS.ceremonies);
            ceremonies.push(newCeremony);
            write(DB_KEYS.ceremonies, ceremonies);

            renderCeremoniesList();
            initializeCeremonyCalendar();
            appendMessage(`Successfully scheduled a <strong>${type}</strong> for <strong>${nameOrNames}</strong> on <strong>${date}</strong>.`, false);
        } else {
          appendMessage("I can help you with a few things! Try:<br>- 'go to contributions'<br>- 'get John 3:16'<br>- 'find member Mabel'<br>- 'generate tax report for 2024'<br>- 'show summary'<br>- 'create household \"The Millers\"'", false);
          appendMessage("I can help you with a few things! Try:<br>- 'go to contributions'<br>- 'get John 3:16'<br>- 'schedule baptism for \"Jane Doe\" on 2025-12-25'<br>- 'generate tax report for 2024'<br>- 'show summary'<br>- 'create household \"The Millers\"'", false);
        }
      }


      async function sendMsg(){

        const txt = input.value.trim();
        if (!txt) return;
        appendMessage(txt, true);
        input.value = '';
        await processCommand(txt);
      }


      send.addEventListener('click', sendMsg);
      input.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); sendMsg(); } });
    })();

    // ----------------------
    // Misc toggles
    // ----------------------
    const toggleDark = document.getElementById('toggleDark');
    (function setupDarkModeToggle() {
        const sunIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        const moonIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

        toggleDark.addEventListener('click', () => {
            document.body.classList.toggle('bg-white');
            document.body.classList.toggle('text-black');
            document.body.classList.toggle('bg-gradient-to-br');

            const isLightMode = document.body.classList.contains('bg-white');
            toggleDark.innerHTML = isLightMode ? sunIcon : moonIcon;
        });
    })();

    const toggleSidebar = document.getElementById('toggleSidebar');
    toggleSidebar.addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('translate-x-0');
    });

    // Collapsible sidebar (icons + labels)
    (function setupSidebarCollapse(){
      const sidebar = document.getElementById('sidebar');
      const btn = document.getElementById('collapseSidebarBtn');
      if (!sidebar || !btn) return;
      const KEY = 'abc_sidebar_collapsed';
      function setCollapsed(state){
        if (state) { sidebar.classList.add('collapsed'); btn.querySelector('.icon').textContent = 'Â»'; }
        else { sidebar.classList.remove('collapsed'); btn.querySelector('.icon').textContent = 'â–'; }
        try { localStorage.setItem(KEY, state ? '1' : '0'); } catch(e){}
      }
      // initialize from localStorage
      try{ const v = localStorage.getItem(KEY); setCollapsed(v === '1'); } catch(e){ setCollapsed(false); }
      btn.addEventListener('click', ()=> setCollapsed(!sidebar.classList.contains('collapsed')));
    })();

    // Sign out handling: clear stored credentials and return to auth page
    const signOutBtn = document.getElementById('signOutBtn');
    if (signOutBtn) {
      signOutBtn.addEventListener('click', () => {
        if (confirm('Even Jesus took time to restâ€¦ you too deserve a break. Nyikuli blesses your logout ðŸ˜‡âœŒï¸ðŸ˜Œ')) {
          localStorage.removeItem('abc_credentials');
          // do not remove api_base so user can reconnect easily
          dashboard.classList.add('hidden');
          authPage.classList.remove('hidden');
          // clear some fields
          document.getElementById('email').value = '';
          document.getElementById('password').value = '';

          // Reset sign-in button state
          authSubmit.disabled = false;
          authSubmit.querySelector('.spinner').classList.add('hidden');
        }
      });
    }

    // small animation class used earlier (define at runtime to avoid tailwind config)
    (function addAnimationStyles(){
      const s = document.createElement('style');
      s.textContent = `@keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}.animate-fade{animation:fadeInUp .5s ease-out}`;
      document.head.appendChild(s);
      document.querySelectorAll('.animate-fade').forEach(el=>el.classList.add('animate-fade'));
    })();
    
    // Add spinner animation styles
    (function addSpinnerStyles() {
        const s = document.createElement('style');
        s.textContent = `@keyframes spin { to { transform: rotate(360deg); } } .spinner { animation: spin 1s linear infinite; }`;
        document.head.appendChild(s);
    })();

    // API base and helper (attempt server calls, fallback to localStorage)
    function getAuthHeader(){ const c = localStorage.getItem('abc_credentials'); return c ? { Authorization: 'Basic ' + c } : {}; }
    async function apiFetch(path, opts = {}){
      const url = API_BASE + path;
      opts.headers = Object.assign({}, opts.headers||{}, getAuthHeader(), { 'Content-Type': 'application/json' });
      try{
        const res = await fetch(url, opts);
        if (!res.ok) throw new Error('API error');
        return await res.json();
      } catch(e){
        // bubble up so callers can fallback
        throw e;
      }
    }

    function genEnvelope(){
        const hs = read(DB_KEYS.households);
        // Find the highest numeric part of existing envelope IDs to avoid collisions.
        const maxId = hs.reduce((max, h) => Math.max(max, parseInt(String(h.envelope).replace(/\D/g, ''), 10) || 0), 0);
        return 'ENV' + String(maxId + 1).padStart(4, '0');
    }

    function findHousehold(q){
      if (!q) return null;
      q = q.trim().toLowerCase();
      const hs = read(DB_KEYS.households);
      // First, try to find by envelope ID (exact match) or head of household (includes match)
      let household = hs.find(h => (h.envelope && h.envelope.toLowerCase() === q) || (h.head && h.head.toLowerCase().includes(q)));
      if (household) return household;

      // If not found, search within family members
      for (const h of hs) {
          if (h.members && h.members.some(m => m.name.toLowerCase().includes(q))) {
              return h; // Return the household if a member's name matches
          }
      }
      return null;
    }

    function findPledgeForHousehold(id){
      return read(DB_KEYS.pledges).find(p=>p.householdId===id) || null;
    }

    function renderHouseList(filter = ''){
      const el = document.getElementById('houseList');
      let hs = read(DB_KEYS.households);

      if (filter) {
        const lowerFilter = filter.toLowerCase();
        hs = hs.filter(h =>
            (h.head && h.head.toLowerCase().includes(lowerFilter)) ||
            (h.envelope && h.envelope.toLowerCase().includes(lowerFilter))
        );
      }

      el.innerHTML = hs.map(h=>`
        <div class="flex justify-between items-center py-1 border-b border-slate-800">
          <div>
            <div>
              <span>${h.envelope || ''} â€” <strong>${h.head}</strong></span>
              <span class="text-xs ml-2 px-2 py-0.5 rounded-full ${
                  h.status === 'active' ? 'bg-green-500/20 text-green-300' :
                  h.status === 'inactive' ? 'bg-red-500/20 text-red-300' :
                  'bg-blue-500/20 text-blue-300'
              }">${h.status ? h.status.charAt(0).toUpperCase() + h.status.slice(1) : 'N/A'}</span>
            </div>
            <div class="text-xs text-gray-400 mt-1">${(h.members || []).length} other member(s)</div>
          </div>
          <div class="flex-shrink-0">
            <button data-id="${h.id}" class="edit-household-btn text-blue-400 hover:text-blue-300 text-xs px-2 py-1 rounded">Edit</button>
            <button data-id="${h.id}" class="delete-household-btn text-red-500 hover:text-red-400 text-xs px-2 py-1 rounded">Delete</button>
          </div>
        </div>
      `).join('') || '<div class="text-gray-500">No households found.</div>';
    }
    renderHouseList();

    // Household deletion
    const householdFormTitle = document.getElementById('householdFormTitle');
    const householdIdField = document.getElementById('householdIdField');
    const houseCreateBtn = document.getElementById('houseCreate');
    const cancelEditBtn = document.getElementById('cancelEditHousehold');
    const addFamilyMemberBtn = document.getElementById('addFamilyMemberBtn');
    const familyMembersListEl = document.getElementById('familyMembersList');
    let tempFamilyMembers = []; // To hold members before saving
    const houseListEl = document.getElementById('houseList');
    if (houseListEl) {
        houseListEl.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-household-btn')) {
                const householdId = parseInt(e.target.getAttribute('data-id'), 10);
                const households = read(DB_KEYS.households);
                const household = households.find(h => h.id === householdId);
                if (household) loadHouseholdIntoForm(household);
            }

            if (e.target.classList.contains('delete-household-btn')) {
                const householdId = parseInt(e.target.getAttribute('data-id'), 10);
                const household = read(DB_KEYS.households).find(h => h.id === householdId);
                if (household && confirm(`Are you sure you want to delete "${household.head}"? This will remove all associated contributions and pledges.`)) {
                    // Filter out the household and its related data
                    write(DB_KEYS.households, read(DB_KEYS.households).filter(h => h.id !== householdId));
                    write(DB_KEYS.pledges, read(DB_KEYS.pledges).filter(p => p.householdId !== householdId));
                    write(DB_KEYS.contributions, read(DB_KEYS.contributions).filter(c => c.householdId !== householdId));

                    // Refresh UI
                    renderHouseList(document.getElementById('houseSearch').value);
                    updateDashboardSummary();
                    renderRecentContributions(); // Refresh recent contributions list
                }
            }
        });
    }

    function renderTempFamilyMembers() {
        familyMembersListEl.innerHTML = tempFamilyMembers.map((member, index) => `
            <div class="flex justify-between items-center p-2 rounded-lg bg-slate-800/50 text-sm">
                <span><strong>${member.name}</strong> (${member.role})</span>
                <button type="button" data-index="${index}" class="remove-member-btn text-red-500 hover:text-red-400 font-bold text-lg">&times;</button>
            </div>
        `).join('');
    }

    addFamilyMemberBtn.addEventListener('click', () => {
        const nameInput = document.getElementById('newMemberName');
        const roleInput = document.getElementById('newMemberRole');
        const name = nameInput.value.trim();
        const role = roleInput.value;

        if (!name) { alert('Please enter a name for the family member.'); return; }

        tempFamilyMembers.push({ name, role });
        renderTempFamilyMembers();
        nameInput.value = '';
    });

    function resetHouseholdForm() {
        householdFormTitle.textContent = 'Register Household';
        houseCreateBtn.textContent = 'Create Household';
        cancelEditBtn.classList.add('hidden');

        householdIdField.value = '';
        document.getElementById('houseHead').value = '';
        document.getElementById('houseAddress').value = '';
        document.getElementById('housePhone').value = '';
        document.getElementById('houseEnvelope').value = '';
        document.getElementById('membershipStatus').value = 'active';
        document.getElementById('membershipClass').checked = false;
        
        const pledgeCheckbox = document.getElementById('addPledgeCheckbox');
        const pledgeFields = document.getElementById('pledgeFields');
        pledgeCheckbox.checked = false;
        pledgeFields.classList.add('hidden');
        document.getElementById('pledgeAmount').value = '';
        document.getElementById('pledgeStartDate').value = '';

        tempFamilyMembers = [];
        renderTempFamilyMembers();
    }

    function loadHouseholdIntoForm(household) {
        householdFormTitle.textContent = `Editing: ${household.head}`;
        houseCreateBtn.textContent = 'Update Household';
        cancelEditBtn.classList.remove('hidden');

        householdIdField.value = household.id;
        document.getElementById('houseHead').value = household.head || '';
        document.getElementById('houseAddress').value = household.address || '';
        document.getElementById('housePhone').value = household.phone || '';
        document.getElementById('houseEnvelope').value = household.envelope || '';
        document.getElementById('membershipStatus').value = household.status || 'active';
        document.getElementById('membershipClass').checked = household.membershipClass || false;

        const pledge = findPledgeForHousehold(household.id);
        const pledgeCheckbox = document.getElementById('addPledgeCheckbox');
        pledgeCheckbox.checked = !!pledge;
        pledgeCheckbox.dispatchEvent(new Event('change')); // Trigger visibility
        if(pledge) {
            document.getElementById('pledgeAmount').value = pledge.original;
            document.getElementById('pledgeStartDate').value = pledge.start;
        }

        tempFamilyMembers = household.members ? [...household.members] : [];
        renderTempFamilyMembers();
    }

    // Household search/filter
    const houseSearchInput = document.getElementById('houseSearch');
    if (houseSearchInput) {
        houseSearchInput.addEventListener('input', () => renderHouseList(houseSearchInput.value));
    }

    // Auto-Format Phone Numbers
    (function setupPhoneFormatting() {
      const inputs = ['signupPhone', 'housePhone', 'mpesaPhone'];
      inputs.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        // Remove maxlength to allow formatting spaces
        el.removeAttribute('maxlength'); 
        el.addEventListener('input', (e) => {
          let raw = e.target.value.replace(/[^0-9+]/g, '');
          
          // Enforce limits based on format prefix
          if (raw.startsWith('+254')) raw = raw.substring(0, 13);
          else if (raw.startsWith('0')) raw = raw.substring(0, 10);
          else raw = raw.substring(0, 13); // Fallback limit

          let formatted = raw;
          if (raw.startsWith('0')) { // 07XX XXX XXX
             const p1 = raw.substring(0,4);
             const p2 = raw.substring(4,7);
             const p3 = raw.substring(7,10);
             formatted = p1 + (p2 ? ' ' + p2 : '') + (p3 ? ' ' + p3 : '');
          } else if (raw.startsWith('254') || raw.startsWith('+254')) { // +254 7XX XXX XXX
             if (!raw.startsWith('+')) raw = '+' + raw;
             const p1 = raw.substring(0,4);
             const p2 = raw.substring(4,7);
             const p3 = raw.substring(7,10);
             const p4 = raw.substring(10,13);
             formatted = p1 + (p2 ? ' ' + p2 : '') + (p3 ? ' ' + p3 : '') + (p4 ? ' ' + p4 : '');
          }
          e.target.value = formatted;
        });
      });
    })();

    // Remove family member from temp list
    familyMembersListEl.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-member-btn')) {
            const index = parseInt(e.target.getAttribute('data-index'), 10);
            tempFamilyMembers.splice(index, 1);
            renderTempFamilyMembers();
        }
    });

    // Contributions UI
    const contributionLookup = document.getElementById('contributionLookup');
    const contribHouseInfo = document.getElementById('contribHouseInfo');
    const pledgeInfo = document.getElementById('pledgeInfo');
    let contribSelected = null;

    function renderHouseholdDropdown() {
        if (!contributionLookup) return;
        const households = read(DB_KEYS.households);
        // Sort by name for easier lookup
        households.sort((a, b) => a.head.localeCompare(b.head));
        contributionLookup.innerHTML = '<option value="">Select a household...</option>'; // Reset
        households.forEach(h => {
            const option = document.createElement('option');
            option.value = h.id;
            option.textContent = `${h.head} (${h.envelope || 'No ID'})`;
            contributionLookup.appendChild(option);
        });
    }
    renderHouseholdDropdown(); // Initial population

    contributionLookup.addEventListener('change', () => {
        const householdId = parseInt(contributionLookup.value, 10);
        if (!householdId) {
            contribSelected = null;
            contribHouseInfo.textContent = 'No household selected.';
            pledgeInfo.textContent = 'Pledge: â€”';
            return;
        }

        const households = read(DB_KEYS.households);
        contribSelected = households.find(h => h.id === householdId);

        if (contribSelected) {
            contribHouseInfo.innerHTML = `<div><strong>${contribSelected.head}</strong> â€” <span class="text-sm text-gray-400">${contribSelected.envelope}</span></div>`;
            const p = findPledgeForHousehold(contribSelected.id);
            pledgeInfo.textContent = p ? `Pledge: $${p.original} â€” Remaining: $${p.remaining}` : 'Pledge: None';
        }
    });

    function renderRecentContributions() {
        const listEl = document.getElementById('recentContributionsList');
        if (!listEl) return;

        const contributions = read(DB_KEYS.contributions);
        const households = read(DB_KEYS.households);
        const householdMap = new Map(households.map(h => [h.id, h.head]));

        // Sort by date (newest first) and take the last 10
        const recentContributions = contributions
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .slice(0, 10);

        if (recentContributions.length === 0) {
            listEl.innerHTML = '<div class="text-gray-500">No recent contributions recorded.</div>';
            return;
        }

        listEl.innerHTML = recentContributions.map(c => {
            const householdName = householdMap.get(c.householdId) || 'Unknown Household';
            const totalAmount = (Number(c.regular) || 0) + (Number(c.capital) || 0);
            const contributionDate = new Date(c.date).toLocaleDateString();
            return `
                <div class="flex justify-between items-center py-2 border-b border-slate-800">
                    <div><strong>${householdName}</strong></div>
                    <div class="text-right"><span class="font-semibold text-emerald-400">$${totalAmount.toFixed(2)}</span><div class="text-xs text-gray-500">${contributionDate}</div></div>
                </div>
            `;
        }).join('');
    }
    renderRecentContributions();

    // Print Recent Contributions
    const printBtn = document.getElementById('printRecentContributions');
    if (printBtn) {
        printBtn.addEventListener('click', () => {
            const listContainer = document.getElementById('recentContributionsContainer');
            if (!listContainer) return;

            // Create a temporary container for printing
            let printContainer = document.getElementById('print-container');
            if (!printContainer) {
                printContainer = document.createElement('div');
                printContainer.id = 'print-container';
                document.body.appendChild(printContainer);
            }

            const reportTitle = listContainer.querySelector('h3')?.textContent || 'Recent Contributions';
            const printHeader = `
                <div class="print-header">
                    <h1>${reportTitle}</h1>
                    <p>Generated on: ${new Date().toLocaleDateString()}</p>
                </div>
            `;

            // Clone the list content into the print container
            printContainer.innerHTML = listContainer.innerHTML;
            printContainer.innerHTML = printHeader + listContainer.querySelector('#recentContributionsList').innerHTML;
            // Remove the print button from the cloned content
            printContainer.querySelector('#printRecentContributions')?.remove();

            document.body.classList.add('is-printing');
            window.print();
            document.body.classList.remove('is-printing');
        });
    }

    document.getElementById('contribSubmit').addEventListener('click', ()=>{
      const regular = parseFloat(document.getElementById('regularAmt').value) || 0;
      const capital = parseFloat(document.getElementById('capitalAmt').value) || 0;
      if (!contribSelected) { alert('Select a household first'); return; }
      if (regular <= 0 && capital <= 0) { alert('Enter an amount'); return; }
      const payload = { householdId: contribSelected.id, envelope: contribSelected.envelope, regular, capital, date: new Date().toISOString() };
      // try server save first
      apiFetch('/api/contributions', { method: 'POST', body: JSON.stringify(payload) })
        .then((savedContribution) => {
          alert('Contribution recorded (server)');
          // Also update local data to keep UI consistent
          const contributions = read(DB_KEYS.contributions);
          contributions.push(savedContribution);
          write(DB_KEYS.contributions, contributions);
          const pledges = read(DB_KEYS.pledges);
          const p = pledges.find(x=>x.householdId === contribSelected.id);
          if (p && capital > 0){ p.remaining = Math.max(0, (p.remaining || p.original) - capital); write(DB_KEYS.pledges, pledges); }
          document.getElementById('regularAmt').value = '';
          document.getElementById('capitalAmt').value = '';
          pledgeInfo.textContent = p ? `Pledge: ${p.original} â€” Remaining: ${p.remaining}` : 'Pledge: None';
          updateDashboardSummary();
          renderRecentContributions();
        })
        .catch(()=>{
          // fallback to localStorage
          const contributions = read(DB_KEYS.contributions);
          const now = new Date().toISOString();
          const rec = { id: Date.now(), householdId: contribSelected.id, envelope: contribSelected.envelope, regular, capital, date: now };
          contributions.push(rec);
          write(DB_KEYS.contributions, contributions);
          // update pledge locally
          const pledges = read(DB_KEYS.pledges);
          const p = pledges.find(x=>x.householdId === contribSelected.id);
          if (p && capital > 0){ p.remaining = Math.max(0, (p.remaining || p.original) - capital); write(DB_KEYS.pledges, pledges); }
          document.getElementById('regularAmt').value = '';
          document.getElementById('capitalAmt').value = '';
          contributionLookup.value = '';
          contribHouseInfo.textContent = 'Saved (offline).';
          pledgeInfo.textContent = p ? `Pledge: ${p.original} â€” Remaining: ${p.remaining}` : 'Pledge: None';
          updateDashboardSummary();
          renderRecentContributions();
        });
    });

    // Loose offerings
    function renderLoose(){
      const list = read(DB_KEYS.loose);
      const listEl = document.getElementById('looseList');
      const totalEl = document.getElementById('looseTotal');

      listEl.innerHTML = list.map(l=>`<div class="py-1 flex justify-between"><span>${l.date}</span> <span>$${l.amount.toFixed(2)}</span></div>`).join('') || '<div class="text-gray-500">No records</div>';

      const total = list.reduce((sum, l) => sum + (Number(l.amount) || 0), 0);
      if (totalEl) {
        totalEl.innerHTML = `<div class="flex justify-between"><span>Total:</span><span>$${total.toFixed(2)}</span></div>`;
      }
    }
    renderLoose();
    document.getElementById('looseAdd').addEventListener('click', ()=>{
      const amt = parseFloat(document.getElementById('looseAmount').value) || 0;
      const date = document.getElementById('looseDate').value || new Date().toISOString().slice(0,10);
      if (amt <= 0) { alert('Enter amount'); return; }
      const payload = { amount: amt, date };
      apiFetch('/api/loose', { method: 'POST', body: JSON.stringify(payload) })
        .then(()=>{ document.getElementById('looseAmount').value=''; document.getElementById('looseDate').value=''; renderLoose(); updateDashboardSummary(); })
        .catch(()=>{
          const arr = read(DB_KEYS.loose); arr.push({ id: Date.now(), amount: amt, date }); write(DB_KEYS.loose, arr);
          document.getElementById('looseAmount').value=''; document.getElementById('looseDate').value=''; renderLoose(); updateDashboardSummary();
        });
    });

    // ----------------------
    // M-Pesa Integration Logic
    // ----------------------
    (function setupMpesa(){
      const btn = document.getElementById('btnMpesaPay');
      const phoneInput = document.getElementById('mpesaPhone');
      const amountInput = document.getElementById('mpesaAmount');
      const householdSelect = document.getElementById('mpesaHousehold');
      const statusEl = document.getElementById('mpesaStatus');

      function populateMpesaHouseholds() {
          if(!householdSelect) return;
          const households = read(DB_KEYS.households).sort((a, b) => a.head.localeCompare(b.head));
          householdSelect.innerHTML = '<option value="">Select Household (Optional)</option>';
          households.forEach(h => {
              householdSelect.innerHTML += `<option value="${h.id}">${h.head}</option>`;
          });
      }
      document.addEventListener('DOMContentLoaded', populateMpesaHouseholds);
      document.getElementById('houseCreate')?.addEventListener('click', populateMpesaHouseholds);

      if(!btn) return;

      async function pollPaymentStatus(requestId, contributionData, originalBtnText) {
          const { householdId, amount, phone } = contributionData;
          let attempts = 0;
          const maxAttempts = 20; // ~1 minute

          const poll = async () => {
              if (attempts >= maxAttempts) {
                  statusEl.textContent = 'Polling timed out. Please check SMS.';
                  statusEl.className = 'text-xs text-center text-orange-400 mt-2';
                  btn.disabled = false;
                  btn.innerHTML = originalBtnText;
                  return;
              }
              attempts++;

              try {
                  const apiBase = localStorage.getItem('abc_api_base') || 'http://localhost:3000';
                  const res = await fetch(`${apiBase}/api/query-status`, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ checkoutRequestId: requestId })
                  });
                  const data = await res.json();

                  if (data.ResultCode === "0") {
                      statusEl.textContent = 'Payment Confirmed! Recording...';
                      statusEl.className = 'text-xs text-center text-green-400 mt-2 font-bold';
                      
                      const household = householdId ? read(DB_KEYS.households).find(h => h.id == householdId) : null;
                      const payload = { id: Date.now(), householdId: household?.id, envelope: household?.envelope || 'MPESA', regular: amount, capital: 0, date: new Date().toISOString(), method: 'M-Pesa', payerPhone: phone };
                      const contributions = read(DB_KEYS.contributions); contributions.push(payload); write(DB_KEYS.contributions, contributions);
                      updateDashboardSummary(); renderRecentContributions();
                      
                      phoneInput.value = ''; amountInput.value = ''; householdSelect.value = '';
                      btn.disabled = false;
                      btn.innerHTML = originalBtnText;
                      setTimeout(() => { statusEl.textContent = ''; }, 5000);
                  } else if (['1032', '1037', '2001'].includes(data.ResultCode)) {
                      statusEl.textContent = `Failed: ${data.ResultDesc || 'Cancelled'}`;
                      statusEl.className = 'text-xs text-center text-red-400 mt-2';
                      btn.disabled = false;
                      btn.innerHTML = originalBtnText;
                  } else {
                      setTimeout(poll, 3000);
                  }
              } catch (e) {
                  console.error(e);
                  setTimeout(poll, 3000);
              }
          };
          poll();
      }

      btn.addEventListener('click', async () => {
          const phone = phoneInput.value.trim();
          const amount = parseFloat(amountInput.value);
          const householdId = householdSelect.value;
          const kenyanPhoneRegex = /^(?:254|\+254|0)?(7|1)\d{8}$/;
          
          if (!phone || !kenyanPhoneRegex.test(phone)) {
              alert('Please enter a valid Kenyan phone number (e.g., 0712345678 or 2547...).');
              return;
          }
          if(!amount || amount <= 0) { alert('Please enter a valid amount.'); return; }

          const originalText = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner h-4 w-4 border-2 border-t-transparent rounded-full mr-2"></span> Sending STK...';
          statusEl.textContent = 'Initiating transaction on your phone...';
          statusEl.className = 'text-xs text-center text-yellow-400 mt-2';

          try {
            const response = await fetch(`${API_BASE}/api/stkpush`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone, amount })
            });
            const data = await response.json();

            if (data.ResponseCode === "0") {
                statusEl.textContent = `STK Push Sent! Check your phone to enter PIN.`;
                statusEl.className = 'text-xs text-center text-green-400 mt-2 font-bold';
                pollPaymentStatus(data.CheckoutRequestID, { householdId, amount, phone }, originalText);
            } else {
                throw new Error(data.errorMessage || 'Transaction failed to initiate.');
            }
          } catch (error) {
            console.error(error);
            // Check for network error
            let msg = error.message;
            if (error.message === 'Failed to fetch') {
                msg = 'Connection failed. Is the server running?';
                // Prompt user to update API URL if connection fails and we are not on localhost
                if(!API_BASE.includes('localhost') && confirm('Could not connect to the server. Do you want to update the API URL?')) { 
                    const newUrl = prompt('Enter new API URL:', API_BASE); 
                    if(newUrl) { localStorage.setItem('abc_api_base', newUrl); location.reload(); } 
                }
            }
            statusEl.textContent = 'Error: ' + msg;
            statusEl.className = 'text-xs text-center text-red-400 mt-2';
            btn.disabled = false;
            btn.innerHTML = originalText;
          }
      });
    })();

    // ----------------------
    // Contribution Tabs Logic
    // ----------------------
    (function setupContribTabs(){
        const tabManual = document.getElementById('tabContribManual');
        const tabMpesa = document.getElementById('tabContribMpesa');
        const viewManual = document.getElementById('viewContribManual');
        const viewMpesa = document.getElementById('viewContribMpesa');

        if(tabManual && tabMpesa && viewManual && viewMpesa){
            tabManual.addEventListener('click', () => {
                viewManual.classList.remove('hidden'); viewMpesa.classList.add('hidden');
                tabManual.classList.add('bg-slate-700', 'text-white', 'shadow-lg'); tabManual.classList.remove('text-gray-400', 'hover:bg-slate-800/50');
                tabMpesa.classList.remove('bg-slate-700', 'text-white', 'shadow-lg'); tabMpesa.classList.add('text-gray-400', 'hover:bg-slate-800/50');
            });
            tabMpesa.addEventListener('click', () => {
                viewManual.classList.add('hidden'); viewMpesa.classList.remove('hidden');
                tabMpesa.classList.add('bg-slate-700', 'text-white', 'shadow-lg'); tabMpesa.classList.remove('text-gray-400', 'hover:bg-slate-800/50');
                tabManual.classList.remove('bg-slate-700', 'text-white', 'shadow-lg'); tabManual.classList.add('text-gray-400', 'hover:bg-slate-800/50');
            });
        }
    })();

    // ----------------------
    // M-Pesa Admin Logic
    // ----------------------
    (function setupMpesaAdmin(){
        const btn = document.querySelector('[data-page="mpesa-admin"]');
        const refreshBtn = document.getElementById('refreshMpesaAdmin');
        const tbody = document.getElementById('mpesaAdminTableBody');

        async function loadTransactions() {
            if(!tbody) return;
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">Loading transactions...</td></tr>';
            
            try {
                const data = await apiFetch('/api/admin/mpesa-transactions');
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No transactions found.</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(t => {
                    const statusColor = t.status === 'COMPLETED' ? 'text-green-400' : 
                                      t.status === 'FAILED' ? 'text-red-400' : 'text-yellow-400';
                    const dateStr = new Date(t.created_at).toLocaleString();
                    return `
                        <tr class="hover:bg-slate-800/50 transition-colors">
                            <td class="px-4 py-3 whitespace-nowrap">${dateStr}</td>
                            <td class="px-4 py-3 font-mono">${t.phoneNumber}</td>
                            <td class="px-4 py-3 font-semibold text-white">${t.amount}</td>
                            <td class="px-4 py-3 font-mono text-xs">${t.mpesaReceiptNumber || '-'}</td>
                            <td class="px-4 py-3 font-bold text-xs ${statusColor}">${t.status}</td>
                            <td class="px-4 py-3 text-xs text-gray-400 max-w-[200px] truncate" title="${t.resultDesc || ''}">${t.resultDesc || '-'}</td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-red-400">Error loading data: ${e.message}</td></tr>`;
            }
        }

        if(btn) btn.addEventListener('click', loadTransactions);
        if(refreshBtn) refreshBtn.addEventListener('click', loadTransactions);
    })();

    if (cancelEditBtn) {
        cancelEditBtn.addEventListener('click', resetHouseholdForm);
    }

    // Households create
    document.getElementById('houseCreate').addEventListener('click', ()=>{
      const householdId = parseInt(householdIdField.value, 10) || null;
      const head = document.getElementById('houseHead').value.trim();
      const env = document.getElementById('houseEnvelope').value.trim();
      const address = document.getElementById('houseAddress').value.trim();
      const phone = document.getElementById('housePhone').value.trim();
      const status = document.getElementById('membershipStatus').value;
      const membershipClass = document.getElementById('membershipClass').checked;

      const hs = read(DB_KEYS.households);
      let household;
      let isUpdating = !!householdId;

      if (!head) { alert('Enter head of household'); return; }

      // Envelope ID validation
      if (!env) {
        alert('Envelope ID is required. Please generate one.');
        return;
      }

      if (hs.some(h => h.id !== householdId && h.envelope && h.envelope.toLowerCase() === env.toLowerCase())) {
        alert('This Envelope ID is already in use. Please use a different one or generate a new one.');
        return;
      }
      
      if (isUpdating) {
          household = hs.find(h => h.id === householdId);
      } else {
          const id = hs.length ? Math.max(...hs.map(x=>x.id)) + 1 : 1;
          household = { id };
          hs.push(household);
      }

      Object.assign(household, { head, envelope: env, address, phone, status, membershipClass, members: tempFamilyMembers });
      write(DB_KEYS.households, hs);

      // Handle optional pledge
      const addPledge = document.getElementById('addPledgeCheckbox').checked;
      const pledgeAmount = parseFloat(document.getElementById('pledgeAmount').value) || 0;
      const pledges = read(DB_KEYS.pledges);
      let pledge = pledges.find(p => p.householdId === household.id);

      if (addPledge && pledgeAmount > 0) {
        const startDate = document.getElementById('pledgeStartDate').value || new Date().toISOString().slice(0,10);
        if (pledge) {
            // Update existing pledge
            pledge.original = pledgeAmount;
            pledge.start = startDate;
            // Note: You might want more complex logic for remaining amount if original changes
        } else {
            // Create new pledge
            const newPledge = { id: Date.now(), householdId: household.id, original: pledgeAmount, remaining: pledgeAmount, start: startDate };
            pledges.push(newPledge);
        }
      } else if (!addPledge && pledge) {
          // Remove pledge if checkbox is unchecked
          const index = pledges.findIndex(p => p.id === pledge.id);
          if (index > -1) pledges.splice(index, 1);
      }
      write(DB_KEYS.pledges, pledges);

      // Reset form and update UI
      resetHouseholdForm();
      renderHouseList();
      updateDashboardSummary(); // Refresh dashboard cards
      renderHouseholdDropdown(); // Refresh dropdown after creating a household

      if (houseSearchInput) houseSearchInput.value = '';
    });

    // When the page loads or a household is added/deleted, we need to populate the ceremony dropdowns
    document.addEventListener('DOMContentLoaded', renderCeremonyHouseholdDropdowns);
    document.addEventListener('DOMContentLoaded', initializeCeremonyCalendar);
    document.getElementById('houseCreate').addEventListener('click', renderCeremonyHouseholdDropdowns);
    houseListEl.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-household-btn')) renderCeremonyHouseholdDropdowns();
    });

    // Generate envelope button
    const genEnvelopeBtn = document.getElementById('genEnvelopeBtn');
    if (genEnvelopeBtn) {
      genEnvelopeBtn.addEventListener('click', () => {
        document.getElementById('houseEnvelope').focus();
        document.getElementById('houseEnvelope').value = genEnvelope();
      });
    }
    
    // Toggle pledge fields on household form
    const addPledgeCheckbox = document.getElementById('addPledgeCheckbox');
    if (addPledgeCheckbox) {
        addPledgeCheckbox.addEventListener('change', () => {
            const pledgeFields = document.getElementById('pledgeFields');
            pledgeFields.classList.toggle('hidden', !addPledgeCheckbox.checked);
        });
    }

    // Ceremonies
    function addCeremony(type, data){ const arr = read(DB_KEYS.ceremonies); data.id = Date.now(); data.type = type; arr.push(data); write(DB_KEYS.ceremonies, arr); }
    let ceremonyCalendarInstance = null;

    function resetCeremonyForms() {
        // Baptism
        document.getElementById('baptismId').value = '';
        document.getElementById('baptismHousehold').value = '';
        document.getElementById('baptismName').value = '';
        document.getElementById('baptismSponsor').value = '';
        document.getElementById('baptismDate').value = '';
        document.getElementById('baptismNotes').value = '';
        document.getElementById('baptismPrep').checked = false;
        document.getElementById('baptismSubmit').textContent = 'Record Baptism';
        document.getElementById('baptismCancelEdit').classList.add('hidden');

        // Wedding
        document.getElementById('weddingId').value = '';
        document.getElementById('weddingPersonA').value = '';
        document.getElementById('weddingPersonB').value = '';
        document.getElementById('weddingDate').value = '';
        document.getElementById('weddingNotes').value = '';
        document.getElementById('weddingPrep').checked = false;
        document.getElementById('weddingMemberCheck').checked = false;
        document.getElementById('weddingHousehold').value = '';
        document.getElementById('weddingSubmit').textContent = 'Record Wedding';
        document.getElementById('weddingCancelEdit').classList.add('hidden');

        // Funeral & Confirmation (add reset logic here if needed)
        document.getElementById('funeralId').value = '';
        document.getElementById('funeralSubmit').textContent = 'Record Funeral';
        document.getElementById('funeralCancelEdit').classList.add('hidden');

        document.getElementById('confirmationId').value = '';
        document.getElementById('confirmationSubmit').textContent = 'Record Confirmation';
        document.getElementById('confirmationCancelEdit').classList.add('hidden');
    }

    function loadCeremonyIntoForm(ceremony) {
        // Scroll to the top of the page to see the form
        document.getElementById('page-ceremonies').scrollIntoView({ behavior: 'smooth' });

        // Reset all forms first to clear any previous state
        document.getElementById('baptismSubmit').textContent = 'Record Baptism';
        document.getElementById('weddingSubmit').textContent = 'Record Wedding';
        document.getElementById('funeralSubmit').textContent = 'Record Funeral';
        document.getElementById('confirmationSubmit').textContent = 'Record Confirmation';
        resetCeremonyForms(); // Clear all forms first

        if (ceremony.type === 'baptism') {
            document.getElementById('baptismId').value = ceremony.id;
            document.getElementById('baptismHousehold').value = ceremony.householdId || '';
            document.getElementById('baptismName').value = ceremony.name || '';
            document.getElementById('baptismSponsor').value = ceremony.sponsor || '';
            document.getElementById('baptismDate').value = ceremony.date || '';
            document.getElementById('baptismNotes').value = ceremony.notes || '';
            document.getElementById('baptismPrep').checked = ceremony.prep || false;
            document.getElementById('baptismSubmit').textContent = 'Update Baptism';
            document.getElementById('baptismCancelEdit').classList.remove('hidden');
        } else if (ceremony.type === 'wedding') {
            document.getElementById('weddingId').value = ceremony.id;
            document.getElementById('weddingPersonA').value = ceremony.personA || '';
            document.getElementById('weddingHousehold').value = ceremony.householdId || '';
            document.getElementById('weddingPersonB').value = ceremony.personB || '';
            document.getElementById('weddingDate').value = ceremony.date || '';
            document.getElementById('weddingNotes').value = ceremony.notes || '';
            document.getElementById('weddingPrep').checked = ceremony.prep || false;
            document.getElementById('weddingMemberCheck').checked = ceremony.memberCheck || false;
            document.getElementById('weddingSubmit').textContent = 'Update Wedding';
            document.getElementById('weddingCancelEdit').classList.remove('hidden');
        } else if (ceremony.type === 'funeral') {
            document.getElementById('funeralId').value = ceremony.id;
            document.getElementById('funeralHousehold').value = ceremony.householdId || '';
            document.getElementById('funeralName').value = ceremony.name || '';
            document.getElementById('funeralDate').value = ceremony.date || '';
            document.getElementById('funeralNotes').value = ceremony.notes || '';
            document.getElementById('funeralSubmit').textContent = 'Update Funeral';
            document.getElementById('funeralCancelEdit').classList.remove('hidden');
        } else if (ceremony.type === 'confirmation') {
            document.getElementById('confirmationId').value = ceremony.id;
            document.getElementById('confirmationHousehold').value = ceremony.householdId || '';
            document.getElementById('confirmationName').value = ceremony.name || '';
            document.getElementById('confirmationSponsor').value = ceremony.sponsor || '';
            document.getElementById('confirmationDate').value = ceremony.date || '';
            document.getElementById('confirmationNotes').value = ceremony.notes || '';
            document.getElementById('confirmationSubmit').textContent = 'Update Confirmation';
            document.getElementById('confirmationCancelEdit').classList.remove('hidden');
        }
    }

    function generateBaptismCertificate(ceremony) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a5'
        });

        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        // 1. Add a decorative border
        doc.setDrawColor(150, 120, 200); // A nice purple color
        doc.setLineWidth(1);
        doc.rect(5, 5, pageWidth - 10, pageHeight - 10); // Outer border
        doc.setLineWidth(0.5);
        doc.rect(7, 7, pageWidth - 14, pageHeight - 14); // Inner border

        // 2. Add Titles
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(24);
        doc.setTextColor(88, 28, 135); // Dark Purple
        doc.text('Certificate of Baptism', pageWidth / 2, 25, { align: 'center' });

        doc.setFont('helvetica', 'normal');
        doc.setFontSize(14);
        doc.setTextColor(100, 100, 100);
        doc.text('This is to certify that', pageWidth / 2, 40, { align: 'center' });

        // 3. Add Person's Name, Sponsor, and Date
        doc.setFont('times', 'bolditalic');
        doc.setFontSize(28);
        doc.setTextColor(0, 0, 0);
        doc.text(ceremony.name, pageWidth / 2, 60, { align: 'center' });

        doc.setFont('helvetica', 'normal');
        doc.setFontSize(12);
        doc.text(`was baptized in the name of the Father, the Son, and the Holy Spirit\nat ABC Church on this day, ${new Date(ceremony.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}.`, pageWidth / 2, 75, { align: 'center' });
        doc.text(`Sponsor / Godparent: ${ceremony.sponsor || 'N/A'}`, pageWidth / 2, 85, { align: 'center' });

        // 4. Save the PDF
        doc.save(`Baptism-Certificate-${ceremony.name.replace(/ /g, '-')}.pdf`);
    }

    function updateCeremony(id, payload) {
        let ceremonies = read(DB_KEYS.ceremonies);
        const index = ceremonies.findIndex(c => c.id === id);
        if (index > -1) Object.assign(ceremonies[index], payload);
        write(DB_KEYS.ceremonies, ceremonies);
    }
    
    function renderCeremonyHouseholdDropdowns() {
        const households = read(DB_KEYS.households).sort((a, b) => a.head.localeCompare(b.head));
        const baptismSelect = document.getElementById('baptismHousehold');
        const confirmationSelect = document.getElementById('confirmationHousehold');
        const weddingSelect = document.getElementById('weddingHousehold');
        const funeralSelect = document.getElementById('funeralHousehold');
        
        [baptismSelect, confirmationSelect, weddingSelect, funeralSelect].forEach(select => {
            if (!select) return;
            select.innerHTML = '<option value="">Select Household...</option>';
            households.forEach(h => {
                select.innerHTML += `<option value="${h.id}">${h.head} (${h.envelope || 'No ID'})</option>`;
            });
        });
    }

    function initializeCeremonyCalendar() {
        const ceremonies = read(DB_KEYS.ceremonies);
        const events = ceremonies.map(c => {
            let title = c.type.charAt(0).toUpperCase() + c.type.slice(1);
            if (c.name) title += `: ${c.name}`;
            else if (c.personA) title += `: ${c.personA} & ${c.personB}`;
            
            return {
                id: c.id, // Pass the ceremony ID
                start: c.date,
                end: c.date,
                summary: title,
            };
        });

        const households = read(DB_KEYS.households);

        const options = {
            type: 'month',
            events: events,
            settings: {
                visibility: { theme: 'dark' },
                selection: { day: 'multiple-ranged' },
            },
            actions: {
                clickEvent(e, event) {
                    const ceremony = ceremonies.find(c => c.id === event.id);
                    if (!ceremony) return;

                    const household = ceremony.householdId ? households.find(h => h.id === ceremony.householdId) : null;
                    let details = `Type: ${ceremony.type.charAt(0).toUpperCase() + ceremony.type.slice(1)}\nDate: ${new Date(ceremony.date).toLocaleDateString()}\n`;

                    if (ceremony.type === 'baptism' || ceremony.type === 'confirmation') {
                        details += `Name: ${ceremony.name}\nSponsor: ${ceremony.sponsor || 'N/A'}`;
                        if (household) details += `\nHousehold: ${household.head}`;
                    } else if (ceremony.type === 'wedding') {
                        details += `Couple: ${ceremony.personA} & ${ceremony.personB}`;
                    } else if (ceremony.type === 'funeral') {
                        details += `Deceased: ${ceremony.name}`;
                    }

                    if (ceremony.notes) details += `\n\nNotes: ${ceremony.notes}`;

                    alert(details);
                }
            }
        };

        if (!ceremonyCalendarInstance) {
            ceremonyCalendarInstance = new VanillaCalendar('#ceremonyCalendar', options);
            ceremonyCalendarInstance.init();
        } else {
            ceremonyCalendarInstance.settings.events = events;
            ceremonyCalendarInstance.update();
        }
    }

    function generateBaptismCertificate(ceremony) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a5'
        });

        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        // 1. Add a decorative border
        doc.setDrawColor(150, 120, 200); // A nice purple color
        doc.setLineWidth(1);
        doc.rect(5, 5, pageWidth - 10, pageHeight - 10); // Outer border
        doc.setLineWidth(0.5);
        doc.rect(7, 7, pageWidth - 14, pageHeight - 14); // Inner border

        // 2. Add Titles
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(24);
        doc.setTextColor(88, 28, 135); // Dark Purple
        doc.text('Certificate of Baptism', pageWidth / 2, 25, { align: 'center' });

        doc.setFont('helvetica', 'normal');
        doc.setFontSize(14);
        doc.setTextColor(100, 100, 100);
        doc.text('This is to certify that', pageWidth / 2, 40, { align: 'center' });

        // 3. Add Person's Name
        doc.setFont('times', 'bolditalic');
        doc.setFontSize(28);
        doc.setTextColor(0, 0, 0);
        doc.text(ceremony.name, pageWidth / 2, 60, { align: 'center' });

        // 4. Add Ceremony Details
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(12);
        doc.text(`was baptized in the name of the Father, the Son, and the Holy Spirit\nat ABC Church on this day, ${new Date(ceremony.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}.`, pageWidth / 2, 75, { align: 'center' });
        doc.text(`Sponsor / Godparent: ${ceremony.sponsor || 'N/A'}`, pageWidth / 2, 85, { align: 'center' });

        // 5. Save the PDF
        doc.save(`Baptism-Certificate-${ceremony.name.replace(/ /g, '-')}.pdf`);
    }

    function renderCeremoniesList(filter = '') {
        const listEl = document.getElementById('recordedCeremoniesList');
        if (!listEl) return;

        let ceremonies = read(DB_KEYS.ceremonies);

        if (filter) {
            const lowerFilter = filter.toLowerCase();
            ceremonies = ceremonies.filter(c => {
                const typeMatch = c.type.toLowerCase().includes(lowerFilter);
                const nameMatch = c.name && c.name.toLowerCase().includes(lowerFilter);
                const sponsorMatch = c.sponsor && c.sponsor.toLowerCase().includes(lowerFilter);
                const personAMatch = c.personA && c.personA.toLowerCase().includes(lowerFilter);
                const personBMatch = c.personB && c.personB.toLowerCase().includes(lowerFilter);
                return typeMatch || nameMatch || sponsorMatch || personAMatch || personBMatch;
            });
        }

        // Sort by date (newest first)
        const recentCeremonies = ceremonies.sort((a, b) => new Date(b.date) - new Date(a.date));
        const households = read(DB_KEYS.households);

        if (recentCeremonies.length === 0) {
            listEl.innerHTML = `<div class="text-gray-500">${filter ? 'No ceremonies found.' : 'No ceremonies recorded yet.'}</div>`;
            return;
        }
        if (recentCeremonies.length === 0) {
            listEl.innerHTML = '<div class="text-gray-500">No ceremonies recorded yet.</div>';
            return;
        }

        listEl.innerHTML = recentCeremonies.map(c => {
            let details = '';
            const ceremonyDate = new Date(c.date).toLocaleDateString();
            const ceremonyType = c.type.charAt(0).toUpperCase() + c.type.slice(1);
            const household = households.find(h => h.id === c.householdId);
            let actionButtons = `
                <button data-id="${c.id}" class="edit-ceremony-btn text-blue-400 hover:text-blue-300 text-xs px-2 py-1 rounded">Edit</button>
                <button data-id="${c.id}" class="delete-ceremony-btn text-red-500 hover:text-red-400 text-xs px-2 py-1 rounded">Delete</button>
            `;

            if (c.type === 'baptism') {
                details = `<strong>${c.name}</strong> (Sponsor: ${c.sponsor || 'N/A'})` + (household ? ` <span class="text-xs text-gray-400">from ${household.head}'s household</span>` : '');
                // Add certificate button only for baptisms
                actionButtons += `<button data-id="${c.id}" class="print-cert-btn text-green-400 hover:text-green-300 text-xs px-2 py-1 rounded">Certificate</button>`;
            } else if (c.type === 'wedding') {
                details = `<strong>${c.personA}</strong> & <strong>${c.personB}</strong>`;
                if (household) details += ` <span class="text-xs text-gray-400">from ${household.head}'s household</span>`;
            } else if (c.type === 'funeral') {
                details = `<strong>${c.name}</strong>` + (household ? ` <span class="text-xs text-gray-400">from ${household.head}'s household</span>` : '');
            } else if (c.type === 'confirmation') {
                details = `<strong>${c.name}</strong> (Sponsor: ${c.sponsor || 'N/A'})` + (household ? ` <span class="text-xs text-gray-400">from ${household.head}'s household</span>` : '');
            }

            return `
                <div class="flex justify-between items-center py-2 border-b border-slate-800">
                    <div>
                        <div><span class="font-semibold text-purple-300">${ceremonyType}</span>: ${details}</div>
                        ${c.notes ? `<div class="text-xs text-gray-400 pl-2 border-l-2 border-slate-700 mt-1">Note: ${c.notes}</div>` : ''}
                    </div>
                    <div class="text-right flex-shrink-0 ml-4">
                        <div class="text-xs text-gray-400">${ceremonyDate}</div>
                        <div>
                            ${actionButtons}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Add event listeners for ceremony edit/delete
    const recordedCeremoniesList = document.getElementById('recordedCeremoniesList');
    if (recordedCeremoniesList) {
        recordedCeremoniesList.addEventListener('click', (e) => {
            const targetButton = e.target.closest('button');
            if (!targetButton) return;

            const ceremonyId = parseInt(targetButton.getAttribute('data-id'), 10);
            if (!ceremonyId) return;

            if (e.target.classList.contains('delete-ceremony-btn')) {
                if (confirm('Are you sure you want to delete this ceremony record?')) {
                    let ceremonies = read(DB_KEYS.ceremonies);
                    write(DB_KEYS.ceremonies, ceremonies.filter(c => c.id !== ceremonyId));
                    renderCeremoniesList(document.getElementById('ceremoniesSearch').value);
                    initializeCeremonyCalendar(); // Refresh calendar
                    updateDashboardSummary();
                }
            }
            if (e.target.classList.contains('print-cert-btn')) {
                const ceremonies = read(DB_KEYS.ceremonies);
                const ceremony = ceremonies.find(c => c.id === ceremonyId);
                if (ceremony) {
                    generateBaptismCertificate(ceremony);
                }
            }
            if (e.target.classList.contains('edit-ceremony-btn')) {
                const ceremonies = read(DB_KEYS.ceremonies);
                const ceremony = ceremonies.find(c => c.id === ceremonyId);
                if (ceremony) {
                    loadCeremonyIntoForm(ceremony);
                }
            }
        });
    }
    renderCeremoniesList(); // Initial render
    
    // Ceremonies search/filter
    const ceremoniesSearchInput = document.getElementById('ceremoniesSearch');
    if (ceremoniesSearchInput) {
        ceremoniesSearchInput.addEventListener('input', () => renderCeremoniesList(ceremoniesSearchInput.value));
    }

    document.getElementById('baptismSubmit').addEventListener('click', ()=>{
      const id = parseInt(document.getElementById('baptismId').value, 10) || null;
      const householdId = parseInt(document.getElementById('baptismHousehold').value, 10) || null;
      const name = document.getElementById('baptismName').value.trim(); 
      const sponsor = document.getElementById('baptismSponsor').value.trim(); 
      const prep = document.getElementById('baptismPrep').checked;
      const date = document.getElementById('baptismDate').value || new Date().toISOString().slice(0,10);
      const notes = document.getElementById('baptismNotes').value.trim();
      if (!name) { alert('Enter name'); return; }
      const payload = { type: 'baptism', householdId, name, sponsor, prep, date, notes };
      apiFetch('/api/ceremonies/baptism', { method: 'POST', body: JSON.stringify(payload) })
        .then(()=>{ alert('Baptism recorded (server)'); })
        .catch(()=>{
            if (id) { updateCeremony(id, payload); } else { addCeremony('baptism', payload); }
            alert(`Baptism ${id ? 'updated' : 'recorded'} (offline)`);
        })
        .finally(() => {
            resetCeremonyForms();
            updateDashboardSummary(); renderCeremoniesList(ceremoniesSearchInput.value); initializeCeremonyCalendar();
        });
    });

    document.getElementById('weddingSubmit').addEventListener('click', ()=>{
      const id = parseInt(document.getElementById('weddingId').value, 10) || null;
      const a = document.getElementById('weddingPersonA').value.trim(); const b = document.getElementById('weddingPersonB').value.trim(); const prep = document.getElementById('weddingPrep').checked; const memberCheck = document.getElementById('weddingMemberCheck').checked;
      const householdId = parseInt(document.getElementById('weddingHousehold').value, 10) || null;
      const date = document.getElementById('weddingDate').value || new Date().toISOString().slice(0,10);
      const notes = document.getElementById('weddingNotes').value.trim();
      if (!a || !b) { alert('Enter both names'); return; }
      const payload = { type: 'wedding', personA: a, personB: b, prep, memberCheck, date, notes, householdId };
      apiFetch('/api/ceremonies/wedding', { method: 'POST', body: JSON.stringify(payload) })
        .then(()=>{ alert('Wedding recorded (server)'); })
        .catch(()=>{
            if (id) { updateCeremony(id, payload); } else { addCeremony('wedding', payload); }
            alert(`Wedding ${id ? 'updated' : 'recorded'} (offline)`);
        })
        .finally(() => {
            resetCeremonyForms();
            updateDashboardSummary(); renderCeremoniesList(ceremoniesSearchInput.value); initializeCeremonyCalendar();
        });
    });

    document.getElementById('funeralSubmit').addEventListener('click', ()=>{
      const id = parseInt(document.getElementById('funeralId').value, 10) || null;
      const name = document.getElementById('funeralName').value.trim(); const date = document.getElementById('funeralDate').value || new Date().toISOString().slice(0,10);
      const householdId = parseInt(document.getElementById('funeralHousehold').value, 10) || null;
      const notes = document.getElementById('funeralNotes').value.trim();
      if (!name) { alert('Enter deceased name'); return; }
      const payload = { type: 'funeral', name, date, notes, householdId };
      apiFetch('/api/ceremonies/funeral', { method: 'POST', body: JSON.stringify(payload) })
        .then(()=>{ alert('Funeral recorded (server)'); })
        .catch(()=>{
            if (id) { updateCeremony(id, payload); } else { addCeremony('funeral', payload); }
            alert(`Funeral ${id ? 'updated' : 'recorded'} (offline)`);
        })
        .finally(() => {
            resetCeremonyForms();
            updateDashboardSummary(); renderCeremoniesList(ceremoniesSearchInput.value); initializeCeremonyCalendar();
        });
    });

    document.getElementById('confirmationSubmit').addEventListener('click', ()=>{
      const id = parseInt(document.getElementById('confirmationId').value, 10) || null;
      const name = document.getElementById('confirmationName').value.trim(); const sponsor = document.getElementById('confirmationSponsor').value.trim();
      const householdId = parseInt(document.getElementById('confirmationHousehold').value, 10) || null;
      const date = document.getElementById('confirmationDate').value || new Date().toISOString().slice(0,10);
      const notes = document.getElementById('confirmationNotes').value.trim();
      if (!name) { alert('Enter person\'s name'); return; }
      const payload = { type: 'confirmation', name, sponsor, householdId, date, notes };
      apiFetch('/api/ceremonies/confirmation', { method: 'POST', body: JSON.stringify(payload) })
        .then(()=>{ alert('Confirmation recorded (server)'); })
        .catch(()=>{
            if (id) { updateCeremony(id, payload); } else { addCeremony('confirmation', payload); }
            alert(`Confirmation ${id ? 'updated' : 'recorded'} (offline)`);
        })
        .finally(() => {
            resetCeremonyForms();
            updateDashboardSummary(); renderCeremoniesList(ceremoniesSearchInput.value); initializeCeremonyCalendar();
        });
    });

    // Add event listeners for all cancel buttons
    document.getElementById('baptismCancelEdit').addEventListener('click', resetCeremonyForms);
    document.getElementById('weddingCancelEdit').addEventListener('click', resetCeremonyForms);
    document.getElementById('funeralCancelEdit').addEventListener('click', resetCeremonyForms);
    document.getElementById('confirmationCancelEdit').addEventListener('click', resetCeremonyForms);

    // Refresh calendar when a ceremony is added
    ['baptismSubmit', 'weddingSubmit', 'funeralSubmit', 'confirmationSubmit'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
            // The finally() block now handles this, so this listener is no longer needed.
            // btn.addEventListener('click', () => setTimeout(initializeCeremonyCalendar, 200)); // Delay to ensure data is written
        }
    });

    // Print Recorded Ceremonies
    const printCeremoniesBtn = document.getElementById('printCeremoniesBtn');
    if (printCeremoniesBtn) {
        printCeremoniesBtn.addEventListener('click', () => {
            const listContainer = document.getElementById('recordedCeremoniesContainer');
            if (!listContainer) return;

            // Use the existing print container logic
            let printContainer = document.getElementById('print-container');
            if (!printContainer) {
                printContainer = document.createElement('div');
                printContainer.id = 'print-container';
                document.body.appendChild(printContainer);
            }

            const reportTitle = listContainer.querySelector('h3')?.textContent || 'Recorded Ceremonies';
            const printHeader = `
                <div class="print-header">
                    <h1>${reportTitle}</h1>
                    <p>Generated on: ${new Date().toLocaleDateString()}</p>
                </div>
            `;

            // Clone the list content, remove the button, and print
            printContainer.innerHTML = listContainer.innerHTML;
            printContainer.querySelector('#printCeremoniesBtn')?.remove();

            printContainer.innerHTML = printHeader + listContainer.querySelector('#recordedCeremoniesList').innerHTML;
            document.body.classList.add('is-printing');
            window.print();
            document.body.classList.remove('is-printing');
        });
    }


    // Reports
    function sumEnvelopedByHousehold(year){
      const cons = read(DB_KEYS.contributions);
      const result = {};
      cons.forEach(c=>{
        const d = new Date(c.date);
        if (d.getFullYear() !== Number(year)) return;
        if (!c.householdId) return;
        result[c.householdId] = (result[c.householdId] || 0) + (Number(c.regular||0) + Number(c.capital||0));
      });
      return result;
    }

    function downloadCSV(filename, rows){
      const csv = rows.map(r=>r.map(cell=>'"'+String(cell).replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    }

    document.getElementById('genTax').addEventListener('click', ()=>{
      const year = document.getElementById('taxYear').value;
      // try server report
      apiFetch('/api/reports/tax/' + year)
        .then(res => {
          const rows = [['Envelope','Head of Household','Total ' + year]];
          res.rows.forEach(r=> rows.push([r.envelope, r.head, (r.total || 0).toFixed(2)]));
          const preview = document.getElementById('taxPreview'); preview.innerHTML = '<pre class="text-xs">' + rows.slice(0,20).map(r=>r.join(' | ')).join('\n') + '</pre>';
          // also offer PDF via jsPDF
          try{
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(12);
            doc.text(`Tax Report ${year}`, 14, 20);
            let y = 30;
            rows.forEach(r=>{ doc.text(`${r[0]}  ${r[1]}  ${r[2]}`, 14, y); y += 8; if (y > 270) { doc.addPage(); y = 20; } });
            doc.save(`tax-report-${year}.pdf`);
          } catch(e){ /* ignore pdf if jsPDF missing */ }
        })
        .catch(()=>{
          const sums = sumEnvelopedByHousehold(year);
          const hs = read(DB_KEYS.households);
          const rows = [['Envelope','Head of Household','Total ' + year]];
          hs.forEach(h=> rows.push([h.envelope||'', h.head||'', (sums[h.id]||0).toFixed(2)]));
          const preview = document.getElementById('taxPreview'); preview.innerHTML = '<table class="w-full text-left text-xs"><thead><tr><th class="p-1">Env</th><th class="p-1">Household</th><th class="p-1 text-right">Total</th></tr></thead><tbody>' + rows.slice(1,20).map(r=>`<tr><td class="p-1">${r[0]}</td><td class="p-1">${r[1]}</td><td class="p-1 text-right">$${r[2]}</td></tr>`).join('') + '</tbody></table>';
          downloadCSV(`tax-report-${year}.csv`, rows.map(r => [r[0], r[1], r[2]]));
        });
    });

    document.getElementById('printTax').addEventListener('click', ()=>{
      window.print();
    });

    document.getElementById('genMonth').addEventListener('click', ()=>{
      const val = document.getElementById('reportMonth').value; if (!val) { alert('Choose month'); return; }
      // try server monthly report
      apiFetch('/api/reports/monthly?month=' + encodeURIComponent(val))
        .then(res=>{
          const preview = document.getElementById('monthPreview');
          preview.innerHTML = `<div>Contributions: ${res.contributions.length}</div><div>Ceremonies: ${res.ceremonies.length}</div>`;
        })
        .catch(()=>{
          const [y,m] = val.split('-');
          const cons = read(DB_KEYS.contributions).filter(c=>{ const d=new Date(c.date); return d.getFullYear()===Number(y) && (d.getMonth()+1)===Number(m); });
          const ceremonies = read(DB_KEYS.ceremonies).filter(c=>{ const d=new Date(c.date); return d.getFullYear()===Number(y) && (d.getMonth()+1)===Number(m); });
          const preview = document.getElementById('monthPreview');
          preview.innerHTML = `<div>Contributions: ${cons.length}</div><div>Ceremonies: ${ceremonies.length}</div>`;
        });
    });

    document.getElementById('exportMonth').addEventListener('click', ()=>{
      const val = document.getElementById('reportMonth').value; if (!val) { alert('Choose month'); return; }
      // ask server for monthly details first
      apiFetch('/api/reports/monthly?month=' + encodeURIComponent(val))
        .then(res=>{
          const rows = [['Date','Envelope','Head','Regular','Capital']];
          const hs = read(DB_KEYS.households);
          res.contributions.forEach(c=>{ const h = hs.find(x=>x.id===c.householdId); rows.push([new Date(c.date).toLocaleString(), c.envelope||'', h? h.head : '', (c.regular||0).toFixed(2), (c.capital||0).toFixed(2)]); });
          downloadCSV(`monthly-report-${val}.csv`, rows);
        })
        .catch(()=>{
          const [y,m] = val.split('-');
          const cons = read(DB_KEYS.contributions).filter(c=>{ const d=new Date(c.date); return d.getFullYear()===Number(y) && (d.getMonth()+1)===Number(m); });
          const rows = [['Date','Envelope','Head','Regular','Capital']];
          const hs = read(DB_KEYS.households);
          cons.forEach(c=>{ const h = hs.find(x=>x.id===c.householdId); rows.push([new Date(c.date).toLocaleString(), c.envelope||'', h? h.head : '', (c.regular||0).toFixed(2), (c.capital||0).toFixed(2)]); });
          downloadCSV(`monthly-report-${val}.csv`, rows);
        });
    });

    // Pledge Status Report
    (function setupPledgeReport() {
        const genBtn = document.getElementById('genPledgeReport');
        const exportBtn = document.getElementById('exportPledgeReport');
        const previewEl = document.getElementById('pledgeReportPreview');

        if (!genBtn || !exportBtn || !previewEl) return;

        function getReportData() {
            const pledges = read(DB_KEYS.pledges);
            const households = read(DB_KEYS.households);
            const householdMap = new Map(households.map(h => [h.id, h.head]));

            return pledges.map(p => {
                const progress = p.original > 0 ? ((p.original - p.remaining) / p.original) * 100 : 0;
                return {
                    householdName: householdMap.get(p.householdId) || 'Unknown',
                    original: p.original || 0,
                    remaining: p.remaining || 0,
                    paid: (p.original || 0) - (p.remaining || 0),
                    progress: progress.toFixed(1)
                };
            });
        }

        genBtn.addEventListener('click', () => {
            const data = getReportData();
            if (data.length === 0) {
                previewEl.innerHTML = '<div class="text-gray-500">No pledges found.</div>';
                return;
            }
            const tableRows = data.map(row => `
                <tr>
                    <td class="py-1 px-2 border-b border-slate-700">${row.householdName}</td>
                    <td class="py-1 px-2 border-b border-slate-700 text-right">$${row.original.toFixed(2)}</td>
                    <td class="py-1 px-2 border-b border-slate-700 text-right">$${row.paid.toFixed(2)}</td>
                    <td class="py-1 px-2 border-b border-slate-700 text-right">$${row.remaining.toFixed(2)}</td>
                    <td class="py-1 px-2 border-b border-slate-700 text-right">${row.progress}%</td>
                </tr>
            `).join('');
            previewEl.innerHTML = `<table class="w-full text-left text-xs"><thead><tr><th class="p-1">Household</th><th class="p-1 text-right">Pledged</th><th class="p-1 text-right">Paid</th><th class="p-1 text-right">Remaining</th><th class="p-1 text-right">Progress</th></tr></thead><tbody>${tableRows}</tbody></table>`;
        });

        exportBtn.addEventListener('click', () => {
            const data = getReportData();
            const rows = [['Household', 'Pledged Amount', 'Amount Paid', 'Amount Remaining', 'Progress (%)']];
            data.forEach(d => rows.push([d.householdName, d.original, d.paid, d.remaining, d.progress]));
            downloadCSV('pledge-status-report.csv', rows);
        });
    })();

    // Loans Report
    (function setupLoansReport() {
        const genBtn = document.getElementById('genLoansReport');
        const exportBtn = document.getElementById('exportLoansReport');
        const previewEl = document.getElementById('loansReportPreview');

        if (!genBtn || !exportBtn || !previewEl) return;

        function getReportData() {
            const loans = read(DB_KEYS.loans);
            const households = read(DB_KEYS.households);
            const householdMap = new Map(households.map(h => [h.id, h.head]));

            return loans.map(loan => {
                const totalInterestPaid = (loan.repayments || []).reduce((sum, p) => sum + p.interestPaid, 0);
                return {
                    householdName: householdMap.get(loan.householdId) || 'Unknown',
                    principal: loan.principal || 0,
                    rate: loan.rate || 0,
                    date: new Date(loan.date).toLocaleDateString(),
                    balance: loan.balance || 0,
                    interestPaid: totalInterestPaid
                };
            });
        }

        genBtn.addEventListener('click', () => {
            const data = getReportData();
            if (data.length === 0) {
                previewEl.innerHTML = '<div class="text-gray-500">No loans found.</div>';
                return;
            }
            const tableRows = data.map(row => `
                <tr>
                    <td class="py-1 px-2 border-b border-slate-700">${row.householdName}</td>
                    <td class="py-1 px-2 border-b border-slate-700 text-right">$${row.principal.toFixed(2)}</td>
                    <td class="py-1 px-2 border-b border-slate-700 text-right">$${row.balance.toFixed(2)}</td>
                    <td class="py-1 px-2 border-b border-slate-700 text-right">$${row.interestPaid.toFixed(2)}</td>
                </tr>
            `).join('');
            previewEl.innerHTML = `<table class="w-full text-left text-xs"><thead><tr><th class="p-1">Household</th><th class="p-1 text-right">Principal</th><th class="p-1 text-right">Balance</th><th class="p-1 text-right">Interest Paid</th></tr></thead><tbody>${tableRows}</tbody></table>`;
        });

        exportBtn.addEventListener('click', () => {
            const data = getReportData();
            const rows = [['Household', 'Principal', 'Rate (%)', 'Date Issued', 'Remaining Balance', 'Total Interest Paid']];
            data.forEach(d => rows.push([d.householdName, d.principal, d.rate, d.date, d.balance, d.interestPaid]));
            downloadCSV('loans-report.csv', rows);
        });
    })();

    // Ceremony Report
    (function setupCeremonyReport() {
        const genBtn = document.getElementById('genCeremonyReport');
        const exportBtn = document.getElementById('exportCeremonyReport');
        const previewEl = document.getElementById('ceremonyReportPreview');
        const startDateEl = document.getElementById('ceremonyStartDate');
        const endDateEl = document.getElementById('ceremonyEndDate');
        const typeFilterEl = document.getElementById('ceremonyTypeFilter');

        if (!genBtn || !exportBtn || !previewEl || !startDateEl || !endDateEl) return;
        if (!genBtn || !exportBtn || !previewEl || !startDateEl || !endDateEl || !typeFilterEl) return;

        function getReportData() {
            const selectedType = typeFilterEl.value;
            const startDate = startDateEl.value ? new Date(startDateEl.value) : null;
            const endDate = endDateEl.value ? new Date(endDateEl.value) : null;

            if (startDate) startDate.setHours(0, 0, 0, 0);
            if (endDate) endDate.setHours(23, 59, 59, 999);

            const ceremonies = read(DB_KEYS.ceremonies);
            const households = read(DB_KEYS.households);
            const householdMap = new Map(households.map(h => [h.id, h.head]));

            return ceremonies
                .filter(c => {
                    const ceremonyDate = new Date(c.date);
                    if (startDate && ceremonyDate < startDate) return false;
                    if (endDate && ceremonyDate > endDate) return false;
                    if (selectedType && c.type !== selectedType) return false;
                    return true;
                })
                .map(c => ({
                    type: c.type.charAt(0).toUpperCase() + c.type.slice(1),
                    date: new Date(c.date).toLocaleDateString(),
                    participants: c.name || `${c.personA || ''} & ${c.personB || ''}`,
                    household: householdMap.get(c.householdId) || 'N/A',
                    notes: c.notes || ''
                }));
        }

        genBtn.addEventListener('click', () => {
            const data = getReportData();
            if (data.length === 0) {
                previewEl.innerHTML = '<div class="text-gray-500">No ceremonies found in the selected date range.</div>';
                return;
            }
            const tableRows = data.map(row => `
                <tr>
                    <td class="py-1 px-2 border-b border-slate-700">${row.date}</td>
                    <td class="py-1 px-2 border-b border-slate-700">${row.type}</td>
                    <td class="py-1 px-2 border-b border-slate-700">${row.participants}</td>
                    <td class="py-1 px-2 border-b border-slate-700">${row.household}</td>
                </tr>
            `).join('');
            previewEl.innerHTML = `<table class="w-full text-left text-xs"><thead><tr><th class="p-1">Date</th><th class="p-1">Type</th><th class="p-1">Participants</th><th class="p-1">Household</th></tr></thead><tbody>${tableRows}</tbody></table>`;
        });

        exportBtn.addEventListener('click', () => {
            const data = getReportData();
            const rows = [['Date', 'Type', 'Participants', 'Household', 'Notes']];
            data.forEach(d => rows.push([d.date, d.type, d.participants, d.household, d.notes]));
            downloadCSV('ceremony-report.csv', rows);
        });
    })();

    // Inactive Members Report
    (function setupInactiveMembersReport() {
        const genBtn = document.getElementById('genInactiveReport');
        const exportBtn = document.getElementById('exportInactiveReport');
        const previewEl = document.getElementById('inactiveReportPreview');

        if (!genBtn || !exportBtn || !previewEl) return;

        function getReportData() {
            const households = read(DB_KEYS.households);
            return households
                .filter(h => h.status === 'inactive')
                .map(h => ({
                    name: h.head,
                    phone: h.phone || 'N/A',
                    address: h.address || 'N/A',
                    envelope: h.envelope || 'N/A'
                }));
        }

        genBtn.addEventListener('click', () => {
            const data = getReportData();
            if (data.length === 0) {
                previewEl.innerHTML = '<div class="text-gray-500">No inactive members found.</div>';
                return;
            }
            const tableRows = data.map(row => `
                <tr>
                    <td class="py-1 px-2 border-b border-slate-700">${row.name}</td>
                    <td class="py-1 px-2 border-b border-slate-700">${row.phone}</td>
                    <td class="py-1 px-2 border-b border-slate-700">${row.address}</td>
                    <td class="py-1 px-2 border-b border-slate-700">${row.envelope}</td>
                </tr>
            `).join('');
            previewEl.innerHTML = `<table class="w-full text-left text-xs"><thead><tr><th class="p-1">Name</th><th class="p-1">Phone</th><th class="p-1">Address</th><th class="p-1">Envelope</th></tr></thead><tbody>${tableRows}</tbody></table>`;
        });

        exportBtn.addEventListener('click', () => {
            const data = getReportData();
            const rows = [['Name', 'Phone', 'Address', 'Envelope ID']];
            data.forEach(d => rows.push([d.name, d.phone, d.address, d.envelope]));
            downloadCSV('inactive-members-report.csv', rows);
        });
    })();

    // Member Directory Report
    (function setupMemberDirectoryReport() {
        const previewEl = document.getElementById('memberDirectoryPreview');
        const searchInput = document.getElementById('memberDirectorySearch');
        const statusFilter = document.getElementById('memberDirectoryStatusFilter');
        const roleFilter = document.getElementById('memberDirectoryRoleFilter');
        const exportBtn = document.getElementById('exportMemberDirectory');

        if (!previewEl || !searchInput || !statusFilter || !roleFilter || !exportBtn) return;

        function getDirectoryData(filters) {
            const households = read(DB_KEYS.households);
            let allMembers = [];

            households.forEach(h => {
                // Add head of household
                allMembers.push({
                    name: h.head,
                    role: 'Head',
                    householdName: h.head,
                    status: h.status || 'active',
                    phone: h.phone || 'N/A'
                });
                // Add other members
                if (h.members && h.members.length > 0) {
                    h.members.forEach(m => {
                        allMembers.push({
                            name: m.name,
                            role: m.role,
                            householdName: h.head,
                            status: h.status || 'active',
                            phone: 'N/A' // Individual phone not stored, defaults to household
                        });
                    });
                }
            });

            // Apply filters
            if (filters.name) {
                const lowerName = filters.name.toLowerCase();
                allMembers = allMembers.filter(m => m.name.toLowerCase().includes(lowerName));
            }
            if (filters.status) {
                allMembers = allMembers.filter(m => m.status === filters.status);
            }
            if (filters.role) {
                allMembers = allMembers.filter(m => m.role === filters.role);
            }

            return allMembers.sort((a, b) => a.name.localeCompare(b.name));
        }

        function renderDirectory() {
            const filters = { name: searchInput.value, status: statusFilter.value, role: roleFilter.value };
            const data = getDirectoryData(filters);

            if (data.length === 0) {
                previewEl.innerHTML = '<div class="text-gray-500">No members match the current filters.</div>';
                return;
            }

            const tableRows = data.map(row => `<tr><td class="p-1 border-b border-slate-800">${row.name}</td><td class="p-1 border-b border-slate-800">${row.role}</td><td class="p-1 border-b border-slate-800">${row.householdName}</td><td class="p-1 border-b border-slate-800">${row.status}</td><td class="p-1 border-b border-slate-800">${row.phone}</td></tr>`).join('');
            previewEl.innerHTML = `<table class="w-full text-left text-xs"><thead><tr><th class="p-1">Name</th><th class="p-1">Role</th><th class="p-1">Household</th><th class="p-1">Status</th><th class="p-1">Phone</th></tr></thead><tbody>${tableRows}</tbody></table>`;
        }

        exportBtn.addEventListener('click', () => {
            const filters = { name: searchInput.value, status: statusFilter.value, role: roleFilter.value };
            const data = getDirectoryData(filters);
            const rows = [['Name', 'Role', 'Household', 'Status', 'Phone']];
            data.forEach(d => rows.push([d.name, d.role, d.householdName, d.status, d.phone]));
            downloadCSV('member-directory.csv', rows);
        });

        searchInput.addEventListener('input', renderDirectory);
        statusFilter.addEventListener('change', renderDirectory);
        roleFilter.addEventListener('change', renderDirectory);

        // Initial render
        renderDirectory();
    })();

    // Dashboard update helper
    function updateDashboardSummary(){
      try{
        const totalContrib = read(DB_KEYS.contributions).reduce((s,c)=>s+Number(c.regular||0)+Number(c.capital||0),0) + read(DB_KEYS.loose).reduce((s,l)=>s+Number(l.amount||0),0);
        const households = read(DB_KEYS.households).length;
        const upcoming = read(DB_KEYS.ceremonies).filter(c=>{ const d=new Date(c.date); return d > new Date(); }).length;
        const pledges = read(DB_KEYS.pledges);
        const pledgeProgress = pledges.length ? Math.round((1 - (pledges.reduce((s,p)=>s + (p.remaining||0),0) / pledges.reduce((s,p)=>s + (p.original||0),0))) * 100) : 0;
        document.getElementById('summary-contributions').textContent = '$' + totalContrib.toLocaleString();
        document.getElementById('summary-households').textContent = households;
        document.getElementById('summary-ceremonies').textContent = upcoming;
        document.getElementById('summary-pledges').textContent = pledgeProgress + '%';
        if (typeof renderEngagementWidget === 'function') renderEngagementWidget();
      } catch(e){/* ignore */}
    }
    updateDashboardSummary();

    // Activity Feed Search
    const activitySearchInput = document.getElementById('activitySearch');
    const clearActivitySearchBtn = document.getElementById('clearActivitySearch');
    if (activitySearchInput && clearActivitySearchBtn) {
        activitySearchInput.addEventListener('input', () => {
            const query = activitySearchInput.value;
            renderActivityFeed(query);
            // Show/hide the clear button
            clearActivitySearchBtn.classList.toggle('hidden', !query);
        });

        clearActivitySearchBtn.addEventListener('click', () => {
            activitySearchInput.value = '';
            renderActivityFeed('');
            clearActivitySearchBtn.classList.add('hidden');
            activitySearchInput.focus();
        });
    }

    // Recent Activity Feed
    function renderActivityFeed() {
        const feedEl = document.getElementById('recentActivityFeed');
        if (!feedEl) return;

        const households = read(DB_KEYS.households);
        const householdMap = new Map(households.map(h => [h.id, h.head]));

        const contributions = read(DB_KEYS.contributions).map(c => ({
            type: 'Contribution',
            date: new Date(c.date),
            text: `New contribution of <strong>$${((c.regular || 0) + (c.capital || 0)).toFixed(2)}</strong> for ${householdMap.get(c.householdId) || 'a household'}.`,
            icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-emerald-400"><path d="M12 1v22M17 5a3 3 0 00-6 0M7 19a4 4 0 018 0" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
        }));

        const ceremonies = read(DB_KEYS.ceremonies).map(c => ({
            type: 'Ceremony',
            date: new Date(c.date),
            text: `A <strong>${c.type}</strong> was scheduled for ${c.name || (c.personA + ' & ' + c.personB)}.`,
            icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-purple-400"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
        }));

        const allActivities = [...contributions, ...ceremonies]
            .sort((a, b) => b.date - a.date)
            .slice(0, 10); // Get the 10 most recent activities

        if (allActivities.length === 0) {
            feedEl.innerHTML = '<div class="text-gray-500">No recent activity to show.</div>';
            return;
        }

        feedEl.innerHTML = allActivities.map(act => `
            <div class="flex items-start gap-3 text-sm"><span class="mt-1">${act.icon}</span><div>${act.text}<div class="text-xs text-gray-400">${act.date.toLocaleDateString()}</div></div></div>
        `).join('');
    }

    // Recent Activity Feed with Filtering
    function renderActivityFeed(filter = '') {
        const feedEl = document.getElementById('recentActivityFeed');
        if (!feedEl) return;

        const households = read(DB_KEYS.households);
        const householdMap = new Map(households.map(h => [h.id, h.head]));

        const contributions = read(DB_KEYS.contributions).map(c => ({
            type: 'Contribution',
            date: new Date(c.date),
            text: `New contribution of <strong>$${((c.regular || 0) + (c.capital || 0)).toFixed(2)}</strong> for ${householdMap.get(c.householdId) || 'a household'}.`,
            icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-emerald-400"><path d="M12 1v22M17 5a3 3 0 00-6 0M7 19a4 4 0 018 0" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
        }));

        const ceremonies = read(DB_KEYS.ceremonies).map(c => ({
            type: 'Ceremony',
            date: new Date(c.date),
            text: `A <strong>${c.type}</strong> was scheduled for ${c.name || (c.personA + ' & ' + c.personB)}.`,
            icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-purple-400"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
        }));

        let allActivities = [...contributions, ...ceremonies]
            .sort((a, b) => b.date - a.date);

        // Apply filter if one is provided
        if (filter) {
            const lowerFilter = filter.toLowerCase();
            // A simple way to search is to strip HTML tags from the text content
            const stripHtml = (html) => {
                let doc = new DOMParser().parseFromString(html, 'text/html');
                return doc.body.textContent || "";
            }
            allActivities = allActivities.filter(act => 
                stripHtml(act.text).toLowerCase().includes(lowerFilter)
            );
        } else {
            // Only slice to the most recent 10 if there's no filter
            allActivities = allActivities.slice(0, 10);
        }

        // Helper to highlight text
        function highlightText(text, highlight) {
            if (!highlight) return text;
            const regex = new RegExp(`(${highlight})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        if (allActivities.length === 0) {
            feedEl.innerHTML = `<div class="text-gray-500">${filter ? 'No activities match your search.' : 'No recent activity to show.'}</div>`;
            return;
        }

        feedEl.innerHTML = allActivities.map(act => `
            <div class="flex items-start gap-3 text-sm"><span class="mt-1">${act.icon}</span><div>${
                filter ? highlightText(act.text, filter) : act.text
            }<div class="text-xs text-gray-400">${act.date.toLocaleDateString()}</div></div></div>
        `).join('');
    }

    // ----------------------
    // Engagement Score Logic
    // ----------------------
    function renderEngagementWidget() {
        const listEl = document.getElementById('engagementList');
        if (!listEl) return;

        const households = read(DB_KEYS.households);
        const contributions = read(DB_KEYS.contributions);
        const events = read(DB_KEYS.events);
        const ceremonies = read(DB_KEYS.ceremonies);

        const scores = households.map(h => {
            let score = 0;
            
            // 1. Giving Score (10 pts per contribution record)
            const householdContribs = contributions.filter(c => c.householdId === h.id);
            score += householdContribs.length * 10;
            
            // 2. Event Participation (5 pts per RSVP)
            const familyNames = [h.head, ...(h.members || []).map(m => m.name)];
            const normalizedFamily = familyNames.map(n => n.toLowerCase());
            
            events.forEach(e => {
                if (e.rsvps && e.rsvps.some(r => normalizedFamily.includes(r.toLowerCase()))) {
                    score += 5;
                }
            });

            // 3. Ceremonies (20 pts per involvement)
            ceremonies.forEach(c => {
                if (c.householdId === h.id) score += 20;
            });

            return { head: h.head, score, contribCount: householdContribs.length };
        });

        const topMembers = scores.sort((a, b) => b.score - a.score).slice(0, 5);

        if (topMembers.length === 0 || topMembers.every(m => m.score === 0)) {
            listEl.innerHTML = '<div class="text-gray-500 text-sm">No engagement activity recorded yet.</div>';
            return;
        }

        listEl.innerHTML = topMembers.map((m, i) => {
            const rankColor = i === 0 ? 'text-yellow-400' : i === 1 ? 'text-gray-300' : i === 2 ? 'text-orange-400' : 'text-slate-500';
            const borderColor = i === 0 ? 'border-yellow-500' : i === 1 ? 'border-gray-400' : i === 2 ? 'border-orange-500' : 'border-slate-700';
            return `
            <div class="flex items-center justify-between p-2 rounded-lg bg-slate-900/40 border-l-2 ${borderColor}">
                <div class="flex items-center gap-3">
                    <div class="font-bold text-sm w-4 text-center ${rankColor}">#${i+1}</div>
                    <div>
                        <div class="font-semibold text-sm text-white">${m.head}</div>
                        <div class="text-[10px] text-gray-500">${m.contribCount} gifts</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="font-bold text-sm text-purple-400">${m.score}</div>
                    <div class="text-[10px] text-gray-600">pts</div>
                </div>
            </div>
            `;
        }).join('');
    }

    function renderUpcomingCeremonies() {
        const listEl = document.getElementById('upcomingCeremoniesList');
        if (!listEl) return;

        const upcoming = read(DB_KEYS.ceremonies)
            .filter(c => new Date(c.date) >= new Date())
            .sort((a, b) => new Date(a.date) - new Date(b.date))
            .slice(0, 5); // Show the next 5

        if (upcoming.length === 0) {
            listEl.innerHTML = '<div class="text-gray-500">No upcoming ceremonies scheduled.</div>';
            return;
        }

        listEl.innerHTML = upcoming.map(c => {
            const ceremonyType = c.type.charAt(0).toUpperCase() + c.type.slice(1);
            const name = c.name || `${c.personA} & ${c.personB}`;
            return `
                <div class="flex justify-between items-center p-2 rounded-lg bg-slate-900/30">
                    <div>
                        <div class="font-semibold">${ceremonyType}: ${name}</div>
                    </div>
                    <div class="text-sm text-purple-300 font-semibold">${new Date(c.date).toLocaleDateString()}</div>
                </div>
            `;
        }).join('');
    }

    // WhatsApp button
    const openWhatsAppBtn = document.getElementById('openWhatsApp');
    if (openWhatsAppBtn) {
      openWhatsAppBtn.addEventListener('click', () => {
        window.open('https://web.whatsapp.com', '_blank');
      });
    }

    // Quick Actions wiring: navigate to relevant pages and perform helpful pre-fills / focus
    (function setupQuickActions(){
      const toContrib = document.getElementById('qaNewContribution');
      const toHouse = document.getElementById('qaAddHousehold');
      const toTax = document.getElementById('qaGenerateTax');
      const toCeremony = document.getElementById('qaRecordCeremony');

      function hideAllPages(){ document.querySelectorAll('#mainContent > section').forEach(s=>s.classList.add('hidden')); }

      if (toContrib) toContrib.addEventListener('click', ()=>{
        hideAllPages();
        const page = document.getElementById('page-contributions'); if (page) page.classList.remove('hidden');
        // pre-focus typical fields for quick entry
        const lookup = document.getElementById('contributionLookup'); if (lookup) { lookup.value = ''; lookup.focus(); }
      });

      if (toHouse) toHouse.addEventListener('click', ()=>{
        hideAllPages();
        const page = document.getElementById('page-households'); if (page) page.classList.remove('hidden');
        const env = document.getElementById('houseEnvelope'); if (env) env.value = genEnvelope();
        const head = document.getElementById('houseHead'); if (head) { head.value = ''; head.focus(); }
      });

      if (toTax) toTax.addEventListener('click', ()=>{
        hideAllPages();
        const page = document.getElementById('page-reports'); if (page) page.classList.remove('hidden');
        const yearSel = document.getElementById('taxYear'); if (yearSel){
          const y = String(new Date().getFullYear());
          // add option if missing
          if (![...yearSel.options].some(o=>o.value===y)){
            const opt = document.createElement('option'); opt.value = y; opt.text = y; yearSel.prepend(opt);
          }
          yearSel.value = y;
        }
      });

      if (toCeremony) toCeremony.addEventListener('click', ()=>{
        hideAllPages();
        const page = document.getElementById('page-ceremonies'); if (page) page.classList.remove('hidden');
        const b = document.getElementById('baptismName'); if (b) { b.value=''; b.focus(); }
      });
    })();

    // Data Export
    (function setupDataExport() {
        const exportBtn = document.getElementById('qaExportAllData');
        if (!exportBtn) return;

        exportBtn.addEventListener('click', () => {
            if (!confirm('This will export all application data into a single JSON file. Continue?')) return;

            const allData = {};
            for (const key in DB_KEYS) {
                allData[key] = read(DB_KEYS[key]);
            }

            const jsonString = JSON.stringify(allData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `abc-church-backup-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    })();

    // ----------------------
    // Back to Top Button
    // ----------------------
    (function setupBackToTop() {
        const backToTopBtn = document.getElementById('backToTopBtn');
        const scrollContainer = document.getElementById('mainContent');

        if (!backToTopBtn || !scrollContainer) return;

        // Show button when scrolling down
        scrollContainer.addEventListener('scroll', () => {
            if (scrollContainer.scrollTop > 300) {
                backToTopBtn.classList.remove('hidden');
            } else {
                backToTopBtn.classList.add('hidden');
            }
        });

        // Scroll to top on click
        backToTopBtn.addEventListener('click', () => {
            scrollContainer.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    })();

    // ----------------------
    // Prayer Request Logic
    // ----------------------
    (function setupPrayerRequests() {
        const DB_KEY = DB_KEYS.prayers;
        const listEl = document.getElementById('prayerRequestsList');
        const submitBtn = document.getElementById('submitPrayerRequest');
        const textInput = document.getElementById('prayerRequestText');
        const anonymousCheck = document.getElementById('prayerIsAnonymous');
        const confidentialCheck = document.getElementById('prayerIsConfidential');
        const categorySelect = document.getElementById('prayerCategory');
        const currentUser = localStorage.getItem('chat_username') || 'A member';
        let editingPrayerId = null;
 
        if (!listEl || !submitBtn || !textInput || !anonymousCheck || !confidentialCheck || !categorySelect) return;
 
        function simulateEmailNotification(prayer) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-6 bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-lg shadow-lg z-50 transition-opacity duration-500';
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <span class="text-2xl">ðŸ“§</span>
                    <div>
                        <h5 class="font-bold">New Prayer Notification</h5>
                        <p class="text-sm">A new '${prayer.category}' request was submitted by ${prayer.author}.</p>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);

            // Fade out and remove the notification after 5 seconds
            setTimeout(() => { notification.style.opacity = '0'; }, 4500);
            setTimeout(() => { notification.remove(); }, 5000);
        }

        function readPrayers() { return read(DB_KEY); }
        function writePrayers(data) { write(DB_KEY, data); }
        function readMyAnonIds() { try { return JSON.parse(localStorage.getItem('abc_my_anon_prayers') || '[]'); } catch(e) { return []; } }
        function writeMyAnonIds(ids) { localStorage.setItem('abc_my_anon_prayers', JSON.stringify(ids)); }
 
        function renderPrayerList() {
            const prayers = readPrayers().sort((a, b) => b.id - a.id); // Newest first
            const myAnonIds = readMyAnonIds();
            if (prayers.length === 0) {
                listEl.innerHTML = '<div class="text-xs text-gray-400">No prayer requests yet. Be the first to share.</div>';
                return;
            }
 
            listEl.innerHTML = prayers
                .filter(p => !p.isConfidential || p.author === currentUser) // Filter out confidential prayers unless you're the author
                .map(p => {
                const isAuthor = (p.author === currentUser && p.author !== 'Anonymous') || 
                                 (p.author === 'Anonymous' && myAnonIds.includes(p.id));
                const praiseButton = isAuthor && !p.praiseReport ? `<button data-prayer-id="${p.id}" class="add-praise-btn text-green-400 hover:text-green-300 text-xs font-semibold">Add Praise</button>` : '';
                const editButton = isAuthor ? `<button data-prayer-id="${p.id}" class="edit-prayer-btn text-blue-400 hover:text-blue-300 text-xs font-semibold">Edit</button>` : '';
                const deleteButton = isAuthor ? `<button data-prayer-id="${p.id}" class="delete-prayer-btn text-red-400 hover:text-red-300 text-xs font-semibold">Delete</button>` : '';
                
                const categoryColors = {
                    healing: 'bg-red-500/20 text-red-300',
                    guidance: 'bg-blue-500/20 text-blue-300',
                    thanksgiving: 'bg-green-500/20 text-green-300',
                    family: 'bg-yellow-500/20 text-yellow-300',
                    general: 'bg-slate-600/50 text-slate-300'
                };
                const categoryTag = p.category ? `<span class="text-xs ml-2 px-2 py-0.5 rounded-full ${categoryColors[p.category] || categoryColors.general}">${p.category}</span>` : '';
                const confidentialTag = p.isConfidential ? `<span class="text-xs ml-2 px-2 py-0.5 rounded-full bg-purple-500/30 text-purple-300">Confidential</span>` : '';
                const praiseReportHTML = p.praiseReport ? `
                    <div class="mt-3 p-2 rounded-lg bg-green-500/10 border-l-4 border-green-400">
                        <div class="flex justify-between items-center mb-1">
                            <p class="text-xs font-bold text-green-300">Praise Report:</p>
                            ${isAuthor ? `<button data-prayer-id="${p.id}" class="edit-praise-btn text-yellow-400 hover:text-yellow-300 text-xs font-semibold">Edit Praise</button>` : ''}
                        </div>
                        <p class="text-sm text-green-200 whitespace-pre-wrap">${p.praiseReport}</p>
                    </div>
                ` : '';

                return `
                <div class="p-2 rounded-lg bg-slate-800/50 text-sm">
                    <p class="text-gray-200">${p.text}</p>
                    ${praiseReportHTML}
                    <div class="flex justify-between items-center mt-2">
                        <div class="flex items-center">
                            <div class="text-xs text-purple-300">- ${p.author}</div>
                            ${categoryTag}
                            ${confidentialTag}
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-xs text-gray-400">${p.prayCount || 0} prayers</span>
                            <button data-prayer-id="${p.id}" class="pray-btn px-2 py-1 rounded-md bg-slate-700 hover:bg-slate-600 text-xs font-semibold">I prayed for this ðŸ™</button>
                            ${praiseButton}
                            ${editButton}
                            ${deleteButton}
                        </div>
                    </div>
                </div>
            `}).join('');
        }
 
        submitBtn.addEventListener('click', () => {
            const text = textInput.value.trim();
            if (!text) {
                alert('Please enter a prayer request.');
                return;
            }
 
            const category = categorySelect.value;
            const isConfidential = confidentialCheck.checked;
            const isEditing = !!editingPrayerId;
            const confirmationMessage = isEditing
                ? 'Are you sure you want to update this prayer request?'
                : `You are about to submit the following prayer ${anonymousCheck.checked ? 'anonymously' : `as "${currentUser}"`}:\n\n"${text}"\n\nDo you want to continue?`;

            if (!confirm(confirmationMessage)) {
                return; // User cancelled the action
            }

            let prayers = readPrayers();

            if (isEditing) {
                // We are updating an existing prayer
                const prayerToUpdate = prayers.find(p => p.id === editingPrayerId);
                if (prayerToUpdate) {
                    prayerToUpdate.text = text;
                    prayerToUpdate.category = category;
                    prayerToUpdate.isConfidential = isConfidential;
                }
                editingPrayerId = null;
                submitBtn.textContent = 'Submit';
            } else {
                // We are creating a new prayer
                const newPrayer = {
                    id: Date.now(),
                    text: text,
                    author: anonymousCheck.checked ? 'Anonymous' : currentUser,
                    prayCount: 0,
                    category: category,
                    isConfidential: isConfidential,
                    praiseReport: null // New field for praise reports
                };
                prayers.push(newPrayer);
                if (anonymousCheck.checked) {
                    const myIds = readMyAnonIds();
                    myIds.push(newPrayer.id);
                    writeMyAnonIds(myIds);
                }
                if (!newPrayer.isConfidential) simulateEmailNotification(newPrayer); // Trigger notification
            }

            writePrayers(prayers); // Save changes
            textInput.value = '';
            anonymousCheck.checked = false;
            confidentialCheck.checked = false;
            categorySelect.value = 'general';
            renderPrayerList();
        });
 
        // Event delegation for "I prayed for this" buttons
        listEl.addEventListener('click', (e) => {
            if (e.target.classList.contains('pray-btn')) {
                const prayerId = parseInt(e.target.getAttribute('data-prayer-id'), 10);
                if (!prayerId) return;
 
                const prayers = readPrayers();
                const prayerToUpdate = prayers.find(p => p.id === prayerId);
 
                if (prayerToUpdate) {
                    prayerToUpdate.prayCount = (prayerToUpdate.prayCount || 0) + 1;
                    writePrayers(prayers);
                    renderPrayerList(); // Re-render to show the updated count
                }
            } else if (e.target.classList.contains('delete-prayer-btn')) {
                const prayerId = parseInt(e.target.getAttribute('data-prayer-id'), 10);
                if (!prayerId) return;

                if (confirm('Are you sure you want to delete this prayer request?')) {
                    let prayers = readPrayers();
                    const prayerToDelete = prayers.find(p => p.id === prayerId);
                    prayers = prayers.filter(p => p.id !== prayerId);
                    writePrayers(prayers);
                    // If the deleted prayer was anonymous, remove it from our tracking list
                    if (prayerToDelete && prayerToDelete.author === 'Anonymous') {
                        const myIds = readMyAnonIds().filter(id => id !== prayerId);
                        writeMyAnonIds(myIds);
                    }
                    renderPrayerList();
                }
            } else if (e.target.classList.contains('edit-prayer-btn')) {
                const prayerId = parseInt(e.target.getAttribute('data-prayer-id'), 10);
                const prayerToEdit = readPrayers().find(p => p.id === prayerId);
                if (prayerToEdit) {
                    textInput.value = prayerToEdit.text;
                    textInput.focus();
                    categorySelect.value = prayerToEdit.category || 'general';
                    anonymousCheck.checked = prayerToEdit.author === 'Anonymous';
                    confidentialCheck.checked = prayerToEdit.isConfidential || false;
                    editingPrayerId = prayerId;
                    submitBtn.textContent = 'Update';
                }
            } else if (e.target.classList.contains('add-praise-btn')) {
                const prayerId = parseInt(e.target.getAttribute('data-prayer-id'), 10);
                const praiseText = prompt('Share your praise report or an update for this prayer:');

                if (praiseText && praiseText.trim() !== '') {
                    const prayers = readPrayers();
                    const prayerToUpdate = prayers.find(p => p.id === prayerId);
                    if (prayerToUpdate) {
                        prayerToUpdate.praiseReport = praiseText.trim();
                        writePrayers(prayers);
                        renderPrayerList();
                    }
                }
            } else if (e.target.classList.contains('edit-praise-btn')) {
                const prayerId = parseInt(e.target.getAttribute('data-prayer-id'), 10);
                const prayers = readPrayers();
                const prayerToUpdate = prayers.find(p => p.id === prayerId);

                if (prayerToUpdate) {
                    const newPraiseText = prompt('Please edit your praise report:', prayerToUpdate.praiseReport);
                    if (newPraiseText && newPraiseText.trim() !== '') {
                        prayerToUpdate.praiseReport = newPraiseText.trim();
                        writePrayers(prayers);
                        renderPrayerList();
                    }
                }
            }
        });
 
        // Initial render
        renderPrayerList();
    })();

    // Initial render for new components
    renderActivityFeed();
    renderUpcomingCeremonies();

    // ----------------------
    // Attendance Logic
    // ----------------------
    (function setupAttendance() {
        const DB_KEY = DB_KEYS.attendance;
        const listEl = document.getElementById('attendanceList');
        const submitBtn = document.getElementById('attendanceSubmit');
        const cancelBtn = document.getElementById('cancelEditAttendance');
        const exportBtn = document.getElementById('exportAttendance');
        const chartFilter = document.getElementById('attendanceChartFilter');

        const idField = document.getElementById('attendanceId');
        const dateField = document.getElementById('attendanceDate');
        const eventField = document.getElementById('attendanceEvent');
        const countField = document.getElementById('attendanceCount');
        const notesField = document.getElementById('attendanceNotes');

        let attendanceChartInstance = null;

        function readAttendance() { return read(DB_KEY); }
        function writeAttendance(data) { write(DB_KEY, data); }

        function resetForm() {
            idField.value = '';
            dateField.value = new Date().toISOString().slice(0, 10);
            eventField.value = 'sunday_service';
            countField.value = '';
            notesField.value = '';
            submitBtn.textContent = 'Log Attendance';
            cancelBtn.classList.add('hidden');
        }

        function renderList() {
            if (!listEl) return;
            const records = readAttendance().sort((a, b) => new Date(b.date) - new Date(a.date));
            if (records.length === 0) {
                listEl.innerHTML = '<div class="text-gray-400">No attendance logged yet.</div>';
                return;
            }
            listEl.innerHTML = records.map(rec => `
                <div class="py-2 border-b border-slate-800">
                    <div class="flex justify-between items-start">
                        <div>
                            <strong class="text-purple-300">${rec.event.replace(/_/g, ' ')}</strong> on ${new Date(rec.date).toLocaleDateString()}
                            <div class="text-lg">${rec.count} Attendees</div>
                            ${rec.notes ? `<div class="text-xs text-gray-400 mt-1 pl-2 border-l-2 border-slate-700">Note: ${rec.notes}</div>` : ''}
                        </div>
                        <div class="flex-shrink-0 ml-2">
                            <button data-id="${rec.id}" class="edit-attendance-btn text-blue-400 hover:text-blue-300 text-xs px-2 py-1 rounded">Edit</button>
                            <button data-id="${rec.id}" class="delete-attendance-btn text-red-500 hover:text-red-400 text-xs px-2 py-1 rounded">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderChart(eventFilter = 'all') {
            const records = readAttendance().sort((a, b) => new Date(a.date) - new Date(b.date));
            let filteredRecords = records;
            if (eventFilter !== 'all') {
                filteredRecords = records.filter(r => r.event === eventFilter);
            }

            const data = {
                labels: filteredRecords.map(r => new Date(r.date).toLocaleDateString()),
                datasets: [{
                    label: 'Headcount',
                    data: filteredRecords.map(r => r.count),
                    borderColor: 'rgba(139, 92, 246, 1)',
                    backgroundColor: 'rgba(139, 92, 246, 0.2)',
                    fill: true,
                    tension: 0.3
                }]
            };

            const ctx = document.getElementById('attendanceChart')?.getContext('2d');
            if (!ctx) return;

            if (attendanceChartInstance) attendanceChartInstance.destroy();
            attendanceChartInstance = new Chart(ctx, {
                type: 'line',
                data: data,
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        submitBtn.addEventListener('click', () => {
            const record = {
                id: idField.value ? parseInt(idField.value, 10) : Date.now(),
                date: dateField.value,
                event: eventField.value,
                count: parseInt(countField.value, 10),
                notes: notesField.value.trim()
            };

            if (!record.date || !record.event || isNaN(record.count)) {
                alert('Please fill in date, event, and a valid headcount.');
                return;
            }

            let records = readAttendance();
            const existingIndex = records.findIndex(r => r.id === record.id);

            if (existingIndex > -1) records[existingIndex] = record; // Update
            else records.push(record); // Add new

            writeAttendance(records);
            resetForm();
            renderList();
            renderChart(chartFilter.value);
        });

        listEl.addEventListener('click', (e) => {
            const id = parseInt(e.target.getAttribute('data-id'), 10);
            if (e.target.classList.contains('delete-attendance-btn')) {
                if (confirm('Are you sure you want to delete this attendance record?')) {
                    writeAttendance(readAttendance().filter(r => r.id !== id));
                    renderList();
                    renderChart(chartFilter.value);
                }
            } else if (e.target.classList.contains('edit-attendance-btn')) {
                const record = readAttendance().find(r => r.id === id);
                if (record) {
                    idField.value = record.id;
                    dateField.value = record.date;
                    eventField.value = record.event;
                    countField.value = record.count;
                    notesField.value = record.notes || '';
                    submitBtn.textContent = 'Update Record';
                    cancelBtn.classList.remove('hidden');
                    window.scrollTo(0, document.getElementById('page-attendance').offsetTop);
                }
            }
        });

        cancelBtn.addEventListener('click', resetForm);

        exportBtn.addEventListener('click', () => {
            const records = readAttendance();
            const rows = [['ID', 'Date', 'Event', 'Headcount', 'Notes']];
            records.forEach(r => rows.push([r.id, r.date, r.event, r.count, r.notes || '']));
            downloadCSV('attendance-report.csv', rows);
        });

        chartFilter.addEventListener('change', () => renderChart(chartFilter.value));

        // Initial setup
        resetForm();
        renderList();
        renderChart();
    })();

    // ----------------------
    // Events Logic
    // ----------------------
    (function setupEvents() {
        const DB_KEY = DB_KEYS.events;
        const listEl = document.getElementById('eventsList');
        const submitBtn = document.getElementById('eventSubmit');
        const cancelBtn = document.getElementById('cancelEditEvent');
        const formTitle = document.getElementById('eventFormTitle');

        const idField = document.getElementById('eventId');
        const titleSelect = document.getElementById('eventTitleSelect');
        const titleOtherField = document.getElementById('eventTitleOther');
        const dateField = document.getElementById('eventDate');
        const locationField = document.getElementById('eventLocation');
        const descriptionField = document.getElementById('eventDescription');
        const mandatoryField = document.getElementById('eventIsMandatory');
        const mandatoryFilter = document.getElementById('filterMandatoryEvents');
        const searchField = document.getElementById('eventSearch');
        const currentUser = localStorage.getItem('chat_username') || 'A member';

        if (!listEl || !submitBtn) return;

        function readEvents() { return read(DB_KEY); }
        function writeEvents(data) { write(DB_KEY, data); }

        function resetForm() {
            idField.value = '';
            titleSelect.value = 'Sunday Service';
            titleOtherField.value = '';
            titleOtherField.classList.add('hidden');
            dateField.value = '';
            locationField.value = '';
            descriptionField.value = '';
            mandatoryField.checked = false;
            formTitle.textContent = 'Create New Event';
            submitBtn.textContent = 'Create Event';
            cancelBtn.classList.add('hidden');
        }

        titleSelect.addEventListener('change', () => {
            const isOther = titleSelect.value === 'other';
            titleOtherField.classList.toggle('hidden', !isOther);
        });

        function renderList() {
            let events = readEvents().sort((a, b) => new Date(b.date) - new Date(a.date));
            const filter = searchField.value;

            if (filter) {
                const lowerFilter = filter.toLowerCase();
                events = events.filter(event =>
                    event.title.toLowerCase().includes(lowerFilter) ||
                    event.location.toLowerCase().includes(lowerFilter) ||
                    event.description.toLowerCase().includes(lowerFilter)
                );
            }

            if (mandatoryFilter.checked) {
                events = events.filter(event => event.isMandatory);
            }

            if (events.length === 0) {
                let message = 'No events have been created yet.';
                if (filter || mandatoryFilter.checked) message = 'No events match your search criteria.';
                listEl.innerHTML = `<div class="text-gray-400">${message}</div>`;
                return;
            }

            listEl.innerHTML = events.map(event => {
                const eventDate = new Date(event.date);
                const isPast = eventDate < new Date();
                const mandatoryTag = event.isMandatory ? `<span class="text-xs ml-2 px-2 py-0.5 rounded-full bg-yellow-500/30 text-yellow-300">Mandatory</span>` : '';
                const rsvps = event.rsvps || [];
                const userHasRsvpd = rsvps.includes(currentUser);

                return `
                <div class="p-3 rounded-lg bg-slate-800/50 border-l-4 ${isPast ? 'border-slate-600' : 'border-purple-500'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center">
                                <strong class="text-white">${event.title}</strong>
                                ${mandatoryTag}
                            </div>
                            <div class="text-xs text-purple-300">${eventDate.toLocaleString()} at ${event.location}</div>
                            <p class="text-xs text-gray-300 mt-1 whitespace-pre-wrap">${event.description}</p>
                        </div>
                        <div class="flex-shrink-0 ml-2">
                            <button data-id="${event.id}" class="edit-event-btn text-blue-400 hover:text-blue-300 text-xs px-2 py-1 rounded">Edit</button>
                            <button data-id="${event.id}" class="delete-event-btn text-red-500 hover:text-red-400 text-xs px-2 py-1 rounded">Delete</button>
                            <button data-id="${event.id}" class="share-event-btn text-purple-400 hover:text-purple-300 text-xs px-2 py-1 rounded">Share</button>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-slate-700/50 flex items-center justify-between">
                        <div>
                            <div class="text-xs font-semibold text-gray-300">${rsvps.length} Going</div>
                            <div class="text-xs text-gray-400">${rsvps.slice(0, 5).join(', ')}${rsvps.length > 5 ? '...' : ''}</div>
                        </div>
                        <div class="flex-shrink-0">
                            <button data-id="${event.id}" class="rsvp-event-btn px-3 py-1 rounded-lg text-sm ${userHasRsvpd ? 'bg-green-600' : 'bg-slate-600 hover:bg-slate-500'}">
                                ${userHasRsvpd ? 'âœ” Going' : 'RSVP'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        submitBtn.addEventListener('click', () => {
            const selectedTitle = titleSelect.value;
            const finalTitle = selectedTitle === 'other' ? titleOtherField.value.trim() : selectedTitle;

            const event = {
                id: idField.value ? parseInt(idField.value, 10) : Date.now(),
                title: finalTitle,
                date: dateField.value,
                location: locationField.value.trim(),
                description: descriptionField.value.trim(),
                isMandatory: mandatoryField.checked,
                rsvps: idField.value ? (readEvents().find(e => e.id === parseInt(idField.value, 10))?.rsvps || []) : [] // Preserve RSVPs on edit
            };

            if (!finalTitle || !event.date || !event.location) {
                alert('Please provide a title, date, and location for the event.');
                return;
            }

            let events = readEvents();
            const existingIndex = events.findIndex(e => e.id === event.id);

            if (existingIndex > -1) events[existingIndex] = event; // Update
            else events.push(event); // Add new

            writeEvents(events);
            resetForm();
            renderList();
        });

        listEl.addEventListener('click', (e) => {
            const id = parseInt(e.target.getAttribute('data-id'), 10);
            if (e.target.classList.contains('delete-event-btn')) {
                if (confirm('Are you sure you want to delete this event?')) {
                    writeEvents(readEvents().filter(event => event.id !== id));
                    renderList();
                }
            } else if (e.target.classList.contains('edit-event-btn')) {
                const event = readEvents().find(e => e.id === id);
                if (event) {
                    idField.value = event.id;
                    
                    // Check if the saved title is one of the standard options
                    const isStandardOption = [...titleSelect.options].some(opt => opt.value === event.title);
                    if (isStandardOption) {
                        titleSelect.value = event.title;
                        titleOtherField.classList.add('hidden');
                    } else {
                        titleSelect.value = 'other';
                        titleOtherField.value = event.title;
                        titleOtherField.classList.remove('hidden');
                    }

                    dateField.value = event.date;
                    locationField.value = event.location;
                    descriptionField.value = event.description;
                    mandatoryField.checked = event.isMandatory || false;
                    formTitle.textContent = 'Edit Event';
                    submitBtn.textContent = 'Update Event';
                    cancelBtn.classList.remove('hidden');
                    window.scrollTo(0, document.getElementById('page-events').offsetTop);
                }
            } else if (e.target.classList.contains('rsvp-event-btn')) {
                const events = readEvents();
                const event = events.find(ev => ev.id === id);
                if (event) {
                    event.rsvps = event.rsvps || [];
                    const userIndex = event.rsvps.indexOf(currentUser);
                    if (userIndex > -1) event.rsvps.splice(userIndex, 1); // Remove RSVP
                    else event.rsvps.push(currentUser); // Add RSVP

                    writeEvents(events);
                    renderList();
                }
            } else if (e.target.classList.contains('share-event-btn')) {
                const eventToShare = readEvents().find(ev => ev.id === id);
                if (eventToShare) {
                    // This function is defined in the chatroom script block
                    if (typeof shareEventToChat === 'function') shareEventToChat(eventToShare);
                    else alert('Could not access chat functionality.');
                }
            }
        });

        cancelBtn.addEventListener('click', resetForm);

        // Add event listener for the search bar
        searchField.addEventListener('input', renderList);
        mandatoryFilter.addEventListener('change', renderList);

        // Initial render
        renderList();
    })();

    // ----------------------
    // Finances (Loans) Logic
    // ----------------------
    (function setupFinances() {
        const DB_KEY = DB_KEYS.loans;
        const listEl = document.getElementById('loansList');
        const loanSubmitBtn = document.getElementById('loanSubmit');
        const repaymentSubmitBtn = document.getElementById('repaymentSubmit');

        // Form fields
        const householdSelect = document.getElementById('loanHousehold');
        const principalField = document.getElementById('loanPrincipal');
        const rateField = document.getElementById('loanInterestRate');
        const dateField = document.getElementById('loanDate');
        const repaymentLoanSelect = document.getElementById('repaymentLoanSelect');
        const repaymentAmountField = document.getElementById('repaymentAmount');
        const repaymentDateField = document.getElementById('repaymentDate');
        const modal = document.getElementById('repaymentHistoryModal');
        const modalTitle = document.getElementById('repaymentModalTitle');
        const modalContent = document.getElementById('repaymentHistoryContent');
        const closeModalBtn = document.getElementById('closeRepaymentModal');

        if (!listEl) return;

        function readLoans() { return read(DB_KEY); }
        function writeLoans(data) { write(DB_KEY, data); }

        function populateDropdowns() {
            const households = read(DB_KEYS.households).sort((a, b) => a.head.localeCompare(b.head));
            householdSelect.innerHTML = '<option value="">Select Household to Loan...</option>';
            households.forEach(h => householdSelect.innerHTML += `<option value="${h.id}">${h.head}</option>`);

            const loans = readLoans();
            const householdMap = new Map(households.map(h => [h.id, h.head]));
            repaymentLoanSelect.innerHTML = '<option value="">Select Loan to Repay...</option>';
            loans.filter(l => l.balance > 0).forEach(l => {
                repaymentLoanSelect.innerHTML += `<option value="${l.id}">Loan to ${householdMap.get(l.householdId)} ($${l.balance.toFixed(2)})</option>`;
            });
        }

        function renderList() {
            const loans = readLoans().sort((a, b) => new Date(b.date) - new Date(a.date));
            const households = read(DB_KEYS.households);
            const householdMap = new Map(households.map(h => [h.id, h.head]));

            if (loans.length === 0) {
                listEl.innerHTML = '<div class="text-gray-400">No loans have been issued.</div>';
                return;
            }

            listEl.innerHTML = loans.map(loan => {
                const totalInterestPaid = (loan.repayments || []).reduce((sum, p) => sum + p.interestPaid, 0);
                return `
                <div class="p-3 rounded-lg bg-slate-800/50 border-l-4 ${loan.balance <= 0 ? 'border-green-500' : 'border-yellow-500'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <strong class="text-white">Loan to ${householdMap.get(loan.householdId) || 'N/A'}</strong>
                            <div class="text-xs text-purple-300">Issued: ${new Date(loan.date).toLocaleDateString()} at ${loan.rate}% APR</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg ${loan.balance <= 0 ? 'text-green-400' : 'text-yellow-400'}">$${loan.balance.toFixed(2)}</div>
                            <div class="text-xs text-gray-400">Remaining Balance</div>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-400">
                        Original: $${loan.principal.toFixed(2)} | Interest Paid: $${totalInterestPaid.toFixed(2)}
                    </div>
                    <div class="mt-2 text-right">
                        <button data-id="${loan.id}" class="view-history-btn text-purple-300 hover:underline text-xs font-semibold">View History</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        loanSubmitBtn.addEventListener('click', () => {
            const loan = {
                id: Date.now(),
                householdId: parseInt(householdSelect.value, 10),
                principal: parseFloat(principalField.value),
                rate: parseFloat(rateField.value),
                date: dateField.value,
                balance: parseFloat(principalField.value),
                repayments: []
            };

            if (!loan.householdId || isNaN(loan.principal) || isNaN(loan.rate) || !loan.date) {
                alert('Please fill out all fields for the new loan.');
                return;
            }

            const loans = readLoans();
            loans.push(loan);
            writeLoans(loans);
            
            principalField.value = rateField.value = dateField.value = '';
            renderList();
            populateDropdowns();
        });

        repaymentSubmitBtn.addEventListener('click', () => {
            const loanId = parseInt(repaymentLoanSelect.value, 10);
            const paymentAmount = parseFloat(repaymentAmountField.value);
            const paymentDate = repaymentDateField.value;

            if (!loanId || isNaN(paymentAmount) || !paymentDate) {
                alert('Please select a loan and enter a payment amount and date.');
                return;
            }

            const loans = readLoans();
            const loan = loans.find(l => l.id === loanId);
            if (!loan) return;

            const monthlyInterest = (loan.balance * (loan.rate / 100)) / 12;
            const principalPaid = Math.min(loan.balance, paymentAmount - monthlyInterest);
            const interestPaid = paymentAmount - principalPaid;

            loan.balance -= principalPaid;
            loan.repayments.push({ date: paymentDate, amount: paymentAmount, principalPaid, interestPaid });

            writeLoans(loans);
            repaymentAmountField.value = repaymentDateField.value = '';
            renderList();
            populateDropdowns();
        });

        listEl.addEventListener('click', (e) => {
            if (e.target.classList.contains('view-history-btn')) {
                const loanId = parseInt(e.target.getAttribute('data-id'), 10);
                const loan = readLoans().find(l => l.id === loanId);
                const household = read(DB_KEYS.households).find(h => h.id === loan.householdId);

                if (loan) {
                    modalTitle.textContent = `History for Loan to ${household ? household.head : 'N/A'}`;
                    if (!loan.repayments || loan.repayments.length === 0) {
                        modalContent.innerHTML = '<div class="text-gray-400">No repayments have been recorded for this loan.</div>';
                    } else {
                        const historyRows = loan.repayments.map(p => `
                            <tr>
                                <td class="py-1 px-2 border-b border-slate-700">${new Date(p.date).toLocaleDateString()}</td>
                                <td class="py-1 px-2 border-b border-slate-700 text-right text-emerald-400">$${p.amount.toFixed(2)}</td>
                                <td class="py-1 px-2 border-b border-slate-700 text-right">$${p.principalPaid.toFixed(2)}</td>
                                <td class="py-1 px-2 border-b border-slate-700 text-right">$${p.interestPaid.toFixed(2)}</td>
                            </tr>
                        `).join('');

                        modalContent.innerHTML = `
                            <table class="w-full text-left text-xs">
                                <thead><tr><th class="p-1">Date</th><th class="p-1 text-right">Total Paid</th><th class="p-1 text-right">To Principal</th><th class="p-1 text-right">To Interest</th></tr></thead>
                                <tbody>${historyRows}</tbody>
                            </table>
                        `;
                    }
                    modal.classList.remove('hidden');
                }
            }
        });

        closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });

        // Initial setup
        renderList();
        populateDropdowns();
        // Re-populate when households change
        document.getElementById('houseCreate').addEventListener('click', populateDropdowns);
    })();

    // Animate summary cards on view
    (function setupSummaryCardAnimation() {
        const cards = document.querySelectorAll('.summary-card');
        if (!cards.length) return;

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.remove('opacity-0');
                    entry.target.classList.add('animate-fade');
                    observer.unobserve(entry.target); // Animate only once
                }
            });
        }, {
            threshold: 0.1 // Trigger when 10% of the card is visible
        });

        cards.forEach(card => {
            observer.observe(card);
        });
    })();
    // Auth page particle animation
    (function setupAuthParticles() {
        const canvas = document.getElementById('authParticles');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');

        let particles = [];
        const particleCount = 70;

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.vx = Math.random() * 0.4 - 0.2; // Slower horizontal speed
                this.vy = Math.random() * 0.6 - 0.3; // Slower vertical speed
                this.radius = Math.random() * 1.5 + 0.5;
                this.alpha = Math.random() * 0.5 + 0.2;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;

                if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`;
                ctx.fill();
            }
        }

        function init() {
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle());
            }
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                p.update();
                p.draw();
            });
            requestAnimationFrame(animate);
        }

        init();
        animate();
    })();
  </script>
</body>
</html>
</html>
  </script>
</body>
</html>
</html>
</html>
</html>
           
</html>
  </script>
</body>
</html>
</html>
</html>
</html>
           

